# TaKeKe æ•°æ®å±‚æ¥å£ä½¿ç”¨æ‰‹å†Œ

## ğŸ“– æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æ˜¯ TaKeKe é¡¹ç›®æ•°æ®å±‚çš„å®Œæ•´æ¥å£ä½¿ç”¨æŒ‡å—ï¼Œé¢å‘æ‰€æœ‰æœåŠ¡å±‚å¼€å‘è€…ã€‚é€šè¿‡æœ¬æ‰‹å†Œï¼Œæ‚¨å¯ä»¥ï¼š
- æ— éœ€é˜…è¯»æ•°æ®å±‚æºç ï¼Œç›´æ¥ä½¿ç”¨æ‰€æœ‰æ•°æ®æ¥å£
- äº†è§£æ¯ä¸ªæ¥å£çš„å‚æ•°ã€è¿”å›å€¼å’Œä½¿ç”¨ç¤ºä¾‹
- æŒæ¡å¼‚å¸¸å¤„ç†å’Œæœ€ä½³å®è·µ
- å®‰å…¨ã€é«˜æ•ˆåœ°è¿›è¡Œæ•°æ®æ“ä½œ

## ğŸ—ï¸ æ•°æ®å±‚æ¶æ„æ¦‚è§ˆ

### å±‚æ¬¡ç»“æ„
```
æœåŠ¡å±‚ (Service Layer)
    â†“ è°ƒç”¨
æ•°æ®è®¿é—®å±‚ (Repository Layer)
    â†“ æ“ä½œ
æ•°æ®æ¨¡å‹å±‚ (Model Layer)
    â†“ å­˜å‚¨
æ•°æ®åº“ (Database)
```

### æ ¸å¿ƒç»„ä»¶
- **æ¨¡å‹å±‚**: å®šä¹‰æ•°æ®ç»“æ„å’Œä¸šåŠ¡è§„åˆ™
- **Repositoryå±‚**: æä¾›æ•°æ®è®¿é—®æ¥å£ï¼Œå°è£…ä¸šåŠ¡é€»è¾‘
- **å¼‚å¸¸å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶

## ğŸ”§ å¿«é€Ÿå¼€å§‹

### 1. å¯¼å…¥æ‰€éœ€æ¨¡å—

```python
# å¯¼å…¥Repositoryç±»
from src.repositories import (
    UserRepository,
    TaskRepository,
    FocusRepository,
    RewardRepository
)

# å¯¼å…¥æ¨¡å‹å’Œæšä¸¾
from src.models import (
    User, Task, FocusSession, Reward,
    TaskStatus, PriorityLevel, SessionType,
    RewardType, TransactionType
)

# å¯¼å…¥å¼‚å¸¸ç±»
from src.repositories.base import (
    RepositoryError,
    RepositoryValidationError,
    RepositoryNotFoundError
)
```

### 2. è·å–æ•°æ®åº“ä¼šè¯

```python
from src.database.connection import DatabaseConnection

# è·å–æ•°æ®åº“è¿æ¥
db_connection = DatabaseConnection()

# ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç¡®ä¿ä¼šè¯æ­£ç¡®å…³é—­
with db_connection.get_session() as session:
    # åœ¨è¿™é‡Œä½¿ç”¨Repository
    pass
```

### 3. åˆ›å»ºRepositoryå®ä¾‹

```python
with db_connection.get_session() as session:
    user_repo = UserRepository(session)
    task_repo = TaskRepository(session)
    focus_repo = FocusRepository(session)
    reward_repo = RewardRepository(session)

    # å¼€å§‹ä½¿ç”¨æ•°æ®æ¥å£
    # ...
```

## ğŸ‘¤ ç”¨æˆ·ç³»ç»Ÿæ¥å£

### UserRepository - ç”¨æˆ·æ•°æ®è®¿é—®

#### åˆ›å»ºç”¨æˆ·

```python
# åˆ›å»ºæ³¨å†Œç”¨æˆ·
user_data = {
    "email": "user@example.com",
    "nickname": "å¼ ä¸‰",
    "password_hash": "hashed_password_here",
    "user_type": "registered"  # æˆ– "guest"
}

user = user_repo.create(user_data)
print(f"ç”¨æˆ·åˆ›å»ºæˆåŠŸ: {user.id}")
```

#### æŸ¥è¯¢ç”¨æˆ·

```python
# æ ¹æ®é‚®ç®±æŸ¥è¯¢ç”¨æˆ·ï¼ˆç”¨æˆ·é‚®ç®±å¿…é¡»å”¯ä¸€ï¼‰
try:
    user = user_repo.find_by_email("user@example.com")
    print(f"æ‰¾åˆ°ç”¨æˆ·: {user.nickname}")
except RepositoryNotFoundError:
    print("ç”¨æˆ·ä¸å­˜åœ¨")

# æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·
user = user_repo.find_by_phone("13800138000")

# æ ¹æ®å¾®ä¿¡OpenIDæŸ¥è¯¢ç”¨æˆ·
user = user_repo.find_by_wechat_openid("wx_openid_123")

# æŸ¥è¯¢æ‰€æœ‰æ³¨å†Œç”¨æˆ·
registered_users = user_repo.find_registered_users(is_active=True)

# æŸ¥è¯¢æ‰€æœ‰æ¸¸å®¢ç”¨æˆ·
guest_users = user_repo.find_guest_users()

# æŸ¥è¯¢æ´»è·ƒç”¨æˆ·
active_users = user_repo.find_active_users()
```

#### ç”¨æˆ·éªŒè¯

```python
# æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
if user_repo.email_exists("new@example.com"):
    print("é‚®ç®±å·²è¢«ä½¿ç”¨")

# æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ¨
if user_repo.phone_exists("13900139000"):
    print("æ‰‹æœºå·å·²è¢«ä½¿ç”¨")
```

#### ç”¨æˆ·ç®¡ç†

```python
# åˆ›å»ºæ¸¸å®¢ç”¨æˆ·
guest_user = user_repo.create_guest_user(nickname="ä¸´æ—¶ç”¨æˆ·")

# å‡çº§æ¸¸å®¢ä¸ºæ³¨å†Œç”¨æˆ·
updated_user = user_repo.upgrade_guest_to_registered(
    user_id=guest_user.id,
    email="registered@example.com",
    password_hash="new_hashed_password",
    nickname="æ­£å¼ç”¨æˆ·"
)
```

#### åŸºç¡€CRUDæ“ä½œ

```python
# æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·
user = user_repo.get_by_id("user_id_here")

# æ›´æ–°ç”¨æˆ·ä¿¡æ¯
updated_user = user_repo.update(
    user_id,
    {"nickname": "æ–°æ˜µç§°", "is_active": True}
)

# åˆ é™¤ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼‰
success = user_repo.delete(user_id)

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
exists = user_repo.exists(email="user@example.com")

# ç»Ÿè®¡ç”¨æˆ·æ•°é‡
count = user_repo.count(user_type="registered")
```

## ğŸ“‹ ä»»åŠ¡ç³»ç»Ÿæ¥å£

### TaskRepository - ä»»åŠ¡æ•°æ®è®¿é—®

#### åˆ›å»ºä»»åŠ¡

```python
# åˆ›å»ºåŸºç¡€ä»»åŠ¡
task_data = {
    "user_id": "user_id_here",
    "title": "å®Œæˆé¡¹ç›®æ–‡æ¡£",
    "description": "ç¼–å†™é¡¹ç›®çš„æŠ€æœ¯æ–‡æ¡£å’Œç”¨æˆ·æ‰‹å†Œ",
    "status": TaskStatus.PENDING,
    "priority": PriorityLevel.HIGH
}

task = task_repo.create(task_data)

# åˆ›å»ºå­ä»»åŠ¡
subtask_data = {
    "user_id": "user_id_here",
    "title": "ç¼–å†™APIæ–‡æ¡£",
    "parent_id": task.id,  # æŒ‡å®šçˆ¶ä»»åŠ¡
    "status": TaskStatus.PENDING
}

subtask = task_repo.create(subtask_data)
```

#### æŸ¥è¯¢ä»»åŠ¡

```python
# æ ¹æ®çŠ¶æ€æŸ¥è¯¢ä»»åŠ¡
pending_tasks = task_repo.find_by_status(TaskStatus.PENDING, user_id="user_id")
completed_tasks = task_repo.find_by_status(TaskStatus.COMPLETED)

# æ ¹æ®ä¼˜å…ˆçº§æŸ¥è¯¢ä»»åŠ¡
high_priority_tasks = task_repo.find_by_priority(PriorityLevel.HIGH)

# æŸ¥è¯¢å³å°†åˆ°æœŸçš„ä»»åŠ¡ï¼ˆ7å¤©å†…ï¼‰
due_tasks = task_repo.find_due_tasks(days=7)

# æŸ¥è¯¢è¿‡æœŸä»»åŠ¡
overdue_tasks = task_repo.find_overdue_tasks()

# æŸ¥è¯¢æ ¹ä»»åŠ¡ï¼ˆæ²¡æœ‰çˆ¶ä»»åŠ¡çš„ä»»åŠ¡ï¼‰
root_tasks = task_repo.get_root_tasks(user_id="user_id")

# æŸ¥è¯¢å­ä»»åŠ¡
subtasks = task_repo.get_subtasks(parent_id="parent_task_id")
```

#### ä»»åŠ¡ç®¡ç†

```python
# å®Œæˆä»»åŠ¡
completed_task = task_repo.complete_task("task_id_here")

# å½’æ¡£ä»»åŠ¡
archived_task = task_repo.archive_task("task_id_here")

# æ¢å¤å·²å½’æ¡£çš„ä»»åŠ¡
restored_task = task_repo.restore_task("task_id_here")
```

#### ä»»åŠ¡å±‚æ¬¡ç»“æ„

```python
# è·å–ä»»åŠ¡çš„å®Œæ•´å±‚æ¬¡ç»“æ„
hierarchy = task_repo.get_task_hierarchy("task_id_here")
print(f"ä»»åŠ¡: {hierarchy['task']['title']}")
print(f"å­ä»»åŠ¡æ•°é‡: {len(hierarchy['subtasks'])}")

for subtask in hierarchy['subtasks']:
    print(f"- {subtask['title']}")
```

#### æ¯æ—¥TOP3ä»»åŠ¡

```python
# è·å–ç”¨æˆ·ä»Šæ—¥TOP3ä»»åŠ¡
daily_top3 = task_repo.get_daily_top3("user_id_here")
for i, task_top3 in enumerate(daily_top3, 1):
    print(f"ç¬¬{i}ä½: {task_top3.task.title}")

# è®¾ç½®æ¯æ—¥TOP3ä»»åŠ¡
task_ids = ["task1_id", "task2_id", "task3_id"]
top3_tasks = task_repo.set_daily_top3("user_id_here", task_ids)
```

#### åŸºç¡€CRUDæ“ä½œ

```python
# æ ¹æ®IDæŸ¥è¯¢ä»»åŠ¡
task = task_repo.get_by_id("task_id_here")

# æ›´æ–°ä»»åŠ¡
updated_task = task_repo.update(
    "task_id_here",
    {"title": "æ–°æ ‡é¢˜", "status": TaskStatus.IN_PROGRESS}
)

# åˆ é™¤ä»»åŠ¡
success = task_repo.delete("task_id_here")
```

## ğŸ¯ ä¸“æ³¨ç³»ç»Ÿæ¥å£

### FocusRepository - ä¸“æ³¨ä¼šè¯æ•°æ®è®¿é—®

#### å¼€å§‹ä¸“æ³¨ä¼šè¯

```python
# å¼€å§‹åŸºç¡€ä¸“æ³¨ä¼šè¯
focus_session = focus_repo.start_focus_session(
    user_id="user_id_here",
    duration_minutes=25,  # ä¸“æ³¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    task_id="task_id_here"  # å¯é€‰ï¼šå…³è”çš„ä»»åŠ¡
)

print(f"ä¸“æ³¨ä¼šè¯å·²å¼€å§‹: {focus_session.id}")
print(f"é¢„è®¡ç»“æŸæ—¶é—´: {focus_session.started_at + timedelta(minutes=25)}")
```

#### æŸ¥è¯¢ä¸“æ³¨ä¼šè¯

```python
# æŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰ä¸“æ³¨ä¼šè¯
user_sessions = focus_repo.find_by_user("user_id_here")

# æŸ¥è¯¢æ­£åœ¨è¿›è¡Œçš„ä¸“æ³¨ä¼šè¯
active_sessions = focus_repo.find_active_sessions("user_id_here")

# æŸ¥è¯¢å·²å®Œæˆçš„ä¸“æ³¨ä¼šè¯
completed_sessions = focus_repo.find_completed_sessions("user_id_here")

# æŸ¥è¯¢ç”¨æˆ·ä»Šæ—¥ä¸“æ³¨ä¼šè¯
today_sessions = focus_repo.find_user_today_sessions("user_id_here")

# æ ¹æ®ä¼šè¯ç±»å‹æŸ¥è¯¢
focus_sessions = focus_repo.find_by_session_type(SessionType.FOCUS)
break_sessions = focus_repo.find_by_session_type(SessionType.BREAK)
```

#### ä¸“æ³¨ä¼šè¯ç®¡ç†

```python
# å®Œæˆä¸“æ³¨ä¼šè¯
completed_session = focus_repo.complete_session("session_id_here")
print(f"ä¸“æ³¨æ—¶é•¿: {completed_session.duration_minutes}åˆ†é’Ÿ")

# æš‚åœä¸“æ³¨ä¼šè¯
paused_session = focus_repo.pause_session("session_id_here")

# æ¢å¤ä¸“æ³¨ä¼šè¯
resumed_session = focus_repo.resume_session("session_id_here")

# å–æ¶ˆä¸“æ³¨ä¼šè¯
cancelled_session = focus_repo.cancel_session("session_id_here")
```

#### ä¸“æ³¨ç»Ÿè®¡æ•°æ®

```python
# è·å–ç”¨æˆ·ä¸“æ³¨ç»Ÿè®¡
stats = focus_repo.get_user_focus_statistics("user_id_here")
print(f"æ€»ä¸“æ³¨æ—¶é•¿: {stats['total_focus_minutes']}åˆ†é’Ÿ")
print(f"å®Œæˆä¼šè¯æ•°: {stats['completed_sessions']}")
print(f"å®Œæˆç‡: {stats['completion_rate']:.2%}")

# è·å–æ¯æ—¥ä¸“æ³¨æ±‡æ€»ï¼ˆæœ€è¿‘7å¤©ï¼‰
daily_summary = focus_repo.get_daily_focus_summary("user_id_here", days=7)
for day_data in daily_summary:
    print(f"{day_data['date']}: {day_data['total_minutes']}åˆ†é’Ÿ")

# è·å–æ¯å‘¨ä¸“æ³¨æ±‡æ€»
weekly_summary = focus_repo.get_weekly_focus_summary("user_id_here", weeks=4)

# è·å–æ¯æœˆä¸“æ³¨æ±‡æ€»
monthly_summary = focus_repo.get_monthly_focus_summary("user_id_here", months=12)
```

#### ä¸“æ³¨æ¨¡æ¿ç®¡ç†

```python
# åˆ›å»ºä¸“æ³¨æ¨¡æ¿
template = focus_repo.create_template(
    user_id="user_id_here",
    name="ç•ªèŒ„å·¥ä½œæ³•",
    focus_duration=25,  # ä¸“æ³¨æ—¶é•¿
    break_duration=5,   # ä¼‘æ¯æ—¶é•¿
    description="25åˆ†é’Ÿä¸“æ³¨ï¼Œ5åˆ†é’Ÿä¼‘æ¯çš„å·¥ä½œæ¨¡å¼"
)

# åº”ç”¨ä¸“æ³¨æ¨¡æ¿
focus_session = focus_repo.apply_template(
    template_id="template_id_here",
    user_id="user_id_here"
)

# æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰æ¨¡æ¿
user_templates = focus_repo.find_user_templates("user_id_here")
```

#### ä¼‘æ¯è®°å½•ç®¡ç†

```python
# æ·»åŠ ä¼‘æ¯è®°å½•
break_record = focus_repo.add_break(
    session_id="focus_session_id_here",
    break_duration_minutes=5
)

# å®Œæˆä¼‘æ¯
completed_break = focus_repo.complete_break("break_id_here")

# æŸ¥è¯¢ä¼šè¯çš„æ‰€æœ‰ä¼‘æ¯è®°å½•
session_breaks = focus_repo.find_session_breaks("focus_session_id_here")
```

## ğŸ† å¥–åŠ±ç³»ç»Ÿæ¥å£

### RewardRepository - å¥–åŠ±æ•°æ®è®¿é—®

#### æŸ¥è¯¢å¥–åŠ±

```python
# æŸ¥è¯¢æ‰€æœ‰å¯ç”¨å¥–åŠ±
available_rewards = reward_repo.find_available_rewards()

# æ ¹æ®å¥–åŠ±ç±»å‹æŸ¥è¯¢
badge_rewards = reward_repo.find_by_reward_type(RewardType.BADGE)
item_rewards = reward_repo.find_by_reward_type(RewardType.ITEM)

# æ ¹æ®çŠ¶æ€æŸ¥è¯¢
active_rewards = reward_repo.find_by_status(is_active=True)
inactive_rewards = reward_repo.find_by_status(is_active=False)

# æ ¹æ®ä»·æ ¼èŒƒå›´æŸ¥è¯¢
affordable_rewards = reward_repo.find_rewards_by_price_range(0, 100)
```

#### å¥–åŠ±å…‘æ¢

```python
# éªŒè¯ç”¨æˆ·ä½™é¢æ˜¯å¦è¶³å¤Ÿ
can_redeem = reward_repo.validate_user_balance(
    user_id="user_id_here",
    required_fragments=50
)

if can_redeem:
    # å…‘æ¢å¥–åŠ±
    transaction = reward_repo.redeem_reward(
        user_id="user_id_here",
        reward_id="reward_id_here"
    )
    print(f"å…‘æ¢æˆåŠŸï¼Œäº¤æ˜“ID: {transaction.id}")
else:
    print("ç¢ç‰‡ä½™é¢ä¸è¶³")

# æŸ¥è¯¢ç”¨æˆ·å·²å…‘æ¢çš„å¥–åŠ±
redeemed_rewards = reward_repo.get_user_redeemed_rewards("user_id_here")
```

#### ç¢ç‰‡ç®¡ç†

```python
# è·å–ç”¨æˆ·ç¢ç‰‡ä½™é¢
balance = reward_repo.get_user_fragment_balance("user_id_here")
print(f"å½“å‰ç¢ç‰‡ä½™é¢: {balance}")

# å¥–åŠ±ç¢ç‰‡
transaction = reward_repo.award_fragments(
    user_id="user_id_here",
    amount=10,  # ç¢ç‰‡æ•°é‡
    reason="å®Œæˆä¸“æ³¨ä¼šè¯å¥–åŠ±"
)
print(f"å¥–åŠ±æˆåŠŸï¼Œå½“å‰ä½™é¢: {transaction.balance_after}")

# æŸ¥è¯¢ç”¨æˆ·ç¢ç‰‡äº¤æ˜“å†å²
transactions = reward_repo.get_user_transaction_history("user_id_here")
for tx in transactions:
    print(f"{tx.created_at}: {tx.points_change}ç¢ç‰‡ - {tx.description}")
```

#### æŠ½å¥–ç³»ç»Ÿ

```python
# å‚ä¸æŠ½å¥–
lottery_record = reward_repo.draw_lottery(
    user_id="user_id_here",
    cost_fragments=20  # æ¶ˆè€—20ç¢ç‰‡
)

if lottery_record.won:
    print(f"æ­å–œä¸­å¥–ï¼è·å¾—: {lottery_record.reward_name}")
else:
    print("æœªä¸­å¥–ï¼Œä¸‹æ¬¡å†æ¥")

# æŸ¥è¯¢ç”¨æˆ·æŠ½å¥–è®°å½•
user_lotteries = reward_repo.get_user_lottery_records("user_id_here")

# è·å–æŠ½å¥–ç»Ÿè®¡
lottery_stats = reward_repo.get_lottery_statistics()
print(f"æ€»æŠ½å¥–æ¬¡æ•°: {lottery_stats['total_draws']}")
print(f"ä¸­å¥–ç‡: {lottery_stats['win_rate']:.2%}")
```

#### ç§¯åˆ†æµæ°´

```python
# åˆ›å»ºç§¯åˆ†äº¤æ˜“è®°å½•
transaction = reward_repo.create_points_transaction(
    user_id="user_id_here",
    transaction_type=TransactionType.EARN,  # æˆ– SPEND
    points_change=50,
    balance_before=100,
    balance_after=150,
    description="å®Œæˆä»»åŠ¡å¥–åŠ±"
)

# æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†å†å²
points_history = reward_repo.get_user_points_history("user_id_here")

# è·å–ç”¨æˆ·ç§¯åˆ†ç»Ÿè®¡æ±‡æ€»
summary = reward_repo.get_user_points_summary("user_id_here", days=30)
print(f"æ€»æ”¶å…¥: {summary['total_earned']}ç¢ç‰‡")
print(f"æ€»æ”¯å‡º: {summary['total_spent']}ç¢ç‰‡")
print(f"å½“å‰ä½™é¢: {summary['current_balance']}ç¢ç‰‡")
print(f"å‡€å˜åŒ–: {summary['net_change']}ç¢ç‰‡")
```

## âš ï¸ å¼‚å¸¸å¤„ç†

### å¼‚å¸¸ç±»å‹

```python
from src.repositories.base import (
    RepositoryError,           # åŸºç¡€å¼‚å¸¸ç±»
    RepositoryValidationError,  # å‚æ•°éªŒè¯å¼‚å¸¸
    RepositoryNotFoundError,   # èµ„æºæœªæ‰¾åˆ°å¼‚å¸¸
    RepositoryIntegrityError   # æ•°æ®å®Œæ•´æ€§å¼‚å¸¸
)
```

### å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ

```python
def create_user_safely(user_data):
    try:
        with db_connection.get_session() as session:
            user_repo = UserRepository(session)

            # æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
            if user_repo.email_exists(user_data["email"]):
                raise ValueError("é‚®ç®±å·²è¢«ä½¿ç”¨")

            # åˆ›å»ºç”¨æˆ·
            user = user_repo.create(user_data)
            return user

    except RepositoryValidationError as e:
        print(f"å‚æ•°éªŒè¯å¤±è´¥: {e}")
        return None

    except RepositoryIntegrityError as e:
        print(f"æ•°æ®å®Œæ•´æ€§å†²çª: {e}")
        return None

    except RepositoryError as e:
        print(f"æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")
        return None

    except Exception as e:
        print(f"æœªçŸ¥é”™è¯¯: {e}")
        return None

# ä½¿ç”¨ç¤ºä¾‹
user = create_user_safely({
    "email": "new@example.com",
    "nickname": "æ–°ç”¨æˆ·",
    "password_hash": "hashed_password"
})
```

### å¸¸è§é”™è¯¯åœºæ™¯

```python
# 1. æŸ¥æ‰¾ä¸å­˜åœ¨çš„èµ„æº
try:
    user = user_repo.get_by_id("non_existent_id")
    if user is None:
        print("ç”¨æˆ·ä¸å­˜åœ¨")
except RepositoryNotFoundError:
    print("ç”¨æˆ·ä¸å­˜åœ¨")

# 2. å‚æ•°éªŒè¯
try:
    # æ— æ•ˆçš„é‚®ç®±æ ¼å¼
    user = user_repo.create({"email": "", "nickname": "æµ‹è¯•"})
except RepositoryValidationError as e:
    print(f"éªŒè¯é”™è¯¯: {e}")

# 3. æ•°æ®å®Œæ•´æ€§çº¦æŸ
try:
    # é‡å¤çš„é‚®ç®±
    user1 = user_repo.create({"email": "same@example.com", "nickname": "ç”¨æˆ·1"})
    user2 = user_repo.create({"email": "same@example.com", "nickname": "ç”¨æˆ·2"})
except RepositoryIntegrityError as e:
    print(f"å®Œæ•´æ€§é”™è¯¯: {e}")
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### æŸ¥è¯¢ä¼˜åŒ–

```python
# âœ… æ¨èï¼šä½¿ç”¨å…·ä½“çš„æŸ¥è¯¢æ–¹æ³•
active_users = user_repo.find_active_users()

# âŒ é¿å…ï¼šè·å–æ‰€æœ‰æ•°æ®ååœ¨å†…å­˜ä¸­è¿‡æ»¤
all_users = user_repo.get_all()
active_users = [u for u in all_users if u.is_active]

# âœ… æ¨èï¼šä½¿ç”¨ç´¢å¼•å­—æ®µæŸ¥è¯¢
user = user_repo.find_by_email("user@example.com")

# âŒ é¿å…ï¼šä½¿ç”¨éç´¢å¼•å­—æ®µè¿›è¡Œå¤§é‡æŸ¥è¯¢
```

### æ‰¹é‡æ“ä½œ

```python
# âœ… æ¨èï¼šåœ¨å•ä¸ªä¼šè¯ä¸­è¿›è¡Œå¤šä¸ªæ“ä½œ
with db_connection.get_session() as session:
    user_repo = UserRepository(session)
    task_repo = TaskRepository(session)

    # åˆ›å»ºç”¨æˆ·
    user = user_repo.create(user_data)

    # ä¸ºç”¨æˆ·åˆ›å»ºå¤šä¸ªä»»åŠ¡
    for task_data in task_list:
        task_data["user_id"] = user.id
        task_repo.create(task_data)

    # è‡ªåŠ¨æäº¤æ‰€æœ‰æ›´æ”¹

# âŒ é¿å…ï¼šå¤šä¸ªç‹¬ç«‹çš„ä¼šè¯
# user_repo = UserRepository(session1)
# task_repo = TaskRepository(session2)  # ä¸åŒçš„ä¼šè¯
```

### åˆ†é¡µæŸ¥è¯¢

```python
# å¯¹äºå¤§é‡æ•°æ®ï¼Œè€ƒè™‘åœ¨Repositoryä¸­æ·»åŠ åˆ†é¡µæ”¯æŒ
# ç›®å‰å¯ä»¥ç»“åˆskipå’Œlimitå®ç°ç±»ä¼¼æ•ˆæœ
def get_users_paginated(page: int, size: int):
    with db_connection.get_session() as session:
        user_repo = UserRepository(session)

        # è·å–æ€»æ•°
        total = user_repo.count()

        # ç®€å•åˆ†é¡µï¼ˆå®é™…é¡¹ç›®ä¸­å»ºè®®æ·»åŠ ä¸“é—¨çš„åˆ†é¡µæ–¹æ³•ï¼‰
        all_users = user_repo.get_all()
        start = (page - 1) * size
        end = start + size

        return {
            "users": all_users[start:end],
            "total": total,
            "page": page,
            "size": size
        }
```

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

### è¾“å…¥éªŒè¯

```python
# âœ… å§‹ç»ˆéªŒè¯ç”¨æˆ·è¾“å…¥
def create_user_safe(email: str, nickname: str):
    # éªŒè¯é‚®ç®±æ ¼å¼
    if not "@" in email or len(email) > 255:
        raise ValueError("æ— æ•ˆçš„é‚®ç®±æ ¼å¼")

    # éªŒè¯æ˜µç§°é•¿åº¦
    if not nickname or len(nickname) > 100:
        raise ValueError("æ˜µç§°ä¸èƒ½ä¸ºç©ºä¸”ä¸è¶…è¿‡100ä¸ªå­—ç¬¦")

    # åˆ›å»ºç”¨æˆ·
    return user_repo.create({
        "email": email,
        "nickname": nickname,
        "user_type": "registered"
    })
```

### å¯†ç å¤„ç†

```python
# âœ… ä½¿ç”¨å¯†ç å“ˆå¸Œ
import bcrypt

def hash_password(password: str) -> str:
    salt = bcrypt.gensalt()
    return bcrypt.hashpw(password.encode('utf-8'), salt).decode('utf-8')

# åˆ›å»ºç”¨æˆ·æ—¶å­˜å‚¨å“ˆå¸Œå¯†ç 
user_data = {
    "email": "user@example.com",
    "nickname": "ç”¨æˆ·",
    "password_hash": hash_password("plain_password")  # å­˜å‚¨å“ˆå¸Œå€¼
}
```

### æƒé™æ£€æŸ¥

```python
# âœ… åœ¨ä¸šåŠ¡å±‚æ·»åŠ æƒé™æ£€æŸ¥
def update_user_profile(current_user_id: str, target_user_id: str, updates: dict):
    # æ£€æŸ¥æ˜¯å¦æœ‰æƒé™ä¿®æ”¹ç›®æ ‡ç”¨æˆ·
    if current_user_id != target_user_id:
        raise PermissionError("æ— æƒé™ä¿®æ”¹å…¶ä»–ç”¨æˆ·ä¿¡æ¯")

    with db_connection.get_session() as session:
        user_repo = UserRepository(session)
        return user_repo.update(target_user_id, updates)
```

## ğŸ§ª æµ‹è¯•æ”¯æŒ

### æµ‹è¯•æ•°æ®å‡†å¤‡

```python
# æµ‹è¯•æ—¶ä½¿ç”¨å†…å­˜æ•°æ®åº“
import pytest
from sqlmodel import create_engine
from sqlalchemy.orm import sessionmaker

@pytest.fixture
def test_session():
    engine = create_engine("sqlite:///:memory:")
    from src.models.base_model import BaseSQLModel
    BaseSQLModel.metadata.create_all(engine)

    SessionLocal = sessionmaker(bind=engine)
    session = SessionLocal()

    try:
        yield session
    finally:
        session.close()

# æµ‹è¯•ç¤ºä¾‹
def test_create_user(test_session):
    user_repo = UserRepository(test_session)
    user = user_repo.create({
        "email": "test@example.com",
        "nickname": "æµ‹è¯•ç”¨æˆ·",
        "user_type": "guest"
    })

    assert user.id is not None
    assert user.email == "test@example.com"
```

## ğŸ“ æœ€ä½³å®è·µæ€»ç»“

### DO - æ¨èåšæ³•

1. **ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨**ç¡®ä¿æ•°æ®åº“ä¼šè¯æ­£ç¡®å…³é—­
2. **å…·ä½“çš„æŸ¥è¯¢æ–¹æ³•**è€Œä¸æ˜¯è·å–æ‰€æœ‰æ•°æ®ååœ¨å†…å­˜ä¸­è¿‡æ»¤
3. **å¼‚å¸¸å¤„ç†**åŒ…è£…æ‰€æœ‰æ•°æ®è®¿é—®æ“ä½œ
4. **å‚æ•°éªŒè¯**åœ¨è°ƒç”¨Repositoryä¹‹å‰éªŒè¯è¾“å…¥
5. **äº‹åŠ¡ç®¡ç†**åœ¨å•ä¸ªä¼šè¯ä¸­å®Œæˆç›¸å…³çš„å¤šä¸ªæ“ä½œ

### DON'T - é¿å…åšæ³•

1. **ä¸è¦**åœ¨å¾ªç¯ä¸­åˆ›å»ºå¤šä¸ªæ•°æ®åº“ä¼šè¯
2. **ä¸è¦**å¿½ç•¥RepositoryæŠ›å‡ºçš„å¼‚å¸¸
3. **ä¸è¦**åœ¨ä¸šåŠ¡å±‚ç›´æ¥æ“ä½œSQL
4. **ä¸è¦**å‡è®¾æ•°æ®åº“æ“ä½œæ€»æ˜¯æˆåŠŸ
5. **ä¸è¦**å¿˜è®°å…³é—­æ•°æ®åº“ä¼šè¯

### ä»£ç ç¤ºä¾‹

```python
# âœ… å®Œæ•´çš„æœ€ä½³å®è·µç¤ºä¾‹
def complete_user_task(user_id: str, task_id: str):
    """
    å®Œæˆç”¨æˆ·ä»»åŠ¡çš„æœ€ä½³å®è·µç¤ºä¾‹
    """
    try:
        with db_connection.get_session() as session:
            # åˆ›å»ºRepositoryå®ä¾‹
            user_repo = UserRepository(session)
            task_repo = TaskRepository(session)
            focus_repo = FocusRepository(session)
            reward_repo = RewardRepository(session)

            # 1. éªŒè¯ç”¨æˆ·å­˜åœ¨
            user = user_repo.get_by_id(user_id)
            if not user:
                raise ValueError("ç”¨æˆ·ä¸å­˜åœ¨")

            # 2. éªŒè¯ä»»åŠ¡å­˜åœ¨ä¸”å±äºè¯¥ç”¨æˆ·
            task = task_repo.get_by_id(task_id)
            if not task or task.user_id != user_id:
                raise ValueError("ä»»åŠ¡ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®")

            # 3. å®Œæˆä»»åŠ¡
            completed_task = task_repo.complete_task(task_id)

            # 4. å¦‚æœæœ‰ç›¸å…³ä¸“æ³¨ä¼šè¯ï¼Œä¹Ÿå®Œæˆå®ƒ
            active_sessions = focus_repo.find_active_sessions(user_id)
            for session in active_sessions:
                if session.task_id == task_id:
                    focus_repo.complete_session(session.id)
                    break

            # 5. å¥–åŠ±ç¢ç‰‡ï¼ˆæ ¹æ®ä»»åŠ¡å¤æ‚åº¦ï¼‰
            fragment_reward = 10 if completed_task.priority == PriorityLevel.HIGH else 5
            reward_repo.award_fragments(
                user_id=user_id,
                amount=fragment_reward,
                reason=f"å®Œæˆä»»åŠ¡: {completed_task.title}"
            )

            return {
                "task": completed_task,
                "fragments_awarded": fragment_reward
            }

    except RepositoryValidationError as e:
        print(f"å‚æ•°éªŒè¯å¤±è´¥: {e}")
        raise

    except RepositoryNotFoundError as e:
        print(f"èµ„æºæœªæ‰¾åˆ°: {e}")
        raise

    except RepositoryError as e:
        print(f"æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")
        raise

    except Exception as e:
        print(f"æœªçŸ¥é”™è¯¯: {e}")
        raise
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨æ•°æ®å±‚æ¥å£æ—¶é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. **æŸ¥çœ‹å¼‚å¸¸ä¿¡æ¯**ï¼šå¤§å¤šæ•°é”™è¯¯éƒ½æœ‰è¯¦ç»†çš„é”™è¯¯æè¿°
2. **æ£€æŸ¥å‚æ•°**ï¼šç¡®ä¿ä¼ é€’ç»™Repositoryçš„å‚æ•°æ ¼å¼æ­£ç¡®
3. **å‚è€ƒç¤ºä¾‹**ï¼šæœ¬æ–‡æ¡£æä¾›äº†æ¯ä¸ªæ¥å£çš„å®Œæ•´ä½¿ç”¨ç¤ºä¾‹
4. **æŸ¥çœ‹æµ‹è¯•**ï¼š`tests/repositories/` ç›®å½•æœ‰æ›´å¤šä½¿ç”¨ç¤ºä¾‹

## ğŸš€ ä¸‹ä¸€æ­¥

æ•°æ®å±‚æ¥å£å·²ç»å®Œå…¨å‡†å¤‡å¥½ä¾›æœåŠ¡å±‚ä½¿ç”¨ã€‚æ‚¨å¯ä»¥ï¼š

1. å¼€å§‹å®ç°ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚
2. åˆ›å»ºAPIæ¥å£å±‚
3. æ·»åŠ ç¼“å­˜å±‚ï¼ˆå¦‚æœéœ€è¦ï¼‰
4. å®ç°æ›´å¤æ‚çš„ä¸šåŠ¡æµç¨‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ
**ç»´æŠ¤è€…**: TaKeKe å¼€å‘å›¢é˜Ÿ