# 任务管理 API

## 目录

- [1. 创建新任务](#1-创建新任务)
- [2. 查询任务列表](#2-查询任务列表)
- [3. 获取所有标签](#3-获取所有标签)
- [4. 更新任务](#4-更新任务)
- [5. 删除任务](#5-删除任务)
- [6. 完成任务](#6-完成任务)
- [7. 记录专注状态](#7-记录专注状态)
- [8. 获取番茄钟计数](#8-获取番茄钟计数)
- [9. 微服务健康检查](#9-微服务健康检查)

---

## 1. 创建新任务

**POST** `/tasks/`

**功能描述**: 创建任务 - 微服务代理
用于创建新任务，支持设置任务的基本信息、优先级、时间安排等。

**认证**: 【必需】需要Bearer Token

**请求参数**:
```json
{
  "title": "string",                    // 【必填】任务标题，1-100字符
  "description": "string|null",        // 【可选】任务描述，最多5000字符
  "status": "string",                  // 【可选】任务状态，默认"pending"
  "priority": "string",                // 【可选】优先级，默认"medium"
  "parent_id": "string|null",          // 【可选】父任务ID，支持任务树结构
  "tags": "array|string|null",         // 【可选】任务标签列表，最多10个标签
  "service_ids": "array|string|null",   // 【可选】关联服务ID列表，占位字段
  "due_date": "string|null",           // 【可选】任务截止日期（ISO 8601格式）
  "planned_start_time": "string|null", // 【可选】计划开始时间（ISO 8601格式）
  "planned_end_time": "string|null"    // 【可选】计划结束时间（ISO 8601格式）
}
```

**字段要求**:
- `title`: 【必填】字符串，最小长度1，最大长度100
- `description`: 【可选】字符串，最大长度5000
- `status`: 【可选】枚举值：`pending`, `in_progress`, `completed`，默认`pending`
- `priority`: 【可选】枚举值：`low`, `medium`, `high`，默认`medium`
- `parent_id`: 【可选】有效的UUID字符串，如果设置必须存在
- `tags`: 【可选】字符串数组，最多10个标签，每个标签最多20字符
- `service_ids`: 【可选】字符串数组，最多10个服务ID
- `due_date`: 【可选】ISO 8601格式的日期时间
- `planned_start_time`: 【可选】ISO 8601格式的日期时间
- `planned_end_time`: 【可选】ISO 8601格式的日期时间

**验证规则**:
- 如果设置`parent_id`，必须为有效的UUID格式
- 如果设置时间范围，`planned_end_time`必须晚于`planned_start_time`
- `tags`数组中的每个标签最多20个字符
- `additionalProperties`: false，不允许额外字段

**响应格式**:
```json
{
  "code": 200,
  "message": "任务创建成功",
  "data": {
    "id": "string",                    // 任务ID（UUID）
    "title": "string",                 // 任务标题
    "description": "string|null",     // 任务描述
    "status": "string",               // 任务状态
    "priority": "string",             // 任务优先级
    "user_id": "string",              // 用户ID
    "parent_id": "string|null",       // 父任务ID
    "tags": "array",                  // 任务标签数组
    "service_ids": "array",           // 关联服务ID数组
    "due_date": "string|null",        // 截止日期
    "planned_start_time": "string|null", // 计划开始时间
    "planned_end_time": "string|null",   // 计划结束时间
    "last_claimed_date": "string|null", // 最后领奖日期
    "is_deleted": "boolean",          // 是否已删除
    "created_at": "string",           // 创建时间
    "updated_at": "string",           // 更新时间
    "completion_percentage": "number" // 完成百分比
  }
}
```

---

## 2. 查询任务列表

**POST** `/tasks/query`

**功能描述**: 查询任务列表 - 微服务代理（路径重写）
支持分页查询和多种筛选条件。

**认证**: 【必需】需要Bearer Token

**请求参数**:
```json
{
  "page": "integer",        // 【可选】页码，从1开始，默认1
  "page_size": "integer",   // 【可选】每页大小，1-100，默认20
  "status": "string|null",  // 【可选】任务状态筛选
  "priority": "string|null" // 【可选】优先级筛选
}
```

**字段要求**:
- `page`: 【可选】整数，最小值1，默认值1
- `page_size`: 【可选】整数，最小值1，最大值100，默认值20
- `status`: 【可选】任务状态筛选：`pending`, `in_progress`, `completed`
- `priority`: 【可选】优先级筛选：`low`, `medium`, `high`

**响应格式**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "tasks": [
      {
        "id": "string",                    // 任务ID
        "title": "string",                 // 任务标题
        "description": "string|null",     // 任务描述
        "status": "string",               // 任务状态
        "priority": "string",             // 任务优先级
        "user_id": "string",              // 用户ID
        "parent_id": "string|null",       // 父任务ID
        "tags": "array",                  // 任务标签
        "due_date": "string|null",        // 截止日期
        "created_at": "string",           // 创建时间
        "updated_at": "string",           // 更新时间
        "completion_percentage": "number" // 完成百分比
      }
    ],
    "pagination": {
      "current_page": "integer",   // 当前页码
      "page_size": "integer",      // 每页大小
      "total_count": "integer",    // 总记录数
      "total_pages": "integer",    // 总页数
      "has_next": "boolean",       // 是否有下一页
      "has_prev": "boolean"        // 是否有上一页
    }
  }
}
```

---

## 3. 获取所有标签

**GET** `/tasks/tags`

**功能描述**: 获取所有任务标签 - 微服务代理
获取当前用户所有任务的标签列表，用于标签选择和管理。

**认证**: 【必需】需要Bearer Token

**查询参数**: 无

**业务流程**:
1. 从token中解析出userid
2. 查询该用户所有任务的标签
3. 去重并按名称排序
4. 返回标签列表

**响应格式**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "tags": [
      {
        "id": "string",    // 标签唯一ID
        "name": "string"   // 标签名称
      }
    ]
  }
}
```

**返回字段详细说明**:
- `id`: 标签唯一标识符，UUID格式
- `name`: 标签名称

**业务规则**:
- 只返回当前用户任务的标签
- 标签按名称字母顺序排序
- 空标签不会被返回
- 如果用户没有任何标签，返回空的tags数组

---

## 4. 更新任务

**PUT** `/tasks/{task_id}`

**功能描述**: 更新任务 - 微服务代理（路径重写）
支持部分更新，只更新提供的字段。

**认证**: 【必需】需要Bearer Token

**路径参数**:
- `task_id`: 【必填】任务ID（UUID格式）

**请求参数**:
```json
{
  "title": "string|null",            // 【可选】任务标题，1-100字符
  "description": "string|null",     // 【可选】任务描述，最多5000字符
  "status": "string|null",          // 【可选】任务状态
  "priority": "string|null",        // 【可选】任务优先级
  "parent_id": "string|null",       // 【可选】父任务ID
  "tags": "array|string|null",       // 【可选】任务标签列表
  "service_ids": "array|string|null", // 【可选】关联服务ID列表
  "due_date": "string|null",        // 【可选】任务截止日期
  "planned_start_time": "string|null", // 【可选】计划开始时间
  "planned_end_time": "string|null"   // 【可选】计划结束时间
}
```

**字段要求**:
- 所有字段都是【可选】的，支持部分更新
- 字段验证规则与创建时相同
- 如果提供`parent_id`且值为`null`，会将任务移至根级别
- 如果提供`tags`，会完全替换现有标签，不是追加
- `additionalProperties`: false，不允许额外字段

**响应格式**:
```json
{
  "code": 200,
  "message": "任务更新成功",
  "data": {
    "id": "string",                    // 任务ID
    "title": "string",                 // 更新后的任务标题
    "description": "string|null",     // 更新后的任务描述
    "status": "string",               // 更新后的任务状态
    "priority": "string",             // 更新后的任务优先级
    "updated_at": "string",           // 更新时间
    "completion_percentage": "number" // 完成百分比
  }
}
```

---

## 5. 删除任务

**DELETE** `/tasks/{task_id}`

**功能描述**: 删除任务 - 微服务代理（路径重写）
删除指定任务，如果存在子任务会级联删除。

**认证**: 【必需】需要Bearer Token

**路径参数**:
- `task_id`: 【必填】任务ID（UUID格式）

**请求参数**: 无

**响应格式**:
```json
{
  "code": 200,
  "message": "任务删除成功",
  "data": {
    "deleted_task_id": "string",  // 被删除的任务ID
    "deleted_count": "integer",   // 删除的任务总数（包括级联删除的子任务）
    "cascade_deleted": "boolean"  // 是否有级联删除的子任务
  }
}
```

---

## 6. 完成任务

**POST** `/tasks/{task_id}/complete`

**功能描述**: 完成任务 - 微服务代理（路径重写）
标记任务为完成状态，计算积分奖励，如果是Top3任务触发抽奖。

**认证**: 【必需】需要Bearer Token

**路径参数**:
- `task_id`: 【必填】任务ID（UUID格式）

**请求参数**:
```json
{
  "mood_feedback": {              // 【可选】任务完成反馈
    "comment": "string",          // 评论内容
    "difficulty": "string"        // 难度等级：easy, medium, hard
  } | null
}
```

**字段要求**:
- `mood_feedback`: 【可选】对象，包含评论和难度反馈
- `comment`: 【可选】字符串，评论内容
- `difficulty`: 【可选】枚举值：`easy`, `medium`, `hard`

**响应格式**:
```json
{
  "code": 200,
  "message": "任务完成成功",
  "data": {
    "task": {                      // 完成后的任务信息
      "id": "string",
      "title": "string",
      "status": "completed",
      "completed_at": "string",
      "completion_percentage": 100.0
    },
    "completion_result": {          // 任务完成操作结果
      "points_earned": "integer",   // 获得的基础积分
      "bonus_points": "integer",    // 额外奖励积分
      "total_points": "integer",    // 总积分
      "achievements_unlocked": []   // 解锁的成就列表
    },
    "lottery_result": {             // 抽奖结果（Top3任务才有）
      "won_prize": "boolean",       // 是否中奖
      "prize_name": "string|null",  // 奖品名称
      "prize_value": "integer|null", // 奖品价值
      "message": "string"           // 抽奖消息
    } | null,
    "parent_update": {              // 父任务更新信息
      "updated": "boolean",         // 是否更新了父任务
      "parent_id": "string",        // 父任务ID
      "previous_completion": "number", // 之前完成度
      "new_completion": "number",   // 新的完成度
      "message": "string"           // 更新消息
    } | null,
    "message": "string"             // 操作结果描述
  }
}
```

---

## 7. 记录专注状态

**POST** `/tasks/focus-status`

**功能描述**: 记录专注状态 - 微服务代理（路径重写）
记录用户的专注状态和时长，用于积分奖励。

**认证**: 【必需】需要Bearer Token

**请求参数**:
```json
{
  "focus_status": "string",      // 【必填】专注状态
  "duration_minutes": "integer", // 【必填】专注时长（分钟）
  "task_id": "string|null"       // 【可选】关联的任务ID
}
```

**字段要求**:
- `focus_status`: 【必填】字符串，专注状态描述
- `duration_minutes`: 【必填】整数，必须大于0（exclusiveMinimum: 0）
- `task_id`: 【可选】UUID格式，关联的任务ID

**响应格式**:
```json
{
  "code": 200,
  "message": "专注状态记录成功",
  "data": {
    "focus_id": "string",        // 专注记录ID
    "status": "string",          // 记录状态
    "duration": "integer",       // 记录的时长（分钟）
    "points_earned": "integer",  // 获得积分
    "task_id": "string|null",    // 关联的任务ID
    "recorded_at": "string"      // 记录时间
  }
}
```

---

## 8. 获取番茄钟计数

**GET** `/tasks/pomodoro-count`

**功能描述**: 获取番茄钟计数 - 微服务代理（路径重写）
获取指定时间范围内的番茄钟统计数据。

**认证**: 【必需】需要Bearer Token

**查询参数**:
- `date_filter`: 【可选】日期筛选，可选值：`today`, `week`, `month`，默认`today`

**响应格式**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "count": "integer",         // 番茄钟数量
    "total_duration": "integer", // 总时长（分钟）
    "period": "string",         // 查询周期
    "average_duration": "number", // 平均时长（分钟）
    "points_earned": "integer",  // 获得总积分
    "date_range": {             // 日期范围
      "start": "string",        // 开始日期
      "end": "string"          // 结束日期
    }
  }
}
```

---

## 9. 微服务健康检查

**GET** `/tasks/health`

**功能描述**: 微服务健康检查
检查任务管理微服务的运行状态。

**认证**: 不需要

**查询参数**: 无

**响应格式**:
```json
{
  "code": 200,
  "message": "服务正常",
  "data": {
    "status": "healthy",         // 服务状态
    "timestamp": "string",       // 检查时间
    "version": "string",         // 服务版本
    "uptime": "integer",         // 运行时间（秒）
    "database": "connected",     // 数据库连接状态
    "dependencies": {            // 依赖服务状态
      "redis": "connected",
      "rabbitmq": "connected"
    }
  }
}
```

---

*文档最后更新时间: 2025-01-07*
*基于OpenAPI 3.1.0规范*