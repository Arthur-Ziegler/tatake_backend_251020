# 聊天系统 API

## 目录

- [1. 查询所有会话列表](#1-查询所有会话列表)
- [2. 查询聊天记录](#2-查询聊天记录)
- [3. 删除会话](#3-删除会话)
- [4. 聊天接口（流式）](#4-聊天接口流式)

---

## 1. 查询所有会话列表

**GET** `/chat/sessions`

**功能描述**: 查询所有会话列表
获取当前用户的所有聊天会话列表。

**认证**: 【必需】需要Bearer Token

**查询参数**: 无

**业务流程**:
1. 从token中解析出userid
2. 查询该用户的所有会话session
3. 返回会话列表，包含会话id和会话标题

**响应格式**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "session_id": "string",  // 会话ID
      "title": "string",       // 会话标题
      "created_at": "string",  // 创建时间
      "updated_at": "string",  // 更新时间
      "message_count": "integer", // 消息数量
      "last_message": "string|null" // 最后一条消息
    }
  ]
}
```

---

## 2. 查询聊天记录

**GET** `/chat/sessions/{session_id}/messages`

**功能描述**: 查询聊天记录
获取指定会话的详细聊天记录。

**认证**: 【必需】需要Bearer Token

**路径参数**:
- `session_id`: 【必填】会话ID

**查询参数**: 无

**业务流程**:
1. 验证用户是否为该会话的主人
2. 如果验证通过，返回该session的消息列表
3. 返回完整的聊天历史，包括角色、内容和时间

**响应格式**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "session_id": "string",     // 会话ID
    "title": "string",          // 会话标题
    "created_at": "string",     // 会话创建时间
    "messages": [               // 聊天记录列表
      {
        "role": "human|assistant", // 消息角色
        "content": "string",     // 消息内容
        "time": "string"         // UTC时间（ISO格式）
      }
    ],
    "total_messages": "integer" // 消息总数
  }
}
```

**错误响应**:
- `403`: 无权限访问该会话
- `404`: 会话不存在

---

## 3. 删除会话

**DELETE** `/chat/sessions/{session_id}`

**功能描述**: 删除会话
删除指定的聊天会话及其所有消息。

**认证**: 【必需】需要Bearer Token

**路径参数**:
- `session_id`: 【必填】会话ID

**业务流程**:
1. 验证用户是否为该会话的主人
2. 删除session表中的会话信息
3. 删除所有相关的message记录
4. 返回删除结果

**响应格式**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": {
    "success": "boolean",      // 删除是否成功
    "deleted_session_id": "string", // 被删除的会话ID
    "deleted_messages_count": "integer" // 删除的消息数量
  }
}
```

**错误响应**:
- `403`: 无权限删除该会话
- `404`: 会话不存在

---

## 4. 聊天接口（流式）

**POST** `/chat/sessions/{session_id}/chat`

**功能描述**: 聊天接口（流式）
与AI进行对话，支持流式响应。

**认证**: 【必需】需要Bearer Token

**路径参数**:
- `session_id`: 【必填】会话ID

**请求参数**:
```json
{
  "message": "string"  // 【必填】消息内容
}
```

**字段要求**:
- `message`: 【必填】字符串，用户发送的消息内容

**业务流程**:
1. 检查session是否存在
2. 如果session不存在，先创建新session，标题使用"会话+时间"格式
3. 如果session存在，继续在该session中聊天
4. 流式输出AI的回复结果
5. 每次输出纯文本，无其他格式信息

**响应**: 流式输出纯文本字符串，每个chunk只包含文本内容。

**错误响应**（非流式）:
```json
{
  "code": 400,
  "message": "消息内容不能为空",
  "data": null
}
```

---

*文档最后更新时间: 2025-01-07*
*基于OpenAPI 3.1.0规范*