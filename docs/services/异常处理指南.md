# 服务层异常处理指南

## 概述

本文档详细说明服务层异常处理机制，包括异常类型、处理模式、最佳实践和API层集成。

## 🏗️ 异常架构

### 异常层次结构

```
BusinessException (业务异常基类)
├── AuthenticationException (认证异常)
├── AuthorizationException (授权异常)
├── ValidationException (验证异常)
├── ResourceNotFoundException (资源不存在)
├── DuplicateResourceException (资源重复)
├── InsufficientBalanceException (余额不足)
└── ServiceUnavailableException (服务不可用)
```

### 核心异常类

#### BusinessException - 业务异常基类

```python
class BusinessException(Exception):
    """业务异常基类"""

    def __init__(
        self,
        error_code: str,
        message: str,
        user_message: Optional[str] = None,
        details: Optional[Dict[str, Any]] = None
    ):
        self.error_code = error_code
        self.message = message
        self.user_message = user_message or message
        self.details = details or {}
        super().__init__(message)
```

**字段说明**：
- `error_code`: 错误代码，用于程序化处理
- `message`: 技术性错误消息
- `user_message`: 用户友好的错误消息
- `details`: 额外的错误详情

#### 具体异常类型

```python
# 资源不存在
class ResourceNotFoundException(BusinessException):
    def __init__(self, resource_type: str, resource_id: str):
        super().__init__(
            error_code="RESOURCE_NOT_FOUND",
            message=f"{resource_type} with ID {resource_id} not found",
            user_message=f"找不到该{resource_type}",
            details={"resource_type": resource_type, "resource_id": resource_id}
        )

# 验证异常
class ValidationException(BusinessException):
    def __init__(
        self,
        field: str,
        value: Any,
        message: str,
        details: Optional[Dict] = None
    ):
        super().__init__(
            error_code="VALIDATION_ERROR",
            message=message,
            user_message=f"字段 '{field}' 验证失败: {message}",
            details={"field": field, "value": str(value), **(details or {})}
        )

# 认证异常
class AuthenticationException(BusinessException):
    def __init__(self, message: str = "Authentication failed"):
        super().__init__(
            error_code="AUTHENTICATION_FAILED",
            message=message,
            user_message="身份验证失败，请重新登录"
        )

# 授权异常
class AuthorizationException(BusinessException):
    def __init__(self, required_permission: str, user_id: str, resource_id: str = None):
        super().__init__(
            error_code="AUTHORIZATION_FAILED",
            message=f"User {user_id} lacks permission {required_permission}",
            user_message="您没有权限执行此操作",
            details={
                "required_permission": required_permission,
                "user_id": user_id,
                "resource_id": resource_id
            }
        )
```

## 🔧 异常处理模式

### 1. 基本异常处理

```python
class TaskService(BaseService):
    def get_task(self, task_id: str, user_id: str) -> Dict[str, Any]:
        try:
            # 检查任务存在
            task = self._check_resource_exists(
                self.get_task_repository(),
                task_id,
                "任务"
            )

            # 检查权限
            if task.user_id != user_id:
                raise AuthorizationException(
                    required_permission="task:read",
                    user_id=user_id,
                    resource_id=task_id
                )

            return self._task_to_dict(task)

        except BusinessException:
            # 业务异常直接抛出
            raise

        except Exception as e:
            # 其他异常包装为业务异常
            self._handle_repository_error(e, "get_task", {
                "task_id": task_id,
                "user_id": user_id
            })
```

### 2. Repository异常包装

```python
def _handle_repository_error(self, error: Exception, operation: str, context: Dict = None):
    """处理Repository层异常"""
    if isinstance(error, BusinessException):
        raise

    # 根据异常类型创建相应的业务异常
    if "not found" in str(error).lower():
        raise ResourceNotFoundException("资源", "unknown")

    if "duplicate" in str(error).lower():
        raise DuplicateResourceException("资源", "unknown")

    # 其他异常包装为通用业务异常
    raise wrap_repository_error(error, operation)
```

### 3. 验证异常处理

```python
def create_task(self, user_id: str, task_data: Dict[str, Any]) -> Dict[str, Any]:
    # 验证必填字段
    self.validate_required_fields(task_data, ["title", "description"])

    # 验证标题长度
    if len(task_data["title"]) > 200:
        raise ValidationException(
            field="title",
            value=task_data["title"],
            message="标题长度不能超过200个字符",
            details={"max_length": 200, "actual_length": len(task_data["title"])}
        )

    # 验证截止日期格式
    if "due_date" in task_data:
        try:
            datetime.fromisoformat(task_data["due_date"])
        except ValueError:
            raise ValidationException(
                field="due_date",
                value=task_data["due_date"],
                message="截止日期格式无效，请使用YYYY-MM-DD格式"
            )

    # 继续业务逻辑...
```

## 🎯 异常处理最佳实践

### 1. 使用适当的异常类型

```python
# ✅ 好的做法
def transfer_points(self, from_user: str, to_user: str, amount: int):
    # 检查余额
    from_balance = self.get_user_balance(from_user)
    if from_balance < amount:
        raise InsufficientBalanceException(
            current_balance=from_balance,
            requested_amount=amount,
            user_id=from_user
        )

# ❌ 避免的做法
def transfer_points(self, from_user: str, to_user: str, amount: int):
    if self.get_user_balance(from_user) < amount:
        raise Exception("余额不足")  # 使用通用异常
```

### 2. 提供清晰的错误信息

```python
# ✅ 提供用户友好的错误信息
def update_user_email(self, user_id: str, email: str):
    if not self._is_valid_email(email):
        raise ValidationException(
            field="email",
            value=email,
            message="邮箱格式无效",
            user_message="请输入有效的邮箱地址"
        )

# ✅ 提供技术详细信息
raise ValidationException(
    field="email",
    value=email,
    message="Email format validation failed",
    details={
        "pattern": r"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$",
        "provided_value": email,
        "validation_step": "regex_match"
    }
)
```

### 3. 记录异常上下文

```python
def delete_task(self, task_id: str, user_id: str):
    try:
        # 业务逻辑
        self.get_task_repository().delete(task_id)

        self._log_operation_success("delete_task", task_id=task_id, user_id=user_id)

    except BusinessException as e:
        # 记录业务异常
        self._log_operation_error("delete_task", e, task_id=task_id, user_id=user_id)
        raise

    except Exception as e:
        # 记录并包装系统异常
        self._handle_repository_error(e, "delete_task", {
            "task_id": task_id,
            "user_id": user_id,
            "operation": "delete_task"
        })
```

### 4. 异常链保持

```python
def complex_operation(self, data: Dict):
    try:
        # 调用其他服务
        result = self.dependent_service.process(data)
        return result

    except BusinessException as e:
        # 保持原始异常信息
        raise BusinessException(
            error_code="COMPLEX_OPERATION_FAILED",
            message=f"Complex operation failed: {e.message}",
            user_message="操作失败，请稍后重试",
            details={"original_error": e.error_code, "context": data}
        ) from e
```

## 🔌 API层异常集成

### 1. FastAPI异常处理器

```python
from fastapi import Request, HTTPException
from fastapi.responses import JSONResponse
from src.services.exceptions import BusinessException

async def business_exception_handler(request: Request, exc: BusinessException):
    """统一处理业务异常"""

    # 根据异常类型确定HTTP状态码
    status_code = _get_status_code_for_exception(exc)

    return JSONResponse(
        status_code=status_code,
        content={
            "success": False,
            "error": {
                "code": exc.error_code,
                "message": exc.user_message,
                "details": exc.details,
                "timestamp": datetime.now().isoformat(),
                "path": str(request.url)
            }
        }
    )

def _get_status_code_for_exception(exc: BusinessException) -> int:
    """根据异常类型获取HTTP状态码"""
    status_map = {
        AuthenticationException: 401,
        AuthorizationException: 403,
        ResourceNotFoundException: 404,
        ValidationException: 422,
        DuplicateResourceException: 409,
        InsufficientBalanceException: 400,
    }

    for exception_type, status in status_map.items():
        if isinstance(exc, exception_type):
            return status

    return 400  # 默认业务异常状态码
```

### 2. 路由级异常处理

```python
@router.post("/tasks")
async def create_task(
    task_data: CreateTaskRequest,
    current_user: dict = Depends(get_current_user),
    task_service: TaskService = Depends(get_task_service)
):
    """创建任务"""
    try:
        task = task_service.create_task(current_user["user_id"], task_data.dict())
        return {"success": True, "data": task}

    except ValidationException as e:
        # 验证异常返回详细字段信息
        return JSONResponse(
            status_code=422,
            content={
                "success": False,
                "error": {
                    "code": e.error_code,
                    "message": e.user_message,
                    "field": e.details.get("field"),
                    "value": e.details.get("value")
                }
            }
        )

    except BusinessException as e:
        # 其他业务异常
        raise HTTPException(status_code=400, detail=e.user_message)

    except Exception as e:
        # 未预期的系统异常
        logger.error(f"Unexpected error in create_task: {e}")
        raise HTTPException(status_code=500, detail="内部服务器错误")
```

### 3. 异常中间件

```python
import logging
from fastapi import Request, HTTPException
from fastapi.responses import JSONResponse

logger = logging.getLogger(__name__)

async def global_exception_handler(request: Request, call_next):
    """全局异常处理中间件"""
    try:
        response = await call_next(request)
        return response

    except HTTPException as e:
        # HTTP异常直接返回
        return JSONResponse(
            status_code=e.status_code,
            content={
                "success": False,
                "error": {
                    "code": "HTTP_ERROR",
                    "message": e.detail,
                    "path": str(request.url)
                }
            }
        )

    except Exception as e:
        # 记录未预期异常
        logger.error(
            f"Unhandled exception: {e}",
            exc_info=True,
            extra={"path": str(request.url), "method": request.method}
        )

        return JSONResponse(
            status_code=500,
            content={
                "success": False,
                "error": {
                    "code": "INTERNAL_SERVER_ERROR",
                    "message": "内部服务器错误",
                    "path": str(request.url)
                }
            }
        )
```

## 🧪 异常测试

### 1. 单元测试异常

```python
import pytest
from src.services.task_service import TaskService
from src.services.exceptions import ResourceNotFoundException, ValidationException

class TestTaskService:
    def test_get_task_not_found(self):
        """测试获取不存在的任务"""
        service = TaskService()

        with pytest.raises(ResourceNotFoundException) as exc_info:
            service.get_task("nonexistent_task", "user_123")

        assert exc_info.value.error_code == "RESOURCE_NOT_FOUND"
        assert "任务" in exc_info.value.user_message

    def test_create_task_invalid_title(self):
        """测试创建任务时标题无效"""
        service = TaskService()

        invalid_data = {
            "title": "",  # 空标题
            "description": "有效描述"
        }

        with pytest.raises(ValidationException) as exc_info:
            service.create_task("user_123", invalid_data)

        assert exc_info.value.error_code == "VALIDATION_ERROR"
        assert "title" in exc_info.value.details["field"]
```

### 2. API异常测试

```python
import pytest
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

def test_create_task_validation_error():
    """测试创建任务时的验证错误"""
    response = client.post(
        "/api/v1/tasks",
        json={
            "title": "",  # 无效数据
            "description": "test"
        },
        headers={"Authorization": "Bearer valid_token"}
    )

    assert response.status_code == 422
    data = response.json()
    assert not data["success"]
    assert data["error"]["code"] == "VALIDATION_ERROR"
    assert "title" in data["error"]["field"]

def test_get_task_not_found():
    """测试获取不存在的任务"""
    response = client.get(
        "/api/v1/tasks/nonexistent_task",
        headers={"Authorization": "Bearer valid_token"}
    )

    assert response.status_code == 404
    data = response.json()
    assert not data["success"]
    assert data["error"]["code"] == "RESOURCE_NOT_FOUND"
```

## 📊 异常监控和分析

### 1. 异常统计

```python
class ExceptionMonitor:
    def __init__(self):
        self.exception_counts = {}
        self.exception_details = {}

    def record_exception(self, exception: BusinessException, context: Dict = None):
        """记录异常"""
        exception_type = type(exception).__name__

        # 统计异常次数
        self.exception_counts[exception_type] = self.exception_counts.get(exception_type, 0) + 1

        # 记录异常详情
        if exception_type not in self.exception_details:
            self.exception_details[exception_type] = []

        self.exception_details[exception_type].append({
            "error_code": exception.error_code,
            "message": exception.message,
            "details": exception.details,
            "context": context,
            "timestamp": datetime.now().isoformat()
        })

    def get_statistics(self) -> Dict:
        """获取异常统计"""
        total_exceptions = sum(self.exception_counts.values())

        return {
            "total_exceptions": total_exceptions,
            "exception_types": self.exception_counts,
            "most_common": max(self.exception_counts.items(), key=lambda x: x[1]) if self.exception_counts else None,
            "recent_exceptions": self._get_recent_exceptions()
        }
```

### 2. 异常报告

```python
def generate_exception_report(monitor: ExceptionMonitor) -> str:
    """生成异常报告"""
    stats = monitor.get_statistics()

    report = f"""
# 异常统计报告

## 总体统计
- 总异常数: {stats['total_exceptions']}
- 异常类型数: {len(stats['exception_types'])}

## 异常类型分布
"""

    for exception_type, count in stats['exception_types'].items():
        percentage = (count / stats['total_exceptions']) * 100
        report += f"- {exception_type}: {count} ({percentage:.1f}%)\n"

    if stats['most_common']:
        most_common_type, most_common_count = stats['most_common']
        report += f"\n## 最常见异常\n- {most_common_type}: {most_common_count}次\n"

    return report
```

## 🛠️ 调试和故障排除

### 1. 异常日志分析

```bash
# 查看特定类型的异常
grep "error_code\":\"VALIDATION_ERROR" logs/services.log | jq

# 查看最近的异常
tail -100 logs/services.log | grep "level\":\"ERROR" | jq

# 分析异常趋势
grep "error_code" logs/services.log | jq -r '.error_code' | sort | uniq -c | sort -nr
```

### 2. 异常回溯

```python
def trace_exception(exception: BusinessException, service: BaseService):
    """追踪异常来源"""
    print(f"异常类型: {type(exception).__name__}")
    print(f"错误代码: {exception.error_code}")
    print(f"错误消息: {exception.message}")
    print(f"用户消息: {exception.user_message}")
    print(f"详细信息: {exception.details}")

    # 如果服务有日志，可以查看相关日志
    if hasattr(service, '_logger'):
        service._log_error("异常追踪", exception, {
            "exception_type": type(exception).__name__,
            "error_code": exception.error_code
        })
```

### 3. 常见异常排查

| 异常类型 | 常见原因 | 排查方法 |
|----------|----------|----------|
| `ResourceNotFoundException` | ID不存在、权限问题 | 检查资源ID、用户权限 |
| `ValidationException` | 输入格式错误、必填字段缺失 | 检查输入数据格式、验证规则 |
| `AuthenticationException` | 令牌过期、签名错误 | 检查令牌有效性、签名算法 |
| `AuthorizationException` | 权限不足、角色错误 | 检查用户角色、权限配置 |
| `InsufficientBalanceException` | 余额不足、积分不够 | 检查用户余额、交易金额 |

---

**最后更新**: 2025-10-20
**版本**: 1.0.0
**维护者**: 开发团队