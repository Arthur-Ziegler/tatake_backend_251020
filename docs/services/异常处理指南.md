# æœåŠ¡å±‚å¼‚å¸¸å¤„ç†æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜æœåŠ¡å±‚å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬å¼‚å¸¸ç±»å‹ã€å¤„ç†æ¨¡å¼ã€æœ€ä½³å®è·µå’ŒAPIå±‚é›†æˆã€‚

## ğŸ—ï¸ å¼‚å¸¸æ¶æ„

### å¼‚å¸¸å±‚æ¬¡ç»“æ„

```
BusinessException (ä¸šåŠ¡å¼‚å¸¸åŸºç±»)
â”œâ”€â”€ AuthenticationException (è®¤è¯å¼‚å¸¸)
â”œâ”€â”€ AuthorizationException (æˆæƒå¼‚å¸¸)
â”œâ”€â”€ ValidationException (éªŒè¯å¼‚å¸¸)
â”œâ”€â”€ ResourceNotFoundException (èµ„æºä¸å­˜åœ¨)
â”œâ”€â”€ DuplicateResourceException (èµ„æºé‡å¤)
â”œâ”€â”€ InsufficientBalanceException (ä½™é¢ä¸è¶³)
â””â”€â”€ ServiceUnavailableException (æœåŠ¡ä¸å¯ç”¨)
```

### æ ¸å¿ƒå¼‚å¸¸ç±»

#### BusinessException - ä¸šåŠ¡å¼‚å¸¸åŸºç±»

```python
class BusinessException(Exception):
    """ä¸šåŠ¡å¼‚å¸¸åŸºç±»"""

    def __init__(
        self,
        error_code: str,
        message: str,
        user_message: Optional[str] = None,
        details: Optional[Dict[str, Any]] = None
    ):
        self.error_code = error_code
        self.message = message
        self.user_message = user_message or message
        self.details = details or {}
        super().__init__(message)
```

**å­—æ®µè¯´æ˜**ï¼š
- `error_code`: é”™è¯¯ä»£ç ï¼Œç”¨äºç¨‹åºåŒ–å¤„ç†
- `message`: æŠ€æœ¯æ€§é”™è¯¯æ¶ˆæ¯
- `user_message`: ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
- `details`: é¢å¤–çš„é”™è¯¯è¯¦æƒ…

#### å…·ä½“å¼‚å¸¸ç±»å‹

```python
# èµ„æºä¸å­˜åœ¨
class ResourceNotFoundException(BusinessException):
    def __init__(self, resource_type: str, resource_id: str):
        super().__init__(
            error_code="RESOURCE_NOT_FOUND",
            message=f"{resource_type} with ID {resource_id} not found",
            user_message=f"æ‰¾ä¸åˆ°è¯¥{resource_type}",
            details={"resource_type": resource_type, "resource_id": resource_id}
        )

# éªŒè¯å¼‚å¸¸
class ValidationException(BusinessException):
    def __init__(
        self,
        field: str,
        value: Any,
        message: str,
        details: Optional[Dict] = None
    ):
        super().__init__(
            error_code="VALIDATION_ERROR",
            message=message,
            user_message=f"å­—æ®µ '{field}' éªŒè¯å¤±è´¥: {message}",
            details={"field": field, "value": str(value), **(details or {})}
        )

# è®¤è¯å¼‚å¸¸
class AuthenticationException(BusinessException):
    def __init__(self, message: str = "Authentication failed"):
        super().__init__(
            error_code="AUTHENTICATION_FAILED",
            message=message,
            user_message="èº«ä»½éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•"
        )

# æˆæƒå¼‚å¸¸
class AuthorizationException(BusinessException):
    def __init__(self, required_permission: str, user_id: str, resource_id: str = None):
        super().__init__(
            error_code="AUTHORIZATION_FAILED",
            message=f"User {user_id} lacks permission {required_permission}",
            user_message="æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ",
            details={
                "required_permission": required_permission,
                "user_id": user_id,
                "resource_id": resource_id
            }
        )
```

## ğŸ”§ å¼‚å¸¸å¤„ç†æ¨¡å¼

### 1. åŸºæœ¬å¼‚å¸¸å¤„ç†

```python
class TaskService(BaseService):
    def get_task(self, task_id: str, user_id: str) -> Dict[str, Any]:
        try:
            # æ£€æŸ¥ä»»åŠ¡å­˜åœ¨
            task = self._check_resource_exists(
                self.get_task_repository(),
                task_id,
                "ä»»åŠ¡"
            )

            # æ£€æŸ¥æƒé™
            if task.user_id != user_id:
                raise AuthorizationException(
                    required_permission="task:read",
                    user_id=user_id,
                    resource_id=task_id
                )

            return self._task_to_dict(task)

        except BusinessException:
            # ä¸šåŠ¡å¼‚å¸¸ç›´æ¥æŠ›å‡º
            raise

        except Exception as e:
            # å…¶ä»–å¼‚å¸¸åŒ…è£…ä¸ºä¸šåŠ¡å¼‚å¸¸
            self._handle_repository_error(e, "get_task", {
                "task_id": task_id,
                "user_id": user_id
            })
```

### 2. Repositoryå¼‚å¸¸åŒ…è£…

```python
def _handle_repository_error(self, error: Exception, operation: str, context: Dict = None):
    """å¤„ç†Repositoryå±‚å¼‚å¸¸"""
    if isinstance(error, BusinessException):
        raise

    # æ ¹æ®å¼‚å¸¸ç±»å‹åˆ›å»ºç›¸åº”çš„ä¸šåŠ¡å¼‚å¸¸
    if "not found" in str(error).lower():
        raise ResourceNotFoundException("èµ„æº", "unknown")

    if "duplicate" in str(error).lower():
        raise DuplicateResourceException("èµ„æº", "unknown")

    # å…¶ä»–å¼‚å¸¸åŒ…è£…ä¸ºé€šç”¨ä¸šåŠ¡å¼‚å¸¸
    raise wrap_repository_error(error, operation)
```

### 3. éªŒè¯å¼‚å¸¸å¤„ç†

```python
def create_task(self, user_id: str, task_data: Dict[str, Any]) -> Dict[str, Any]:
    # éªŒè¯å¿…å¡«å­—æ®µ
    self.validate_required_fields(task_data, ["title", "description"])

    # éªŒè¯æ ‡é¢˜é•¿åº¦
    if len(task_data["title"]) > 200:
        raise ValidationException(
            field="title",
            value=task_data["title"],
            message="æ ‡é¢˜é•¿åº¦ä¸èƒ½è¶…è¿‡200ä¸ªå­—ç¬¦",
            details={"max_length": 200, "actual_length": len(task_data["title"])}
        )

    # éªŒè¯æˆªæ­¢æ—¥æœŸæ ¼å¼
    if "due_date" in task_data:
        try:
            datetime.fromisoformat(task_data["due_date"])
        except ValueError:
            raise ValidationException(
                field="due_date",
                value=task_data["due_date"],
                message="æˆªæ­¢æ—¥æœŸæ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨YYYY-MM-DDæ ¼å¼"
            )

    # ç»§ç»­ä¸šåŠ¡é€»è¾‘...
```

## ğŸ¯ å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ

### 1. ä½¿ç”¨é€‚å½“çš„å¼‚å¸¸ç±»å‹

```python
# âœ… å¥½çš„åšæ³•
def transfer_points(self, from_user: str, to_user: str, amount: int):
    # æ£€æŸ¥ä½™é¢
    from_balance = self.get_user_balance(from_user)
    if from_balance < amount:
        raise InsufficientBalanceException(
            current_balance=from_balance,
            requested_amount=amount,
            user_id=from_user
        )

# âŒ é¿å…çš„åšæ³•
def transfer_points(self, from_user: str, to_user: str, amount: int):
    if self.get_user_balance(from_user) < amount:
        raise Exception("ä½™é¢ä¸è¶³")  # ä½¿ç”¨é€šç”¨å¼‚å¸¸
```

### 2. æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

```python
# âœ… æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
def update_user_email(self, user_id: str, email: str):
    if not self._is_valid_email(email):
        raise ValidationException(
            field="email",
            value=email,
            message="é‚®ç®±æ ¼å¼æ— æ•ˆ",
            user_message="è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€"
        )

# âœ… æä¾›æŠ€æœ¯è¯¦ç»†ä¿¡æ¯
raise ValidationException(
    field="email",
    value=email,
    message="Email format validation failed",
    details={
        "pattern": r"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$",
        "provided_value": email,
        "validation_step": "regex_match"
    }
)
```

### 3. è®°å½•å¼‚å¸¸ä¸Šä¸‹æ–‡

```python
def delete_task(self, task_id: str, user_id: str):
    try:
        # ä¸šåŠ¡é€»è¾‘
        self.get_task_repository().delete(task_id)

        self._log_operation_success("delete_task", task_id=task_id, user_id=user_id)

    except BusinessException as e:
        # è®°å½•ä¸šåŠ¡å¼‚å¸¸
        self._log_operation_error("delete_task", e, task_id=task_id, user_id=user_id)
        raise

    except Exception as e:
        # è®°å½•å¹¶åŒ…è£…ç³»ç»Ÿå¼‚å¸¸
        self._handle_repository_error(e, "delete_task", {
            "task_id": task_id,
            "user_id": user_id,
            "operation": "delete_task"
        })
```

### 4. å¼‚å¸¸é“¾ä¿æŒ

```python
def complex_operation(self, data: Dict):
    try:
        # è°ƒç”¨å…¶ä»–æœåŠ¡
        result = self.dependent_service.process(data)
        return result

    except BusinessException as e:
        # ä¿æŒåŸå§‹å¼‚å¸¸ä¿¡æ¯
        raise BusinessException(
            error_code="COMPLEX_OPERATION_FAILED",
            message=f"Complex operation failed: {e.message}",
            user_message="æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",
            details={"original_error": e.error_code, "context": data}
        ) from e
```

## ğŸ”Œ APIå±‚å¼‚å¸¸é›†æˆ

### 1. FastAPIå¼‚å¸¸å¤„ç†å™¨

```python
from fastapi import Request, HTTPException
from fastapi.responses import JSONResponse
from src.services.exceptions import BusinessException

async def business_exception_handler(request: Request, exc: BusinessException):
    """ç»Ÿä¸€å¤„ç†ä¸šåŠ¡å¼‚å¸¸"""

    # æ ¹æ®å¼‚å¸¸ç±»å‹ç¡®å®šHTTPçŠ¶æ€ç 
    status_code = _get_status_code_for_exception(exc)

    return JSONResponse(
        status_code=status_code,
        content={
            "success": False,
            "error": {
                "code": exc.error_code,
                "message": exc.user_message,
                "details": exc.details,
                "timestamp": datetime.now().isoformat(),
                "path": str(request.url)
            }
        }
    )

def _get_status_code_for_exception(exc: BusinessException) -> int:
    """æ ¹æ®å¼‚å¸¸ç±»å‹è·å–HTTPçŠ¶æ€ç """
    status_map = {
        AuthenticationException: 401,
        AuthorizationException: 403,
        ResourceNotFoundException: 404,
        ValidationException: 422,
        DuplicateResourceException: 409,
        InsufficientBalanceException: 400,
    }

    for exception_type, status in status_map.items():
        if isinstance(exc, exception_type):
            return status

    return 400  # é»˜è®¤ä¸šåŠ¡å¼‚å¸¸çŠ¶æ€ç 
```

### 2. è·¯ç”±çº§å¼‚å¸¸å¤„ç†

```python
@router.post("/tasks")
async def create_task(
    task_data: CreateTaskRequest,
    current_user: dict = Depends(get_current_user),
    task_service: TaskService = Depends(get_task_service)
):
    """åˆ›å»ºä»»åŠ¡"""
    try:
        task = task_service.create_task(current_user["user_id"], task_data.dict())
        return {"success": True, "data": task}

    except ValidationException as e:
        # éªŒè¯å¼‚å¸¸è¿”å›è¯¦ç»†å­—æ®µä¿¡æ¯
        return JSONResponse(
            status_code=422,
            content={
                "success": False,
                "error": {
                    "code": e.error_code,
                    "message": e.user_message,
                    "field": e.details.get("field"),
                    "value": e.details.get("value")
                }
            }
        )

    except BusinessException as e:
        # å…¶ä»–ä¸šåŠ¡å¼‚å¸¸
        raise HTTPException(status_code=400, detail=e.user_message)

    except Exception as e:
        # æœªé¢„æœŸçš„ç³»ç»Ÿå¼‚å¸¸
        logger.error(f"Unexpected error in create_task: {e}")
        raise HTTPException(status_code=500, detail="å†…éƒ¨æœåŠ¡å™¨é”™è¯¯")
```

### 3. å¼‚å¸¸ä¸­é—´ä»¶

```python
import logging
from fastapi import Request, HTTPException
from fastapi.responses import JSONResponse

logger = logging.getLogger(__name__)

async def global_exception_handler(request: Request, call_next):
    """å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶"""
    try:
        response = await call_next(request)
        return response

    except HTTPException as e:
        # HTTPå¼‚å¸¸ç›´æ¥è¿”å›
        return JSONResponse(
            status_code=e.status_code,
            content={
                "success": False,
                "error": {
                    "code": "HTTP_ERROR",
                    "message": e.detail,
                    "path": str(request.url)
                }
            }
        )

    except Exception as e:
        # è®°å½•æœªé¢„æœŸå¼‚å¸¸
        logger.error(
            f"Unhandled exception: {e}",
            exc_info=True,
            extra={"path": str(request.url), "method": request.method}
        )

        return JSONResponse(
            status_code=500,
            content={
                "success": False,
                "error": {
                    "code": "INTERNAL_SERVER_ERROR",
                    "message": "å†…éƒ¨æœåŠ¡å™¨é”™è¯¯",
                    "path": str(request.url)
                }
            }
        )
```

## ğŸ§ª å¼‚å¸¸æµ‹è¯•

### 1. å•å…ƒæµ‹è¯•å¼‚å¸¸

```python
import pytest
from src.services.task_service import TaskService
from src.services.exceptions import ResourceNotFoundException, ValidationException

class TestTaskService:
    def test_get_task_not_found(self):
        """æµ‹è¯•è·å–ä¸å­˜åœ¨çš„ä»»åŠ¡"""
        service = TaskService()

        with pytest.raises(ResourceNotFoundException) as exc_info:
            service.get_task("nonexistent_task", "user_123")

        assert exc_info.value.error_code == "RESOURCE_NOT_FOUND"
        assert "ä»»åŠ¡" in exc_info.value.user_message

    def test_create_task_invalid_title(self):
        """æµ‹è¯•åˆ›å»ºä»»åŠ¡æ—¶æ ‡é¢˜æ— æ•ˆ"""
        service = TaskService()

        invalid_data = {
            "title": "",  # ç©ºæ ‡é¢˜
            "description": "æœ‰æ•ˆæè¿°"
        }

        with pytest.raises(ValidationException) as exc_info:
            service.create_task("user_123", invalid_data)

        assert exc_info.value.error_code == "VALIDATION_ERROR"
        assert "title" in exc_info.value.details["field"]
```

### 2. APIå¼‚å¸¸æµ‹è¯•

```python
import pytest
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

def test_create_task_validation_error():
    """æµ‹è¯•åˆ›å»ºä»»åŠ¡æ—¶çš„éªŒè¯é”™è¯¯"""
    response = client.post(
        "/api/v1/tasks",
        json={
            "title": "",  # æ— æ•ˆæ•°æ®
            "description": "test"
        },
        headers={"Authorization": "Bearer valid_token"}
    )

    assert response.status_code == 422
    data = response.json()
    assert not data["success"]
    assert data["error"]["code"] == "VALIDATION_ERROR"
    assert "title" in data["error"]["field"]

def test_get_task_not_found():
    """æµ‹è¯•è·å–ä¸å­˜åœ¨çš„ä»»åŠ¡"""
    response = client.get(
        "/api/v1/tasks/nonexistent_task",
        headers={"Authorization": "Bearer valid_token"}
    )

    assert response.status_code == 404
    data = response.json()
    assert not data["success"]
    assert data["error"]["code"] == "RESOURCE_NOT_FOUND"
```

## ğŸ“Š å¼‚å¸¸ç›‘æ§å’Œåˆ†æ

### 1. å¼‚å¸¸ç»Ÿè®¡

```python
class ExceptionMonitor:
    def __init__(self):
        self.exception_counts = {}
        self.exception_details = {}

    def record_exception(self, exception: BusinessException, context: Dict = None):
        """è®°å½•å¼‚å¸¸"""
        exception_type = type(exception).__name__

        # ç»Ÿè®¡å¼‚å¸¸æ¬¡æ•°
        self.exception_counts[exception_type] = self.exception_counts.get(exception_type, 0) + 1

        # è®°å½•å¼‚å¸¸è¯¦æƒ…
        if exception_type not in self.exception_details:
            self.exception_details[exception_type] = []

        self.exception_details[exception_type].append({
            "error_code": exception.error_code,
            "message": exception.message,
            "details": exception.details,
            "context": context,
            "timestamp": datetime.now().isoformat()
        })

    def get_statistics(self) -> Dict:
        """è·å–å¼‚å¸¸ç»Ÿè®¡"""
        total_exceptions = sum(self.exception_counts.values())

        return {
            "total_exceptions": total_exceptions,
            "exception_types": self.exception_counts,
            "most_common": max(self.exception_counts.items(), key=lambda x: x[1]) if self.exception_counts else None,
            "recent_exceptions": self._get_recent_exceptions()
        }
```

### 2. å¼‚å¸¸æŠ¥å‘Š

```python
def generate_exception_report(monitor: ExceptionMonitor) -> str:
    """ç”Ÿæˆå¼‚å¸¸æŠ¥å‘Š"""
    stats = monitor.get_statistics()

    report = f"""
# å¼‚å¸¸ç»Ÿè®¡æŠ¥å‘Š

## æ€»ä½“ç»Ÿè®¡
- æ€»å¼‚å¸¸æ•°: {stats['total_exceptions']}
- å¼‚å¸¸ç±»å‹æ•°: {len(stats['exception_types'])}

## å¼‚å¸¸ç±»å‹åˆ†å¸ƒ
"""

    for exception_type, count in stats['exception_types'].items():
        percentage = (count / stats['total_exceptions']) * 100
        report += f"- {exception_type}: {count} ({percentage:.1f}%)\n"

    if stats['most_common']:
        most_common_type, most_common_count = stats['most_common']
        report += f"\n## æœ€å¸¸è§å¼‚å¸¸\n- {most_common_type}: {most_common_count}æ¬¡\n"

    return report
```

## ğŸ› ï¸ è°ƒè¯•å’Œæ•…éšœæ’é™¤

### 1. å¼‚å¸¸æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹ç‰¹å®šç±»å‹çš„å¼‚å¸¸
grep "error_code\":\"VALIDATION_ERROR" logs/services.log | jq

# æŸ¥çœ‹æœ€è¿‘çš„å¼‚å¸¸
tail -100 logs/services.log | grep "level\":\"ERROR" | jq

# åˆ†æå¼‚å¸¸è¶‹åŠ¿
grep "error_code" logs/services.log | jq -r '.error_code' | sort | uniq -c | sort -nr
```

### 2. å¼‚å¸¸å›æº¯

```python
def trace_exception(exception: BusinessException, service: BaseService):
    """è¿½è¸ªå¼‚å¸¸æ¥æº"""
    print(f"å¼‚å¸¸ç±»å‹: {type(exception).__name__}")
    print(f"é”™è¯¯ä»£ç : {exception.error_code}")
    print(f"é”™è¯¯æ¶ˆæ¯: {exception.message}")
    print(f"ç”¨æˆ·æ¶ˆæ¯: {exception.user_message}")
    print(f"è¯¦ç»†ä¿¡æ¯: {exception.details}")

    # å¦‚æœæœåŠ¡æœ‰æ—¥å¿—ï¼Œå¯ä»¥æŸ¥çœ‹ç›¸å…³æ—¥å¿—
    if hasattr(service, '_logger'):
        service._log_error("å¼‚å¸¸è¿½è¸ª", exception, {
            "exception_type": type(exception).__name__,
            "error_code": exception.error_code
        })
```

### 3. å¸¸è§å¼‚å¸¸æ’æŸ¥

| å¼‚å¸¸ç±»å‹ | å¸¸è§åŸå›  | æ’æŸ¥æ–¹æ³• |
|----------|----------|----------|
| `ResourceNotFoundException` | IDä¸å­˜åœ¨ã€æƒé™é—®é¢˜ | æ£€æŸ¥èµ„æºIDã€ç”¨æˆ·æƒé™ |
| `ValidationException` | è¾“å…¥æ ¼å¼é”™è¯¯ã€å¿…å¡«å­—æ®µç¼ºå¤± | æ£€æŸ¥è¾“å…¥æ•°æ®æ ¼å¼ã€éªŒè¯è§„åˆ™ |
| `AuthenticationException` | ä»¤ç‰Œè¿‡æœŸã€ç­¾åé”™è¯¯ | æ£€æŸ¥ä»¤ç‰Œæœ‰æ•ˆæ€§ã€ç­¾åç®—æ³• |
| `AuthorizationException` | æƒé™ä¸è¶³ã€è§’è‰²é”™è¯¯ | æ£€æŸ¥ç”¨æˆ·è§’è‰²ã€æƒé™é…ç½® |
| `InsufficientBalanceException` | ä½™é¢ä¸è¶³ã€ç§¯åˆ†ä¸å¤Ÿ | æ£€æŸ¥ç”¨æˆ·ä½™é¢ã€äº¤æ˜“é‡‘é¢ |

---

**æœ€åæ›´æ–°**: 2025-10-20
**ç‰ˆæœ¬**: 1.0.0
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ