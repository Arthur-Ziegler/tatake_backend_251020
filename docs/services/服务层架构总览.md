# æœåŠ¡å±‚æ¶æ„æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†tatakeåç«¯æœåŠ¡å±‚çš„å®Œæ•´æ¶æ„è¯´æ˜ï¼ŒåŒ…æ‹¬è®¾è®¡åŸåˆ™ã€æ ¸å¿ƒç»„ä»¶ã€ä½¿ç”¨æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚æœåŠ¡å±‚ä½äºæ•°æ®è®¿é—®å±‚ï¼ˆRepositoryï¼‰å’ŒAPIå±‚ä¹‹é—´ï¼Œè´Ÿè´£å¤„ç†ä¸šåŠ¡é€»è¾‘ã€æ•°æ®éªŒè¯ã€æƒé™æ§åˆ¶ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•

- [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
- [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
- [æœåŠ¡ç±»è¯¦è§£](#æœåŠ¡ç±»è¯¦è§£)
- [ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ](#ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ)
- [å¼‚å¸¸å¤„ç†](#å¼‚å¸¸å¤„ç†)
- [ä¾èµ–æ³¨å…¥](#ä¾èµ–æ³¨å…¥)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [APIå±‚å¼€å‘æŒ‡å—](#apiå±‚å¼€å‘æŒ‡å—)

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### åˆ†å±‚æ¶æ„

```
APIå±‚ (FastAPI/Controllers)
    â†“
æœåŠ¡å±‚ (Services) â† å½“å‰æ–‡æ¡£é‡ç‚¹
    â†“
æ•°æ®è®¿é—®å±‚ (Repository)
    â†“
æ¨¡å‹å±‚ (Models)
```

### è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£åŸåˆ™** - æ¯ä¸ªæœåŠ¡ç±»ä¸“æ³¨äºç‰¹å®šçš„ä¸šåŠ¡é¢†åŸŸ
2. **ä¾èµ–æ³¨å…¥** - é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥Repositoryä¾èµ–
3. **ç»Ÿä¸€æ¥å£** - æ‰€æœ‰æœåŠ¡éƒ½ç»§æ‰¿è‡ªBaseService
4. **å¼‚å¸¸å¤„ç†** - ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†å’Œé”™è¯¯ä¼ æ’­æœºåˆ¶
5. **æ—¥å¿—è®°å½•** - å®Œæ•´çš„æ“ä½œæ—¥å¿—å’Œæ€§èƒ½ç›‘æ§
6. **æ•°æ®éªŒè¯** - ä¸¥æ ¼çš„è¾“å…¥éªŒè¯å’Œä¸šåŠ¡è§„åˆ™æ£€æŸ¥

### æ ¸å¿ƒæœåŠ¡ç±»

| æœåŠ¡ç±» | èŒè´£ | ä¸»è¦åŠŸèƒ½ |
|--------|------|----------|
| `AuthService` | ç”¨æˆ·è®¤è¯ | æ¸¸å®¢è´¦å·ç®¡ç†ã€ç™»å½•ã€ä»¤ç‰Œç®¡ç† |
| `UserService` | ç”¨æˆ·ç®¡ç† | ç”¨æˆ·ä¿¡æ¯ã€è®¾ç½®ã€ç§¯åˆ†ç®¡ç† |
| `TaskService` | ä»»åŠ¡ç®¡ç† | ä»»åŠ¡CRUDã€çŠ¶æ€ç®¡ç†ã€å±‚æ¬¡ç»“æ„ |
| `FocusService` | ä¸“æ³¨ç®¡ç† | ä¸“æ³¨ä¼šè¯ã€ç»Ÿè®¡åˆ†æã€ç•ªèŒ„é’Ÿ |
| `RewardService` | å¥–åŠ±ç®¡ç† | ç§¯åˆ†ç³»ç»Ÿã€ç¢ç‰‡å…‘æ¢ã€æˆå°±ç³»ç»Ÿ |
| `StatisticsService` | ç»Ÿè®¡åˆ†æ | ç”¨æˆ·ç»Ÿè®¡ã€è¶‹åŠ¿åˆ†æã€æŠ¥å‘Šç”Ÿæˆ |
| `ChatService` | èŠå¤©æœåŠ¡ | AIå¯¹è¯ã€å¤šæ¨¡å¼æ”¯æŒã€è®°å¿†ç®¡ç† |

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### BaseService åŸºç±»

æ‰€æœ‰æœåŠ¡ç±»éƒ½ç»§æ‰¿è‡ª`BaseService`ï¼Œæä¾›ç»Ÿä¸€çš„åŸºç¡€åŠŸèƒ½ï¼š

```python
from src.services.base import BaseService

class MyService(BaseService):
    def __init__(self, user_repo=None, **kwargs):
        super().__init__(user_repo=user_repo, **kwargs)
```

#### æ ¸å¿ƒåŠŸèƒ½

- **æ—¥å¿—è®°å½•** - ç»Ÿä¸€çš„æ—¥å¿—æ¥å£å’Œè‡ªåŠ¨è®°å½•
- **å¼‚å¸¸å¤„ç†** - Repositoryå¼‚å¸¸åŒ…è£…å’Œä¸šåŠ¡å¼‚å¸¸å¤„ç†
- **æ•°æ®éªŒè¯** - é€šç”¨éªŒè¯æ–¹æ³•å’Œå‚æ•°æ£€æŸ¥
- **å¥åº·æ£€æŸ¥** - æœåŠ¡çŠ¶æ€å’Œä¾èµ–ç›‘æ§
- **å·¥å…·æ–¹æ³•** - åˆ†é¡µã€ç»Ÿè®¡ã€æ•°æ®è½¬æ¢ç­‰

### ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ

æœåŠ¡å±‚é‡‡ç”¨ç»“æ„åŒ–JSONæ—¥å¿—ï¼Œæ”¯æŒå¤šçº§åˆ«è¾“å‡ºå’Œæ€§èƒ½ç›‘æ§ã€‚

#### æ—¥å¿—çº§åˆ«

```python
# åŸºæœ¬æ—¥å¿—æ–¹æ³•
service._log_info("ä¿¡æ¯æ—¥å¿—", extra_data={"key": "value"})
service._log_warning("è­¦å‘Šæ—¥å¿—")
service._log_error("é”™è¯¯æ—¥å¿—", error=exception)

# æ“ä½œæ—¥å¿—
service._log_operation_start("æ“ä½œåç§°", user_id="123")
service._log_operation_success("æ“ä½œåç§°", duration_ms=100)
service._log_operation_error("æ“ä½œåç§°", exception)
```

#### ç¯å¢ƒå˜é‡é…ç½®

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `SERVICE_LOG_LEVEL` | INFO | æ—¥å¿—çº§åˆ« (DEBUG/INFO/WARNING/ERROR/CRITICAL) |
| `SERVICE_LOG_FORMAT` | structured | æ—¥å¿—æ ¼å¼ (structured/simple) |
| `SERVICE_LOG_CONSOLE` | true | æ§åˆ¶å°è¾“å‡º |
| `SERVICE_LOG_FILE` | true | æ–‡ä»¶è¾“å‡º |
| `SERVICE_LOG_PERFORMANCE` | false | æ€§èƒ½ç›‘æ§ |

#### è£…é¥°å™¨ä½¿ç”¨

```python
from src.services.logging_config import operation_logger, performance_logger

class MyService(BaseService):
    @operation_logger("åˆ›å»ºä»»åŠ¡", log_args=True, log_result=True)
    def create_task(self, task_data):
        # è‡ªåŠ¨è®°å½•æ“ä½œå¼€å§‹ã€æˆåŠŸã€å¤±è´¥
        pass

    @performance_logger("æ•°æ®åº“æŸ¥è¯¢")
    def complex_query(self):
        # è‡ªåŠ¨è®°å½•æ‰§è¡Œæ—¶é—´
        pass
```

## ğŸ“š æœåŠ¡ç±»è¯¦è§£

### AuthService - è®¤è¯æœåŠ¡

**èŒè´£**ï¼šå¤„ç†ç”¨æˆ·è®¤è¯ç›¸å…³ä¸šåŠ¡é€»è¾‘

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- æ¸¸å®¢è´¦å·åˆ›å»ºå’Œç®¡ç†
- ç”¨æˆ·ç™»å½•å’Œä»¤ç‰Œç”Ÿæˆ
- çŸ­ä¿¡éªŒè¯ç ç®¡ç†
- ä»¤ç‰Œåˆ·æ–°å’ŒéªŒè¯

**ä¸»è¦æ–¹æ³•**ï¼š
```python
# åˆ›å»ºæ¸¸å®¢è´¦å·
create_guest_account(device_id: str) -> Dict[str, Any]

# ç”¨æˆ·ç™»å½•
login_with_phone(phone: str, code: str) -> Dict[str, Any]

# åˆ·æ–°ä»¤ç‰Œ
refresh_token(refresh_token: str) -> Dict[str, Any]

# éªŒè¯ä»¤ç‰Œ
verify_token(token: str) -> Dict[str, Any]
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from src.services.auth_service import AuthService

auth_service = AuthService()

# åˆ›å»ºæ¸¸å®¢è´¦å·
guest_result = auth_service.create_guest_account("device_123")
user_id = guest_result["user_id"]

# ç™»å½•å¹¶è·å–ä»¤ç‰Œ
login_result = auth_service.login_with_phone("13800138000", "123456")
access_token = login_result["access_token"]
```

### UserService - ç”¨æˆ·æœåŠ¡

**èŒè´£**ï¼šç”¨æˆ·ä¿¡æ¯ç®¡ç†ã€è®¾ç½®ç®¡ç†ã€ç§¯åˆ†ç³»ç»Ÿ

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ç®¡ç†
- ç”¨æˆ·è®¾ç½®å’Œåå¥½
- ç§¯åˆ†å’Œç¢ç‰‡ç®¡ç†
- ç”¨æˆ·è¡Œä¸ºè®°å½•

**ä¸»è¦æ–¹æ³•**ï¼š
```python
# è·å–ç”¨æˆ·èµ„æ–™
get_user_profile(user_id: str) -> Dict[str, Any]

# æ›´æ–°ç”¨æˆ·ä¿¡æ¯
update_user_profile(user_id: str, update_data: Dict) -> Dict[str, Any]

# ç§¯åˆ†æ“ä½œ
add_user_points(user_id: str, points: int, reason: str) -> Dict[str, Any]
add_user_fragments(user_id: str, fragments: int, reason: str) -> Dict[str, Any]

# ç”¨æˆ·è®¾ç½®ç®¡ç†
get_user_settings(user_id: str) -> Dict[str, Any]
update_user_settings(user_id: str, settings: Dict) -> Dict[str, Any]
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from src.services.user_service import UserService

user_service = UserService()

# è·å–ç”¨æˆ·å®Œæ•´èµ„æ–™
profile = user_service.get_user_profile("user_123")

# æ·»åŠ ç§¯åˆ†å¥–åŠ±
user_service.add_user_points("user_123", 50, "å®Œæˆä¸“æ³¨ä»»åŠ¡")

# æ›´æ–°ç”¨æˆ·è®¾ç½®
user_service.update_user_settings("user_123", {
    "notification_enabled": True,
    "focus_duration": 25
})
```

### TaskService - ä»»åŠ¡æœåŠ¡

**èŒè´£**ï¼šä»»åŠ¡åˆ›å»ºã€ç®¡ç†ã€çŠ¶æ€æ§åˆ¶

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ä»»åŠ¡CRUDæ“ä½œ
- ä»»åŠ¡çŠ¶æ€ç®¡ç†
- å±‚æ¬¡ç»“æ„ç®¡ç†
- ä»»åŠ¡ç»Ÿè®¡å’Œåˆ†æ

**ä¸»è¦æ–¹æ³•**ï¼š
```python
# ä»»åŠ¡ç®¡ç†
create_task(user_id: str, task_data: Dict) -> Dict[str, Any]
get_task(task_id: str, user_id: str) -> Dict[str, Any]
update_task(task_id: str, user_id: str, update_data: Dict) -> Dict[str, Any]
delete_task(task_id: str, user_id: str) -> None

# çŠ¶æ€ç®¡ç†
start_task(task_id: str, user_id: str) -> Dict[str, Any]
complete_task(task_id: str, user_id: str, completion_data: Dict) -> Dict[str, Any]
cancel_task(task_id: str, user_id: str, reason: str) -> Dict[str, Any]

# å±‚æ¬¡ç»“æ„
create_subtask(parent_id: str, user_id: str, subtask_data: Dict) -> Dict[str, Any]
get_task_hierarchy(task_id: str, user_id: str) -> Dict[str, Any]
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from src.services.task_service import TaskService

task_service = TaskService()

# åˆ›å»ºä¸»ä»»åŠ¡
main_task = task_service.create_task("user_123", {
    "title": "å®Œæˆé¡¹ç›®æ–‡æ¡£",
    "description": "ç¼–å†™é¡¹ç›®æŠ€æœ¯æ–‡æ¡£",
    "priority": "high",
    "due_date": "2024-12-31"
})

# åˆ›å»ºå­ä»»åŠ¡
subtask = task_service.create_subtask(main_task["id"], "user_123", {
    "title": "å†™APIæ–‡æ¡£",
    "estimated_hours": 4
})

# å¼€å§‹æ‰§è¡Œä»»åŠ¡
task_service.start_task(main_task["id"], "user_123")
```

### FocusService - ä¸“æ³¨æœåŠ¡

**èŒè´£**ï¼šä¸“æ³¨ä¼šè¯ç®¡ç†ã€ç•ªèŒ„é’Ÿå®ç°

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ä¸“æ³¨ä¼šè¯åˆ›å»ºå’Œç®¡ç†
- ä¼šè¯çŠ¶æ€æ§åˆ¶ï¼ˆå¼€å§‹ã€æš‚åœã€æ¢å¤ã€å®Œæˆï¼‰
- ä¸“æ³¨ç»Ÿè®¡å’Œè¶‹åŠ¿åˆ†æ
- è¿ç»­ä¸“æ³¨å¤©æ•°è®¡ç®—

**ä¸»è¦æ–¹æ³•**ï¼š
```python
# ä¸“æ³¨ä¼šè¯ç®¡ç†
start_focus_session(user_id: str, task_id: str, planned_duration: int) -> Dict[str, Any]
pause_focus_session(session_id: str, user_id: str, reason: str) -> Dict[str, Any]
resume_focus_session(session_id: str, user_id: str) -> Dict[str, Any]
complete_focus_session(session_id: str, user_id: str, feedback: str) -> Dict[str, Any]

# ç»Ÿè®¡æŸ¥è¯¢
get_user_focus_sessions(user_id: str, start_date: str, end_date: str) -> Dict[str, Any]
get_focus_statistics(user_id: str, period: str) -> Dict[str, Any]
get_task_focus_sessions(task_id: str, user_id: str) -> Dict[str, Any]
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from src.services.focus_service import FocusService

focus_service = FocusService()

# å¼€å§‹ä¸“æ³¨ä¼šè¯ï¼ˆ25åˆ†é’Ÿç•ªèŒ„é’Ÿï¼‰
session = focus_service.start_focus_session("user_123", "task_456", 25)

# æš‚åœä¸“æ³¨
focus_service.pause_focus_session(session["id"], "user_123", "ç´§æ€¥æ‰“æ‰°")

# æ¢å¤ä¸“æ³¨
focus_service.resume_focus_session(session["id"], "user_123")

# å®Œæˆä¸“æ³¨å¹¶è·å¾—å¥–åŠ±
result = focus_service.complete_focus_session(
    session["id"],
    "user_123",
    "æ„Ÿè§‰å¾ˆå¥½ï¼Œä¸“æ³¨åº¦å¾ˆé«˜"
)
```

### RewardService - å¥–åŠ±æœåŠ¡

**èŒè´£**ï¼šç§¯åˆ†ç³»ç»Ÿã€ç¢ç‰‡å…‘æ¢ã€æˆå°±ç®¡ç†

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ç§¯åˆ†å’Œç¢ç‰‡ç®¡ç†
- å¥–åŠ±ç›®å½•ç®¡ç†
- å…‘æ¢æ“ä½œ
- æˆå°±ç³»ç»Ÿ

**ä¸»è¦æ–¹æ³•**ï¼š
```python
# å¥–åŠ±ç›®å½•
get_rewards_catalog(category: str, reward_type: str) -> Dict[str, Any]
get_reward_details(reward_id: str) -> Dict[str, Any]

# å…‘æ¢æ“ä½œ
redeem_reward(user_id: str, reward_id: str) -> Dict[str, Any]
get_user_redemptions(user_id: str, status: str) -> Dict[str, Any]

# ç§¯åˆ†æ“ä½œ
add_points(user_id: str, points: int, reason: str) -> Dict[str, Any]
subtract_points(user_id: str, points: int, reason: str) -> Dict[str, Any]
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from src.services.reward_service import RewardService

reward_service = RewardService()

# è·å–å¯ç”¨å¥–åŠ±
catalog = reward_service.get_rewards_catalog(category="virtual", available_only=True)

# å…‘æ¢å¥–åŠ±
redemption = reward_service.redeem_reward("user_123", "reward_456")

# æŸ¥çœ‹å…‘æ¢å†å²
history = reward_service.get_user_redemptions("user_123", "completed")
```

### StatisticsService - ç»Ÿè®¡æœåŠ¡

**èŒè´£**ï¼šç”¨æˆ·è¡Œä¸ºç»Ÿè®¡ã€è¶‹åŠ¿åˆ†æã€æŠ¥å‘Šç”Ÿæˆ

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ç”¨æˆ·ç»¼åˆç»Ÿè®¡
- ç”Ÿäº§åŠ›åˆ†æ
- ä¹ æƒ¯åˆ†æ
- è¶‹åŠ¿é¢„æµ‹

**ä¸»è¦æ–¹æ³•**ï¼š
```python
# ç»¼åˆç»Ÿè®¡
get_user_overview_statistics(user_id: str, days: int) -> Dict[str, Any]
get_productivity_report(user_id: str, period: str) -> Dict[str, Any]

# ä¸“é¡¹ç»Ÿè®¡
get_task_completion_statistics(user_id: str, period: str) -> Dict[str, Any]
get_focus_time_statistics(user_id: str, period: str) -> Dict[str, Any]
get_achievement_statistics(user_id: str) -> Dict[str, Any]

# è¶‹åŠ¿åˆ†æ
get_habit_analysis(user_id: str, habit_type: str) -> Dict[str, Any]
get_productivity_trends(user_id: str, metric: str) -> Dict[str, Any]
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from src.services.statistics_service import StatisticsService

stats_service = StatisticsService()

# è·å–ç”¨æˆ·30å¤©æ¦‚è§ˆ
overview = stats_service.get_user_overview_statistics("user_123", 30)

# è·å–æœˆåº¦ç”Ÿäº§åŠ›æŠ¥å‘Š
productivity = stats_service.get_productivity_report("user_123", "month")

# åˆ†æä¸“æ³¨ä¹ æƒ¯
focus_habits = stats_service.get_habit_analysis("user_123", "focus_time")
```

### ChatService - èŠå¤©æœåŠ¡

**èŒè´£**ï¼šAIå¯¹è¯ç®¡ç†ã€å¤šæ¨¡å¼æ”¯æŒã€è®°å¿†ç³»ç»Ÿ

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- å¤šè½®å¯¹è¯ç®¡ç†
- ä¸åŒèŠå¤©æ¨¡å¼
- AIå“åº”ç”Ÿæˆ
- å¯¹è¯å†å²å’Œè®°å¿†

**ä¸»è¦æ–¹æ³•**ï¼š
```python
# å¯¹è¯ç®¡ç†
create_conversation(user_id: str, title: str, chat_mode: ChatMode) -> Dict[str, Any]
send_message(session_id: str, user_id: str, content: str) -> ChatResponse
get_conversation_history(session_id: str, user_id: str) -> List[Dict]

# æ¨¡å¼æ”¯æŒ
GENERAL = "general"
TASK_ASSISTANT = "task_assistant"
PRODUCTIVITY_COACH = "productivity_coach"
FOCUS_GUIDE = "focus_guide"
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from src.services.chat_service import ChatService, ChatMode

chat_service = ChatService()

# åˆ›å»ºä»»åŠ¡åŠ©æ‰‹å¯¹è¯
conversation = chat_service.create_conversation(
    "user_123",
    "å­¦ä¹ è®¡åˆ’åˆ¶å®š",
    ChatMode.TASK_ASSISTANT
)
session_id = conversation["session_id"]

# å‘é€æ¶ˆæ¯å¹¶è·å¾—AIå›å¤
response = chat_service.send_message(
    session_id,
    "user_123",
    "å¸®æˆ‘åˆ¶å®šä¸€ä¸ªå­¦ä¹ Pythonçš„è®¡åˆ’"
)
```

## âš ï¸ å¼‚å¸¸å¤„ç†

æœåŠ¡å±‚é‡‡ç”¨ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œæ‰€æœ‰ä¸šåŠ¡å¼‚å¸¸éƒ½ç»§æ‰¿è‡ª`BusinessException`ã€‚

### å¼‚å¸¸ç±»å‹

```python
from src.services.exceptions import (
    BusinessException,           # ä¸šåŠ¡å¼‚å¸¸åŸºç±»
    ValidationException,         # éªŒè¯å¼‚å¸¸
    ResourceNotFoundException,   # èµ„æºä¸å­˜åœ¨
    DuplicateResourceException,  # èµ„æºé‡å¤
    AuthenticationException,    # è®¤è¯å¼‚å¸¸
    AuthorizationException,     # æˆæƒå¼‚å¸¸
    InsufficientBalanceException # ä½™é¢ä¸è¶³
)
```

### å¼‚å¸¸å¤„ç†æ¨¡å¼

```python
class MyService(BaseService):
    def my_method(self, user_id: str):
        try:
            # ä¸šåŠ¡é€»è¾‘
            result = self._do_something()

            self._log_operation_success("my_method", result=result)
            return result

        except BusinessException:
            # ä¸šåŠ¡å¼‚å¸¸ç›´æ¥æŠ›å‡º
            raise

        except Exception as e:
            # å…¶ä»–å¼‚å¸¸åŒ…è£…ä¸ºä¸šåŠ¡å¼‚å¸¸
            self._handle_repository_error(e, "my_method")
```

## ğŸ”Œ ä¾èµ–æ³¨å…¥

### Repositoryæ³¨å…¥

æ‰€æœ‰æœåŠ¡éƒ½é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥Repositoryä¾èµ–ï¼š

```python
class UserService(BaseService):
    def __init__(self, user_repo=None, task_repo=None, **kwargs):
        super().__init__(
            user_repo=user_repo,
            task_repo=task_repo,
            **kwargs
        )
```

### ServiceFactory

ä½¿ç”¨`ServiceFactory`å¯ä»¥ç®€åŒ–æœåŠ¡å®ä¾‹åŒ–ï¼š

```python
from src.services.base import ServiceFactory
from src.repositories.user import UserRepository

# åˆ›å»ºRepositoryå®ä¾‹
user_repo = UserRepository(db_session)

# åˆ›å»ºæœåŠ¡å®ä¾‹
user_service = ServiceFactory.create_service(
    UserService,
    user_repo=user_repo
)

# æˆ–ä½¿ç”¨æ•°æ®åº“ä¼šè¯æ‰¹é‡åˆ›å»º
services = ServiceFactory.create_service_with_session(
    UserService,
    db_session
)
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ—¥å¿—è®°å½•

```python
# âœ… å¥½çš„åšæ³•
def create_task(self, user_id: str, task_data: Dict):
    self._log_operation_start("create_task", user_id=user_id)

    try:
        # éªŒè¯ç”¨æˆ·å­˜åœ¨
        user = self._check_resource_exists(
            self.get_user_repository(),
            user_id,
            "ç”¨æˆ·"
        )

        # åˆ›å»ºä»»åŠ¡
        task = self.get_task_repository().create(task_data)

        self._log_operation_success("create_task", task_id=task.id)
        return self._task_to_dict(task)

    except Exception as e:
        self._log_operation_error("create_task", e, user_id=user_id)
        raise

# âŒ é¿å…çš„åšæ³•
def create_task(self, user_id: str, task_data: Dict):
    # æ²¡æœ‰æ—¥å¿—è®°å½•
    task = self.get_task_repository().create(task_data)
    return task
```

### 2. å‚æ•°éªŒè¯

```python
# âœ… ä½¿ç”¨è£…é¥°å™¨
@operation_logger("validate_data", log_args=True)
def validate_required_fields(self, data: Dict, required_fields: List[str]):
    # è‡ªåŠ¨è®°å½•éªŒè¯æ“ä½œ
    pass

# âœ… æ‰‹åŠ¨éªŒè¯
def create_task(self, user_id: str, task_data: Dict):
    # éªŒè¯å¿…å¡«å­—æ®µ
    self.validate_required_fields(task_data, ["title", "description"])

    # éªŒè¯IDæ ¼å¼
    user_id = self._validate_id(user_id, "ç”¨æˆ·")
```

### 3. å¼‚å¸¸å¤„ç†

```python
# âœ… ä½¿ç”¨ä¸“ç”¨å¼‚å¸¸å¤„ç†æ–¹æ³•
def delete_task(self, task_id: str, user_id: str):
    try:
        task = self.get_task_repository().delete(task_id)
        return task
    except Exception as e:
        self._handle_repository_error(e, "delete_task", {
            "task_id": task_id,
            "user_id": user_id
        })

# âŒ ç›´æ¥æŠ›å‡ºåŸå§‹å¼‚å¸¸
def delete_task(self, task_id: str, user_id: str):
    task = self.get_task_repository().delete(task_id)  # å¯èƒ½æŠ›å‡ºæ•°æ®åº“å¼‚å¸¸
    return task
```

### 4. æ€§èƒ½ç›‘æ§

```python
# âœ… ä½¿ç”¨æ€§èƒ½è£…é¥°å™¨
@performance_logger("complex_query")
def generate_monthly_report(self, user_id: str):
    # å¤æ‚çš„æ•°æ®å¤„ç†é€»è¾‘
    pass

# âœ… æ‰‹åŠ¨æ€§èƒ½è®°å½•
def expensive_operation(self):
    start_time = time.time()

    # æ‰§è¡Œæ“ä½œ
    result = self._do_work()

    duration = (time.time() - start_time) * 1000
    self._log_performance("expensive_operation", duration)

    return result
```

## ğŸš€ APIå±‚å¼€å‘æŒ‡å—

### 1. FastAPIé›†æˆç¤ºä¾‹

```python
from fastapi import APIRouter, Depends, HTTPException
from src.services.user_service import UserService
from src.services.base import ServiceFactory

router = APIRouter(prefix="/api/v1/users", tags=["users"])

def get_user_service() -> UserService:
    """ä¾èµ–æ³¨å…¥ï¼šè·å–UserServiceå®ä¾‹"""
    return ServiceFactory.create_service(UserService)

@router.get("/{user_id}/profile")
async def get_user_profile(
    user_id: str,
    user_service: UserService = Depends(get_user_service)
):
    """è·å–ç”¨æˆ·èµ„æ–™"""
    try:
        profile = user_service.get_user_profile(user_id)
        return {"success": True, "data": profile}

    except ResourceNotFoundException as e:
        raise HTTPException(status_code=404, detail=str(e))

    except BusinessException as e:
        raise HTTPException(status_code=400, detail=str(e))

@router.put("/{user_id}/profile")
async def update_user_profile(
    user_id: str,
    profile_data: dict,
    user_service: UserService = Depends(get_user_service)
):
    """æ›´æ–°ç”¨æˆ·èµ„æ–™"""
    try:
        updated_profile = user_service.update_user_profile(user_id, profile_data)
        return {"success": True, "data": updated_profile}

    except ValidationException as e:
        raise HTTPException(status_code=422, detail=str(e))

    except BusinessException as e:
        raise HTTPException(status_code=400, detail=str(e))
```

### 2. é”™è¯¯å¤„ç†ä¸­é—´ä»¶

```python
from fastapi import Request, HTTPException
from fastapi.responses import JSONResponse
from src.services.exceptions import BusinessException

async def business_exception_handler(request: Request, exc: BusinessException):
    """ç»Ÿä¸€å¤„ç†ä¸šåŠ¡å¼‚å¸¸"""
    return JSONResponse(
        status_code=400,
        content={
            "success": False,
            "error": {
                "code": exc.error_code,
                "message": exc.user_message or str(exc),
                "details": exc.details
            }
        }
    )

# åœ¨FastAPIåº”ç”¨ä¸­æ³¨å†Œ
app.add_exception_handler(BusinessException, business_exception_handler)
```

### 3. è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶

```python
import time
import uuid
from fastapi import Request

async def request_logging_middleware(request: Request, call_next):
    """è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶"""
    # ç”Ÿæˆè¯·æ±‚ID
    request_id = str(uuid.uuid4())

    # è®°å½•è¯·æ±‚å¼€å§‹
    start_time = time.time()

    # è®¾ç½®è¯·æ±‚IDåˆ°ä¸Šä¸‹æ–‡
    request.state.request_id = request_id

    # å¤„ç†è¯·æ±‚
    response = await call_next(request)

    # è®¡ç®—å¤„ç†æ—¶é—´
    process_time = (time.time() - start_time) * 1000

    # æ·»åŠ å“åº”å¤´
    response.headers["X-Request-ID"] = request_id
    response.headers["X-Process-Time"] = str(process_time)

    return response
```

### 4. è®¤è¯å’Œæˆæƒ

```python
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer
from src.services.auth_service import AuthService

security = HTTPBearer()

async def get_current_user(
    credentials: str = Depends(security),
    auth_service: AuthService = Depends(get_auth_service)
):
    """è·å–å½“å‰ç”¨æˆ·"""
    try:
        token = credentials.credentials
        payload = auth_service.verify_token(token)
        return payload

    except AuthenticationException:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid authentication credentials",
            headers={"WWW-Authenticate": "Bearer"},
        )

@router.get("/protected-route")
async def protected_route(
    current_user: dict = Depends(get_current_user)
):
    """éœ€è¦è®¤è¯çš„è·¯ç”±"""
    return {"message": f"Hello, {current_user['user_id']}!"}
```

## ğŸ”§ é…ç½®å’Œç¯å¢ƒ

### å¼€å‘ç¯å¢ƒé…ç½®

```bash
# .env.dev
SERVICE_LOG_LEVEL=DEBUG
SERVICE_LOG_PERFORMANCE=true
SERVICE_LOG_CONSOLE=true
SERVICE_LOG_FILE=false

# æ•°æ®åº“é…ç½®
DATABASE_URL=sqlite:///./dev.db

# AIæœåŠ¡é…ç½®
LLM_API_KEY=your_api_key
LLM_BASE_URL=https://api.openai.com/v1
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®

```bash
# .env.prod
SERVICE_LOG_LEVEL=INFO
SERVICE_LOG_PERFORMANCE=true
SERVICE_LOG_CONSOLE=false
SERVICE_LOG_FILE=true
SERVICE_LOG_FILE_PATH=/var/log/tatake/services.log

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://user:pass@localhost:5432/tatake

# AIæœåŠ¡é…ç½®
LLM_API_KEY=${AI_API_KEY}
LLM_BASE_URL=${AI_BASE_URL}
```

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### 1. å¥åº·æ£€æŸ¥ç«¯ç‚¹

```python
@router.get("/health")
async def health_check(
    user_service: UserService = Depends(get_user_service),
    task_service: TaskService = Depends(get_task_service)
):
    """æœåŠ¡å¥åº·æ£€æŸ¥"""
    services = {
        "user_service": user_service._health_check(),
        "task_service": task_service._health_check()
    }

    overall_status = "healthy"
    for service_status in services.values():
        if service_status["status"] != "healthy":
            overall_status = "degraded"
            break

    return {
        "status": overall_status,
        "timestamp": datetime.now().isoformat(),
        "services": services
    }
```

### 2. æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep "level\":\"ERROR" logs/services.log | jq

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
grep "logger\":\"services.UserService" logs/services.log | jq

# æŸ¥çœ‹æ€§èƒ½æ…¢æŸ¥è¯¢
grep "performance_type\":\"timing" logs/services.log | jq 'select(.duration_ms > 1000)'

# æŸ¥çœ‹æ“ä½œå¤±è´¥
grep "operation.*failed" logs/services.log | jq
```

### 3. æ€§èƒ½ç›‘æ§

```python
# è‡ªå®šä¹‰æ€§èƒ½æŒ‡æ ‡
class PerformanceMonitor:
    def __init__(self):
        self.metrics = {}

    def track_operation(self, operation: str, duration: float):
        if operation not in self.metrics:
            self.metrics[operation] = []
        self.metrics[operation].append(duration)

    def get_statistics(self, operation: str) -> dict:
        if operation not in self.metrics:
            return {}

        durations = self.metrics[operation]
        return {
            "count": len(durations),
            "avg": sum(durations) / len(durations),
            "min": min(durations),
            "max": max(durations)
        }
```

## ğŸ“– æ‰©å±•é˜…è¯»

- [Repositoryå±‚æ–‡æ¡£](../repositories/README.md)
- [æ¨¡å‹å±‚æ–‡æ¡£](../models/README.md)
- [å¼‚å¸¸å¤„ç†æŒ‡å—](exceptions.md)
- [æ—¥å¿—ç³»ç»Ÿè¯¦è§£](logging.md)

## ğŸ¤ è´¡çŒ®æŒ‡å—

### æ·»åŠ æ–°æœåŠ¡

1. **ç»§æ‰¿BaseService**
```python
from src.services.base import BaseService

class NewService(BaseService):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
```

2. **å®ç°æ ¸å¿ƒæ–¹æ³•**
```python
@operation_logger("operation_name")
def your_method(self, param: str) -> Dict[str, Any]:
    # éªŒè¯å‚æ•°
    # ä¸šåŠ¡é€»è¾‘
    # å¼‚å¸¸å¤„ç†
    # è¿”å›ç»“æœ
    pass
```

3. **æ·»åŠ æµ‹è¯•**
```python
def test_new_service():
    service = NewService()
    result = service.your_method("test")
    assert result is not None
```

4. **æ›´æ–°æ–‡æ¡£**
- åœ¨æœ¬æ–‡æ¡£ä¸­æ·»åŠ æ–°æœåŠ¡è¯´æ˜
- æ›´æ–°APIå±‚ç¤ºä¾‹
- æ·»åŠ ä½¿ç”¨åœºæ™¯

---

**æœ€åæ›´æ–°**: 2025-10-20
**ç‰ˆæœ¬**: 1.0.0
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ