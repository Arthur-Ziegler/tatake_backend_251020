# 服务层架构文档

## 概述

本文档提供了tatake后端服务层的完整架构说明，包括设计原则、核心组件、使用方法和最佳实践。服务层位于数据访问层（Repository）和API层之间，负责处理业务逻辑、数据验证、权限控制等核心功能。

## 📋 目录

- [架构概览](#架构概览)
- [核心组件](#核心组件)
- [服务类详解](#服务类详解)
- [统一日志系统](#统一日志系统)
- [异常处理](#异常处理)
- [依赖注入](#依赖注入)
- [最佳实践](#最佳实践)
- [API层开发指南](#api层开发指南)

## 🏗️ 架构概览

### 分层架构

```
API层 (FastAPI/Controllers)
    ↓
服务层 (Services) ← 当前文档重点
    ↓
数据访问层 (Repository)
    ↓
模型层 (Models)
```

### 设计原则

1. **单一职责原则** - 每个服务类专注于特定的业务领域
2. **依赖注入** - 通过构造函数注入Repository依赖
3. **统一接口** - 所有服务都继承自BaseService
4. **异常处理** - 统一的异常处理和错误传播机制
5. **日志记录** - 完整的操作日志和性能监控
6. **数据验证** - 严格的输入验证和业务规则检查

### 核心服务类

| 服务类 | 职责 | 主要功能 |
|--------|------|----------|
| `AuthService` | 用户认证 | 游客账号管理、登录、令牌管理 |
| `UserService` | 用户管理 | 用户信息、设置、积分管理 |
| `TaskService` | 任务管理 | 任务CRUD、状态管理、层次结构 |
| `FocusService` | 专注管理 | 专注会话、统计分析、番茄钟 |
| `RewardService` | 奖励管理 | 积分系统、碎片兑换、成就系统 |
| `StatisticsService` | 统计分析 | 用户统计、趋势分析、报告生成 |
| `ChatService` | 聊天服务 | AI对话、多模式支持、记忆管理 |

## 🔧 核心组件

### BaseService 基类

所有服务类都继承自`BaseService`，提供统一的基础功能：

```python
from src.services.base import BaseService

class MyService(BaseService):
    def __init__(self, user_repo=None, **kwargs):
        super().__init__(user_repo=user_repo, **kwargs)
```

#### 核心功能

- **日志记录** - 统一的日志接口和自动记录
- **异常处理** - Repository异常包装和业务异常处理
- **数据验证** - 通用验证方法和参数检查
- **健康检查** - 服务状态和依赖监控
- **工具方法** - 分页、统计、数据转换等

### 统一日志系统

服务层采用结构化JSON日志，支持多级别输出和性能监控。

#### 日志级别

```python
# 基本日志方法
service._log_info("信息日志", extra_data={"key": "value"})
service._log_warning("警告日志")
service._log_error("错误日志", error=exception)

# 操作日志
service._log_operation_start("操作名称", user_id="123")
service._log_operation_success("操作名称", duration_ms=100)
service._log_operation_error("操作名称", exception)
```

#### 环境变量配置

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `SERVICE_LOG_LEVEL` | INFO | 日志级别 (DEBUG/INFO/WARNING/ERROR/CRITICAL) |
| `SERVICE_LOG_FORMAT` | structured | 日志格式 (structured/simple) |
| `SERVICE_LOG_CONSOLE` | true | 控制台输出 |
| `SERVICE_LOG_FILE` | true | 文件输出 |
| `SERVICE_LOG_PERFORMANCE` | false | 性能监控 |

#### 装饰器使用

```python
from src.services.logging_config import operation_logger, performance_logger

class MyService(BaseService):
    @operation_logger("创建任务", log_args=True, log_result=True)
    def create_task(self, task_data):
        # 自动记录操作开始、成功、失败
        pass

    @performance_logger("数据库查询")
    def complex_query(self):
        # 自动记录执行时间
        pass
```

## 📚 服务类详解

### AuthService - 认证服务

**职责**：处理用户认证相关业务逻辑

**核心功能**：
- 游客账号创建和管理
- 用户登录和令牌生成
- 短信验证码管理
- 令牌刷新和验证

**主要方法**：
```python
# 创建游客账号
create_guest_account(device_id: str) -> Dict[str, Any]

# 用户登录
login_with_phone(phone: str, code: str) -> Dict[str, Any]

# 刷新令牌
refresh_token(refresh_token: str) -> Dict[str, Any]

# 验证令牌
verify_token(token: str) -> Dict[str, Any]
```

**使用示例**：
```python
from src.services.auth_service import AuthService

auth_service = AuthService()

# 创建游客账号
guest_result = auth_service.create_guest_account("device_123")
user_id = guest_result["user_id"]

# 登录并获取令牌
login_result = auth_service.login_with_phone("13800138000", "123456")
access_token = login_result["access_token"]
```

### UserService - 用户服务

**职责**：用户信息管理、设置管理、积分系统

**核心功能**：
- 用户基本信息管理
- 用户设置和偏好
- 积分和碎片管理
- 用户行为记录

**主要方法**：
```python
# 获取用户资料
get_user_profile(user_id: str) -> Dict[str, Any]

# 更新用户信息
update_user_profile(user_id: str, update_data: Dict) -> Dict[str, Any]

# 积分操作
add_user_points(user_id: str, points: int, reason: str) -> Dict[str, Any]
add_user_fragments(user_id: str, fragments: int, reason: str) -> Dict[str, Any]

# 用户设置管理
get_user_settings(user_id: str) -> Dict[str, Any]
update_user_settings(user_id: str, settings: Dict) -> Dict[str, Any]
```

**使用示例**：
```python
from src.services.user_service import UserService

user_service = UserService()

# 获取用户完整资料
profile = user_service.get_user_profile("user_123")

# 添加积分奖励
user_service.add_user_points("user_123", 50, "完成专注任务")

# 更新用户设置
user_service.update_user_settings("user_123", {
    "notification_enabled": True,
    "focus_duration": 25
})
```

### TaskService - 任务服务

**职责**：任务创建、管理、状态控制

**核心功能**：
- 任务CRUD操作
- 任务状态管理
- 层次结构管理
- 任务统计和分析

**主要方法**：
```python
# 任务管理
create_task(user_id: str, task_data: Dict) -> Dict[str, Any]
get_task(task_id: str, user_id: str) -> Dict[str, Any]
update_task(task_id: str, user_id: str, update_data: Dict) -> Dict[str, Any]
delete_task(task_id: str, user_id: str) -> None

# 状态管理
start_task(task_id: str, user_id: str) -> Dict[str, Any]
complete_task(task_id: str, user_id: str, completion_data: Dict) -> Dict[str, Any]
cancel_task(task_id: str, user_id: str, reason: str) -> Dict[str, Any]

# 层次结构
create_subtask(parent_id: str, user_id: str, subtask_data: Dict) -> Dict[str, Any]
get_task_hierarchy(task_id: str, user_id: str) -> Dict[str, Any]
```

**使用示例**：
```python
from src.services.task_service import TaskService

task_service = TaskService()

# 创建主任务
main_task = task_service.create_task("user_123", {
    "title": "完成项目文档",
    "description": "编写项目技术文档",
    "priority": "high",
    "due_date": "2024-12-31"
})

# 创建子任务
subtask = task_service.create_subtask(main_task["id"], "user_123", {
    "title": "写API文档",
    "estimated_hours": 4
})

# 开始执行任务
task_service.start_task(main_task["id"], "user_123")
```

### FocusService - 专注服务

**职责**：专注会话管理、番茄钟实现

**核心功能**：
- 专注会话创建和管理
- 会话状态控制（开始、暂停、恢复、完成）
- 专注统计和趋势分析
- 连续专注天数计算

**主要方法**：
```python
# 专注会话管理
start_focus_session(user_id: str, task_id: str, planned_duration: int) -> Dict[str, Any]
pause_focus_session(session_id: str, user_id: str, reason: str) -> Dict[str, Any]
resume_focus_session(session_id: str, user_id: str) -> Dict[str, Any]
complete_focus_session(session_id: str, user_id: str, feedback: str) -> Dict[str, Any]

# 统计查询
get_user_focus_sessions(user_id: str, start_date: str, end_date: str) -> Dict[str, Any]
get_focus_statistics(user_id: str, period: str) -> Dict[str, Any]
get_task_focus_sessions(task_id: str, user_id: str) -> Dict[str, Any]
```

**使用示例**：
```python
from src.services.focus_service import FocusService

focus_service = FocusService()

# 开始专注会话（25分钟番茄钟）
session = focus_service.start_focus_session("user_123", "task_456", 25)

# 暂停专注
focus_service.pause_focus_session(session["id"], "user_123", "紧急打扰")

# 恢复专注
focus_service.resume_focus_session(session["id"], "user_123")

# 完成专注并获得奖励
result = focus_service.complete_focus_session(
    session["id"],
    "user_123",
    "感觉很好，专注度很高"
)
```

### RewardService - 奖励服务

**职责**：积分系统、碎片兑换、成就管理

**核心功能**：
- 积分和碎片管理
- 奖励目录管理
- 兑换操作
- 成就系统

**主要方法**：
```python
# 奖励目录
get_rewards_catalog(category: str, reward_type: str) -> Dict[str, Any]
get_reward_details(reward_id: str) -> Dict[str, Any]

# 兑换操作
redeem_reward(user_id: str, reward_id: str) -> Dict[str, Any]
get_user_redemptions(user_id: str, status: str) -> Dict[str, Any]

# 积分操作
add_points(user_id: str, points: int, reason: str) -> Dict[str, Any]
subtract_points(user_id: str, points: int, reason: str) -> Dict[str, Any]
```

**使用示例**：
```python
from src.services.reward_service import RewardService

reward_service = RewardService()

# 获取可用奖励
catalog = reward_service.get_rewards_catalog(category="virtual", available_only=True)

# 兑换奖励
redemption = reward_service.redeem_reward("user_123", "reward_456")

# 查看兑换历史
history = reward_service.get_user_redemptions("user_123", "completed")
```

### StatisticsService - 统计服务

**职责**：用户行为统计、趋势分析、报告生成

**核心功能**：
- 用户综合统计
- 生产力分析
- 习惯分析
- 趋势预测

**主要方法**：
```python
# 综合统计
get_user_overview_statistics(user_id: str, days: int) -> Dict[str, Any]
get_productivity_report(user_id: str, period: str) -> Dict[str, Any]

# 专项统计
get_task_completion_statistics(user_id: str, period: str) -> Dict[str, Any]
get_focus_time_statistics(user_id: str, period: str) -> Dict[str, Any]
get_achievement_statistics(user_id: str) -> Dict[str, Any]

# 趋势分析
get_habit_analysis(user_id: str, habit_type: str) -> Dict[str, Any]
get_productivity_trends(user_id: str, metric: str) -> Dict[str, Any]
```

**使用示例**：
```python
from src.services.statistics_service import StatisticsService

stats_service = StatisticsService()

# 获取用户30天概览
overview = stats_service.get_user_overview_statistics("user_123", 30)

# 获取月度生产力报告
productivity = stats_service.get_productivity_report("user_123", "month")

# 分析专注习惯
focus_habits = stats_service.get_habit_analysis("user_123", "focus_time")
```

### ChatService - 聊天服务

**职责**：AI对话管理、多模式支持、记忆系统

**核心功能**：
- 多轮对话管理
- 不同聊天模式
- AI响应生成
- 对话历史和记忆

**主要方法**：
```python
# 对话管理
create_conversation(user_id: str, title: str, chat_mode: ChatMode) -> Dict[str, Any]
send_message(session_id: str, user_id: str, content: str) -> ChatResponse
get_conversation_history(session_id: str, user_id: str) -> List[Dict]

# 模式支持
GENERAL = "general"
TASK_ASSISTANT = "task_assistant"
PRODUCTIVITY_COACH = "productivity_coach"
FOCUS_GUIDE = "focus_guide"
```

**使用示例**：
```python
from src.services.chat_service import ChatService, ChatMode

chat_service = ChatService()

# 创建任务助手对话
conversation = chat_service.create_conversation(
    "user_123",
    "学习计划制定",
    ChatMode.TASK_ASSISTANT
)
session_id = conversation["session_id"]

# 发送消息并获得AI回复
response = chat_service.send_message(
    session_id,
    "user_123",
    "帮我制定一个学习Python的计划"
)
```

## ⚠️ 异常处理

服务层采用统一的异常处理机制，所有业务异常都继承自`BusinessException`。

### 异常类型

```python
from src.services.exceptions import (
    BusinessException,           # 业务异常基类
    ValidationException,         # 验证异常
    ResourceNotFoundException,   # 资源不存在
    DuplicateResourceException,  # 资源重复
    AuthenticationException,    # 认证异常
    AuthorizationException,     # 授权异常
    InsufficientBalanceException # 余额不足
)
```

### 异常处理模式

```python
class MyService(BaseService):
    def my_method(self, user_id: str):
        try:
            # 业务逻辑
            result = self._do_something()

            self._log_operation_success("my_method", result=result)
            return result

        except BusinessException:
            # 业务异常直接抛出
            raise

        except Exception as e:
            # 其他异常包装为业务异常
            self._handle_repository_error(e, "my_method")
```

## 🔌 依赖注入

### Repository注入

所有服务都通过构造函数注入Repository依赖：

```python
class UserService(BaseService):
    def __init__(self, user_repo=None, task_repo=None, **kwargs):
        super().__init__(
            user_repo=user_repo,
            task_repo=task_repo,
            **kwargs
        )
```

### ServiceFactory

使用`ServiceFactory`可以简化服务实例化：

```python
from src.services.base import ServiceFactory
from src.repositories.user import UserRepository

# 创建Repository实例
user_repo = UserRepository(db_session)

# 创建服务实例
user_service = ServiceFactory.create_service(
    UserService,
    user_repo=user_repo
)

# 或使用数据库会话批量创建
services = ServiceFactory.create_service_with_session(
    UserService,
    db_session
)
```

## 📝 最佳实践

### 1. 日志记录

```python
# ✅ 好的做法
def create_task(self, user_id: str, task_data: Dict):
    self._log_operation_start("create_task", user_id=user_id)

    try:
        # 验证用户存在
        user = self._check_resource_exists(
            self.get_user_repository(),
            user_id,
            "用户"
        )

        # 创建任务
        task = self.get_task_repository().create(task_data)

        self._log_operation_success("create_task", task_id=task.id)
        return self._task_to_dict(task)

    except Exception as e:
        self._log_operation_error("create_task", e, user_id=user_id)
        raise

# ❌ 避免的做法
def create_task(self, user_id: str, task_data: Dict):
    # 没有日志记录
    task = self.get_task_repository().create(task_data)
    return task
```

### 2. 参数验证

```python
# ✅ 使用装饰器
@operation_logger("validate_data", log_args=True)
def validate_required_fields(self, data: Dict, required_fields: List[str]):
    # 自动记录验证操作
    pass

# ✅ 手动验证
def create_task(self, user_id: str, task_data: Dict):
    # 验证必填字段
    self.validate_required_fields(task_data, ["title", "description"])

    # 验证ID格式
    user_id = self._validate_id(user_id, "用户")
```

### 3. 异常处理

```python
# ✅ 使用专用异常处理方法
def delete_task(self, task_id: str, user_id: str):
    try:
        task = self.get_task_repository().delete(task_id)
        return task
    except Exception as e:
        self._handle_repository_error(e, "delete_task", {
            "task_id": task_id,
            "user_id": user_id
        })

# ❌ 直接抛出原始异常
def delete_task(self, task_id: str, user_id: str):
    task = self.get_task_repository().delete(task_id)  # 可能抛出数据库异常
    return task
```

### 4. 性能监控

```python
# ✅ 使用性能装饰器
@performance_logger("complex_query")
def generate_monthly_report(self, user_id: str):
    # 复杂的数据处理逻辑
    pass

# ✅ 手动性能记录
def expensive_operation(self):
    start_time = time.time()

    # 执行操作
    result = self._do_work()

    duration = (time.time() - start_time) * 1000
    self._log_performance("expensive_operation", duration)

    return result
```

## 🚀 API层开发指南

### 1. FastAPI集成示例

```python
from fastapi import APIRouter, Depends, HTTPException
from src.services.user_service import UserService
from src.services.base import ServiceFactory

router = APIRouter(prefix="/api/v1/users", tags=["users"])

def get_user_service() -> UserService:
    """依赖注入：获取UserService实例"""
    return ServiceFactory.create_service(UserService)

@router.get("/{user_id}/profile")
async def get_user_profile(
    user_id: str,
    user_service: UserService = Depends(get_user_service)
):
    """获取用户资料"""
    try:
        profile = user_service.get_user_profile(user_id)
        return {"success": True, "data": profile}

    except ResourceNotFoundException as e:
        raise HTTPException(status_code=404, detail=str(e))

    except BusinessException as e:
        raise HTTPException(status_code=400, detail=str(e))

@router.put("/{user_id}/profile")
async def update_user_profile(
    user_id: str,
    profile_data: dict,
    user_service: UserService = Depends(get_user_service)
):
    """更新用户资料"""
    try:
        updated_profile = user_service.update_user_profile(user_id, profile_data)
        return {"success": True, "data": updated_profile}

    except ValidationException as e:
        raise HTTPException(status_code=422, detail=str(e))

    except BusinessException as e:
        raise HTTPException(status_code=400, detail=str(e))
```

### 2. 错误处理中间件

```python
from fastapi import Request, HTTPException
from fastapi.responses import JSONResponse
from src.services.exceptions import BusinessException

async def business_exception_handler(request: Request, exc: BusinessException):
    """统一处理业务异常"""
    return JSONResponse(
        status_code=400,
        content={
            "success": False,
            "error": {
                "code": exc.error_code,
                "message": exc.user_message or str(exc),
                "details": exc.details
            }
        }
    )

# 在FastAPI应用中注册
app.add_exception_handler(BusinessException, business_exception_handler)
```

### 3. 请求日志中间件

```python
import time
import uuid
from fastapi import Request

async def request_logging_middleware(request: Request, call_next):
    """请求日志中间件"""
    # 生成请求ID
    request_id = str(uuid.uuid4())

    # 记录请求开始
    start_time = time.time()

    # 设置请求ID到上下文
    request.state.request_id = request_id

    # 处理请求
    response = await call_next(request)

    # 计算处理时间
    process_time = (time.time() - start_time) * 1000

    # 添加响应头
    response.headers["X-Request-ID"] = request_id
    response.headers["X-Process-Time"] = str(process_time)

    return response
```

### 4. 认证和授权

```python
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer
from src.services.auth_service import AuthService

security = HTTPBearer()

async def get_current_user(
    credentials: str = Depends(security),
    auth_service: AuthService = Depends(get_auth_service)
):
    """获取当前用户"""
    try:
        token = credentials.credentials
        payload = auth_service.verify_token(token)
        return payload

    except AuthenticationException:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid authentication credentials",
            headers={"WWW-Authenticate": "Bearer"},
        )

@router.get("/protected-route")
async def protected_route(
    current_user: dict = Depends(get_current_user)
):
    """需要认证的路由"""
    return {"message": f"Hello, {current_user['user_id']}!"}
```

## 🔧 配置和环境

### 开发环境配置

```bash
# .env.dev
SERVICE_LOG_LEVEL=DEBUG
SERVICE_LOG_PERFORMANCE=true
SERVICE_LOG_CONSOLE=true
SERVICE_LOG_FILE=false

# 数据库配置
DATABASE_URL=sqlite:///./dev.db

# AI服务配置
LLM_API_KEY=your_api_key
LLM_BASE_URL=https://api.openai.com/v1
```

### 生产环境配置

```bash
# .env.prod
SERVICE_LOG_LEVEL=INFO
SERVICE_LOG_PERFORMANCE=true
SERVICE_LOG_CONSOLE=false
SERVICE_LOG_FILE=true
SERVICE_LOG_FILE_PATH=/var/log/tatake/services.log

# 数据库配置
DATABASE_URL=postgresql://user:pass@localhost:5432/tatake

# AI服务配置
LLM_API_KEY=${AI_API_KEY}
LLM_BASE_URL=${AI_BASE_URL}
```

## 📊 监控和调试

### 1. 健康检查端点

```python
@router.get("/health")
async def health_check(
    user_service: UserService = Depends(get_user_service),
    task_service: TaskService = Depends(get_task_service)
):
    """服务健康检查"""
    services = {
        "user_service": user_service._health_check(),
        "task_service": task_service._health_check()
    }

    overall_status = "healthy"
    for service_status in services.values():
        if service_status["status"] != "healthy":
            overall_status = "degraded"
            break

    return {
        "status": overall_status,
        "timestamp": datetime.now().isoformat(),
        "services": services
    }
```

### 2. 日志分析

```bash
# 查看错误日志
grep "level\":\"ERROR" logs/services.log | jq

# 查看特定服务日志
grep "logger\":\"services.UserService" logs/services.log | jq

# 查看性能慢查询
grep "performance_type\":\"timing" logs/services.log | jq 'select(.duration_ms > 1000)'

# 查看操作失败
grep "operation.*failed" logs/services.log | jq
```

### 3. 性能监控

```python
# 自定义性能指标
class PerformanceMonitor:
    def __init__(self):
        self.metrics = {}

    def track_operation(self, operation: str, duration: float):
        if operation not in self.metrics:
            self.metrics[operation] = []
        self.metrics[operation].append(duration)

    def get_statistics(self, operation: str) -> dict:
        if operation not in self.metrics:
            return {}

        durations = self.metrics[operation]
        return {
            "count": len(durations),
            "avg": sum(durations) / len(durations),
            "min": min(durations),
            "max": max(durations)
        }
```

## 📖 扩展阅读

- [Repository层文档](../repositories/README.md)
- [模型层文档](../models/README.md)
- [异常处理指南](exceptions.md)
- [日志系统详解](logging.md)

## 🤝 贡献指南

### 添加新服务

1. **继承BaseService**
```python
from src.services.base import BaseService

class NewService(BaseService):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
```

2. **实现核心方法**
```python
@operation_logger("operation_name")
def your_method(self, param: str) -> Dict[str, Any]:
    # 验证参数
    # 业务逻辑
    # 异常处理
    # 返回结果
    pass
```

3. **添加测试**
```python
def test_new_service():
    service = NewService()
    result = service.your_method("test")
    assert result is not None
```

4. **更新文档**
- 在本文档中添加新服务说明
- 更新API层示例
- 添加使用场景

---

**最后更新**: 2025-10-20
**版本**: 1.0.0
**维护者**: 开发团队