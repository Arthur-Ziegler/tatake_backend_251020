# 数据层接口快速参考

## 🔥 常用接口速查

### 👤 用户系统 (UserRepository)

```python
# 创建用户
user = user_repo.create({
    "email": "user@example.com",
    "nickname": "用户名",
    "password_hash": "hashed_password",
    "user_type": "registered"  # 或 "guest"
})

# 查询用户
user = user_repo.find_by_email("user@example.com")
user = user_repo.find_by_phone("13800138000")
users = user_repo.find_registered_users()

# 验证
exists = user_repo.email_exists("email@example.com")

# 用户管理
guest = user_repo.create_guest_user("临时用户")
user = user_repo.upgrade_guest_to_registered(user_id, **data)
```

### 📋 任务系统 (TaskRepository)

```python
# 创建任务
task = task_repo.create({
    "user_id": "user_id",
    "title": "任务标题",
    "description": "任务描述",
    "status": TaskStatus.PENDING,
    "priority": PriorityLevel.MEDIUM,
    "parent_id": "parent_id"  # 可选
})

# 查询任务
tasks = task_repo.find_by_status(TaskStatus.PENDING)
tasks = task_repo.find_by_priority(PriorityLevel.HIGH)
tasks = task_repo.find_due_tasks(days=7)

# 任务管理
task = task_repo.complete_task("task_id")
task = task_repo.archive_task("task_id")

# 层次结构
hierarchy = task_repo.get_task_hierarchy("task_id")
root_tasks = task_repo.get_root_tasks("user_id")

# TOP3任务
top3 = task_repo.get_daily_top3("user_id")
top3 = task_repo.set_daily_top3("user_id", ["id1", "id2", "id3"])
```

### 🎯 专注系统 (FocusRepository)

```python
# 开始专注会话
session = focus_repo.start_focus_session(
    user_id="user_id",
    duration_minutes=25,
    task_id="task_id"  # 可选
)

# 查询会话
sessions = focus_repo.find_active_sessions("user_id")
sessions = focus_repo.find_completed_sessions("user_id")
sessions = focus_repo.find_user_today_sessions("user_id")

# 会话管理
session = focus_repo.complete_session("session_id")
session = focus_repo.pause_session("session_id")
session = focus_repo.resume_session("session_id")

# 统计数据
stats = focus_repo.get_user_focus_statistics("user_id")
daily = focus_repo.get_daily_focus_summary("user_id", days=7)

# 模板
template = focus_repo.create_template("user_id", "模板名", 25, 5)
templates = focus_repo.find_user_templates("user_id")
```

### 🏆 奖励系统 (RewardRepository)

```python
# 查询奖励
rewards = reward_repo.find_available_rewards()
rewards = reward_repo.find_by_reward_type(RewardType.BADGE)

# 兑换奖励
can_redeem = reward_repo.validate_user_balance("user_id", 50)
transaction = reward_repo.redeem_reward("user_id", "reward_id")

# 碎片管理
balance = reward_repo.get_user_fragment_balance("user_id")
transaction = reward_repo.award_fragments("user_id", 10, "奖励原因")

# 抽奖
record = reward_repo.draw_lottery("user_id", 20)

# 积分统计
summary = reward_repo.get_user_points_summary("user_id", days=30)
history = reward_repo.get_user_points_history("user_id")
```

## ⚡ 标准操作模式

### 基础CRUD操作

```python
# 创建
obj = repo.create(data)

# 查询
obj = repo.get_by_id("id")
objs = repo.get_all(field=value)

# 更新
obj = repo.update("id", {"field": "new_value"})

# 删除
success = repo.delete("id")

# 检查存在
exists = repo.exists(field=value)

# 计数
count = repo.count(field=value)
```

### 会话管理模式

```python
from src.database.connection import DatabaseConnection

db = DatabaseConnection()

# 推荐方式：上下文管理器
with db.get_session() as session:
    user_repo = UserRepository(session)
    # 执行操作...
    # 自动提交和关闭

# 或者手动管理
session = db.get_session()
try:
    user_repo = UserRepository(session)
    # 执行操作...
    session.commit()
except Exception:
    session.rollback()
    raise
finally:
    session.close()
```

### 异常处理模式

```python
from src.repositories.base import (
    RepositoryError,
    RepositoryValidationError,
    RepositoryNotFoundError
)

try:
    # Repository操作
    result = user_repo.find_by_email("user@example.com")
except RepositoryNotFoundError:
    # 处理未找到
    print("用户不存在")
except RepositoryValidationError:
    # 处理参数验证失败
    print("参数错误")
except RepositoryError as e:
    # 处理其他数据库错误
    print(f"数据库错误: {e}")
```

## 🎨 枚举值速查

### 任务状态 (TaskStatus)
```python
TaskStatus.PENDING      # 待处理
TaskStatus.IN_PROGRESS   # 进行中
TaskStatus.COMPLETED     # 已完成
TaskStatus.CANCELLED     # 已取消
TaskStatus.ARCHIVED      # 已归档
```

### 优先级 (PriorityLevel)
```python
PriorityLevel.LOW        # 低优先级
PriorityLevel.MEDIUM     # 中优先级
PriorityLevel.HIGH       # 高优先级
PriorityLevel.URGENT     # 紧急
```

### 会话类型 (SessionType)
```python
SessionType.FOCUS        # 专注会话
SessionType.BREAK        # 休息会话
SessionType.MEETING      # 会议会话
SessionType.LEARNING     # 学习会话
```

### 奖励类型 (RewardType)
```python
RewardType.BADGE         # 徽章
RewardType.ITEM          # 道具
RewardType.TITLE         # 称号
RewardType.AVATAR        # 头像
```

### 交易类型 (TransactionType)
```python
TransactionType.EARN      # 收入
TransactionType.SPEND     # 支出
TransactionType.REFUND    # 退款
TransactionType.BONUS     # 奖励
```

## 📋 常见业务场景

### 用户注册流程
```python
def register_user(email: str, nickname: str, password: str):
    with db.get_session() as session:
        user_repo = UserRepository(session)

        # 检查邮箱是否已存在
        if user_repo.email_exists(email):
            raise ValueError("邮箱已被使用")

        # 创建用户
        user = user_repo.create({
            "email": email,
            "nickname": nickname,
            "password_hash": hash_password(password),
            "user_type": "registered"
        })

        return user
```

### 完成任务奖励
```python
def complete_task_with_reward(user_id: str, task_id: str):
    with db.get_session() as session:
        task_repo = TaskRepository(session)
        reward_repo = RewardRepository(session)

        # 完成任务
        task = task_repo.complete_task(task_id)

        # 计算奖励碎片
        fragments = calculate_fragments(task.priority)

        # 奖励碎片
        reward_repo.award_fragments(
            user_id=user_id,
            amount=fragments,
            reason=f"完成任务: {task.title}"
        )

        return task, fragments
```

### 开始专注会话
```python
def start_focus_session(user_id: str, duration: int, task_id: str = None):
    with db.get_session() as session:
        focus_repo = FocusRepository(session)

        # 检查是否有正在进行的会话
        active_sessions = focus_repo.find_active_sessions(user_id)
        if active_sessions:
            raise ValueError("已有正在进行的专注会话")

        # 开始新会话
        session = focus_repo.start_focus_session(
            user_id=user_id,
            duration_minutes=duration,
            task_id=task_id
        )

        return session
```

## 🔍 调试技巧

### 查看SQL语句
```python
# 在数据库连接中启用SQL日志
db = DatabaseConnection(echo=True)  # 会打印所有SQL语句
```

### 检查数据状态
```python
# 查询用户的所有任务
tasks = task_repo.find_by_user(user_id)
for task in tasks:
    print(f"任务: {task.title} - 状态: {task.status}")

# 查询用户的专注统计
stats = focus_repo.get_user_focus_statistics(user_id)
print(f"总专注: {stats['total_focus_minutes']}分钟")
print(f"完成率: {stats['completion_rate']:.2%}")
```

### 测试Repository方法
```python
# 在Python REPL中测试
>>> from src.database.connection import DatabaseConnection
>>> from src.repositories import UserRepository
>>>
>>> db = DatabaseConnection()
>>> with db.get_session() as session:
...     user_repo = UserRepository(session)
...     users = user_repo.find_registered_users()
...     print(f"找到 {len(users)} 个注册用户")
```

## 📝 性能提示

- ✅ 使用具体的查询方法而不是 `get_all()` 后过滤
- ✅ 在单个会话中完成相关的多个操作
- ✅ 使用索引字段（如 `email`, `user_id`）进行查询
- ✅ 合理使用分页避免一次加载大量数据
- ❌ 避免在循环中创建多个数据库会话
- ❌ 避免忽略Repository抛出的异常

---

💡 **提示**: 本快速参考配合《数据层接口使用手册》一起使用效果最佳！