# æ•°æ®å±‚æ¥å£å¿«é€Ÿå‚è€ƒ

## ğŸ”¥ å¸¸ç”¨æ¥å£é€ŸæŸ¥

### ğŸ‘¤ ç”¨æˆ·ç³»ç»Ÿ (UserRepository)

```python
# åˆ›å»ºç”¨æˆ·
user = user_repo.create({
    "email": "user@example.com",
    "nickname": "ç”¨æˆ·å",
    "password_hash": "hashed_password",
    "user_type": "registered"  # æˆ– "guest"
})

# æŸ¥è¯¢ç”¨æˆ·
user = user_repo.find_by_email("user@example.com")
user = user_repo.find_by_phone("13800138000")
users = user_repo.find_registered_users()

# éªŒè¯
exists = user_repo.email_exists("email@example.com")

# ç”¨æˆ·ç®¡ç†
guest = user_repo.create_guest_user("ä¸´æ—¶ç”¨æˆ·")
user = user_repo.upgrade_guest_to_registered(user_id, **data)
```

### ğŸ“‹ ä»»åŠ¡ç³»ç»Ÿ (TaskRepository)

```python
# åˆ›å»ºä»»åŠ¡
task = task_repo.create({
    "user_id": "user_id",
    "title": "ä»»åŠ¡æ ‡é¢˜",
    "description": "ä»»åŠ¡æè¿°",
    "status": TaskStatus.PENDING,
    "priority": PriorityLevel.MEDIUM,
    "parent_id": "parent_id"  # å¯é€‰
})

# æŸ¥è¯¢ä»»åŠ¡
tasks = task_repo.find_by_status(TaskStatus.PENDING)
tasks = task_repo.find_by_priority(PriorityLevel.HIGH)
tasks = task_repo.find_due_tasks(days=7)

# ä»»åŠ¡ç®¡ç†
task = task_repo.complete_task("task_id")
task = task_repo.archive_task("task_id")

# å±‚æ¬¡ç»“æ„
hierarchy = task_repo.get_task_hierarchy("task_id")
root_tasks = task_repo.get_root_tasks("user_id")

# TOP3ä»»åŠ¡
top3 = task_repo.get_daily_top3("user_id")
top3 = task_repo.set_daily_top3("user_id", ["id1", "id2", "id3"])
```

### ğŸ¯ ä¸“æ³¨ç³»ç»Ÿ (FocusRepository)

```python
# å¼€å§‹ä¸“æ³¨ä¼šè¯
session = focus_repo.start_focus_session(
    user_id="user_id",
    duration_minutes=25,
    task_id="task_id"  # å¯é€‰
)

# æŸ¥è¯¢ä¼šè¯
sessions = focus_repo.find_active_sessions("user_id")
sessions = focus_repo.find_completed_sessions("user_id")
sessions = focus_repo.find_user_today_sessions("user_id")

# ä¼šè¯ç®¡ç†
session = focus_repo.complete_session("session_id")
session = focus_repo.pause_session("session_id")
session = focus_repo.resume_session("session_id")

# ç»Ÿè®¡æ•°æ®
stats = focus_repo.get_user_focus_statistics("user_id")
daily = focus_repo.get_daily_focus_summary("user_id", days=7)

# æ¨¡æ¿
template = focus_repo.create_template("user_id", "æ¨¡æ¿å", 25, 5)
templates = focus_repo.find_user_templates("user_id")
```

### ğŸ† å¥–åŠ±ç³»ç»Ÿ (RewardRepository)

```python
# æŸ¥è¯¢å¥–åŠ±
rewards = reward_repo.find_available_rewards()
rewards = reward_repo.find_by_reward_type(RewardType.BADGE)

# å…‘æ¢å¥–åŠ±
can_redeem = reward_repo.validate_user_balance("user_id", 50)
transaction = reward_repo.redeem_reward("user_id", "reward_id")

# ç¢ç‰‡ç®¡ç†
balance = reward_repo.get_user_fragment_balance("user_id")
transaction = reward_repo.award_fragments("user_id", 10, "å¥–åŠ±åŸå› ")

# æŠ½å¥–
record = reward_repo.draw_lottery("user_id", 20)

# ç§¯åˆ†ç»Ÿè®¡
summary = reward_repo.get_user_points_summary("user_id", days=30)
history = reward_repo.get_user_points_history("user_id")
```

## âš¡ æ ‡å‡†æ“ä½œæ¨¡å¼

### åŸºç¡€CRUDæ“ä½œ

```python
# åˆ›å»º
obj = repo.create(data)

# æŸ¥è¯¢
obj = repo.get_by_id("id")
objs = repo.get_all(field=value)

# æ›´æ–°
obj = repo.update("id", {"field": "new_value"})

# åˆ é™¤
success = repo.delete("id")

# æ£€æŸ¥å­˜åœ¨
exists = repo.exists(field=value)

# è®¡æ•°
count = repo.count(field=value)
```

### ä¼šè¯ç®¡ç†æ¨¡å¼

```python
from src.database.connection import DatabaseConnection

db = DatabaseConnection()

# æ¨èæ–¹å¼ï¼šä¸Šä¸‹æ–‡ç®¡ç†å™¨
with db.get_session() as session:
    user_repo = UserRepository(session)
    # æ‰§è¡Œæ“ä½œ...
    # è‡ªåŠ¨æäº¤å’Œå…³é—­

# æˆ–è€…æ‰‹åŠ¨ç®¡ç†
session = db.get_session()
try:
    user_repo = UserRepository(session)
    # æ‰§è¡Œæ“ä½œ...
    session.commit()
except Exception:
    session.rollback()
    raise
finally:
    session.close()
```

### å¼‚å¸¸å¤„ç†æ¨¡å¼

```python
from src.repositories.base import (
    RepositoryError,
    RepositoryValidationError,
    RepositoryNotFoundError
)

try:
    # Repositoryæ“ä½œ
    result = user_repo.find_by_email("user@example.com")
except RepositoryNotFoundError:
    # å¤„ç†æœªæ‰¾åˆ°
    print("ç”¨æˆ·ä¸å­˜åœ¨")
except RepositoryValidationError:
    # å¤„ç†å‚æ•°éªŒè¯å¤±è´¥
    print("å‚æ•°é”™è¯¯")
except RepositoryError as e:
    # å¤„ç†å…¶ä»–æ•°æ®åº“é”™è¯¯
    print(f"æ•°æ®åº“é”™è¯¯: {e}")
```

## ğŸ¨ æšä¸¾å€¼é€ŸæŸ¥

### ä»»åŠ¡çŠ¶æ€ (TaskStatus)
```python
TaskStatus.PENDING      # å¾…å¤„ç†
TaskStatus.IN_PROGRESS   # è¿›è¡Œä¸­
TaskStatus.COMPLETED     # å·²å®Œæˆ
TaskStatus.CANCELLED     # å·²å–æ¶ˆ
TaskStatus.ARCHIVED      # å·²å½’æ¡£
```

### ä¼˜å…ˆçº§ (PriorityLevel)
```python
PriorityLevel.LOW        # ä½ä¼˜å…ˆçº§
PriorityLevel.MEDIUM     # ä¸­ä¼˜å…ˆçº§
PriorityLevel.HIGH       # é«˜ä¼˜å…ˆçº§
PriorityLevel.URGENT     # ç´§æ€¥
```

### ä¼šè¯ç±»å‹ (SessionType)
```python
SessionType.FOCUS        # ä¸“æ³¨ä¼šè¯
SessionType.BREAK        # ä¼‘æ¯ä¼šè¯
SessionType.MEETING      # ä¼šè®®ä¼šè¯
SessionType.LEARNING     # å­¦ä¹ ä¼šè¯
```

### å¥–åŠ±ç±»å‹ (RewardType)
```python
RewardType.BADGE         # å¾½ç« 
RewardType.ITEM          # é“å…·
RewardType.TITLE         # ç§°å·
RewardType.AVATAR        # å¤´åƒ
```

### äº¤æ˜“ç±»å‹ (TransactionType)
```python
TransactionType.EARN      # æ”¶å…¥
TransactionType.SPEND     # æ”¯å‡º
TransactionType.REFUND    # é€€æ¬¾
TransactionType.BONUS     # å¥–åŠ±
```

## ğŸ“‹ å¸¸è§ä¸šåŠ¡åœºæ™¯

### ç”¨æˆ·æ³¨å†Œæµç¨‹
```python
def register_user(email: str, nickname: str, password: str):
    with db.get_session() as session:
        user_repo = UserRepository(session)

        # æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
        if user_repo.email_exists(email):
            raise ValueError("é‚®ç®±å·²è¢«ä½¿ç”¨")

        # åˆ›å»ºç”¨æˆ·
        user = user_repo.create({
            "email": email,
            "nickname": nickname,
            "password_hash": hash_password(password),
            "user_type": "registered"
        })

        return user
```

### å®Œæˆä»»åŠ¡å¥–åŠ±
```python
def complete_task_with_reward(user_id: str, task_id: str):
    with db.get_session() as session:
        task_repo = TaskRepository(session)
        reward_repo = RewardRepository(session)

        # å®Œæˆä»»åŠ¡
        task = task_repo.complete_task(task_id)

        # è®¡ç®—å¥–åŠ±ç¢ç‰‡
        fragments = calculate_fragments(task.priority)

        # å¥–åŠ±ç¢ç‰‡
        reward_repo.award_fragments(
            user_id=user_id,
            amount=fragments,
            reason=f"å®Œæˆä»»åŠ¡: {task.title}"
        )

        return task, fragments
```

### å¼€å§‹ä¸“æ³¨ä¼šè¯
```python
def start_focus_session(user_id: str, duration: int, task_id: str = None):
    with db.get_session() as session:
        focus_repo = FocusRepository(session)

        # æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„ä¼šè¯
        active_sessions = focus_repo.find_active_sessions(user_id)
        if active_sessions:
            raise ValueError("å·²æœ‰æ­£åœ¨è¿›è¡Œçš„ä¸“æ³¨ä¼šè¯")

        # å¼€å§‹æ–°ä¼šè¯
        session = focus_repo.start_focus_session(
            user_id=user_id,
            duration_minutes=duration,
            task_id=task_id
        )

        return session
```

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹SQLè¯­å¥
```python
# åœ¨æ•°æ®åº“è¿æ¥ä¸­å¯ç”¨SQLæ—¥å¿—
db = DatabaseConnection(echo=True)  # ä¼šæ‰“å°æ‰€æœ‰SQLè¯­å¥
```

### æ£€æŸ¥æ•°æ®çŠ¶æ€
```python
# æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ä»»åŠ¡
tasks = task_repo.find_by_user(user_id)
for task in tasks:
    print(f"ä»»åŠ¡: {task.title} - çŠ¶æ€: {task.status}")

# æŸ¥è¯¢ç”¨æˆ·çš„ä¸“æ³¨ç»Ÿè®¡
stats = focus_repo.get_user_focus_statistics(user_id)
print(f"æ€»ä¸“æ³¨: {stats['total_focus_minutes']}åˆ†é’Ÿ")
print(f"å®Œæˆç‡: {stats['completion_rate']:.2%}")
```

### æµ‹è¯•Repositoryæ–¹æ³•
```python
# åœ¨Python REPLä¸­æµ‹è¯•
>>> from src.database.connection import DatabaseConnection
>>> from src.repositories import UserRepository
>>>
>>> db = DatabaseConnection()
>>> with db.get_session() as session:
...     user_repo = UserRepository(session)
...     users = user_repo.find_registered_users()
...     print(f"æ‰¾åˆ° {len(users)} ä¸ªæ³¨å†Œç”¨æˆ·")
```

## ğŸ“ æ€§èƒ½æç¤º

- âœ… ä½¿ç”¨å…·ä½“çš„æŸ¥è¯¢æ–¹æ³•è€Œä¸æ˜¯ `get_all()` åè¿‡æ»¤
- âœ… åœ¨å•ä¸ªä¼šè¯ä¸­å®Œæˆç›¸å…³çš„å¤šä¸ªæ“ä½œ
- âœ… ä½¿ç”¨ç´¢å¼•å­—æ®µï¼ˆå¦‚ `email`, `user_id`ï¼‰è¿›è¡ŒæŸ¥è¯¢
- âœ… åˆç†ä½¿ç”¨åˆ†é¡µé¿å…ä¸€æ¬¡åŠ è½½å¤§é‡æ•°æ®
- âŒ é¿å…åœ¨å¾ªç¯ä¸­åˆ›å»ºå¤šä¸ªæ•°æ®åº“ä¼šè¯
- âŒ é¿å…å¿½ç•¥RepositoryæŠ›å‡ºçš„å¼‚å¸¸

---

ğŸ’¡ **æç¤º**: æœ¬å¿«é€Ÿå‚è€ƒé…åˆã€Šæ•°æ®å±‚æ¥å£ä½¿ç”¨æ‰‹å†Œã€‹ä¸€èµ·ä½¿ç”¨æ•ˆæœæœ€ä½³ï¼