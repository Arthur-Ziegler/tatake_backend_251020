name: API Validation and Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  api-validation:
    runs-on: ubuntu-latest

    services:
      # å¯ä»¥æ·»åŠ æ•°æ®åº“ç­‰æœåŠ¡

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache uv dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: Install uv
      uses: astral-sh/setup-uv@v1

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Start API server
      run: |
        uv run uvicorn src.api.main:app --host 0.0.0.0 --port 8000 &
        sleep 10  # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨

    - name: Run API parameter validation
      run: |
        uv run python scripts/validate_openapi.py --strict --output api_validation_report.json

    - name: Run API health check
      run: |
        uv run python scripts/api_health_monitor.py --once --output health_reports

    - name: Run pytest with API validation
      run: |
        uv run pytest tests/validation/test_api_parameters.py -v --tb=short

    - name: Upload validation reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: api-validation-reports
        path: |
          api_validation_report.json
          health_reports/

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          // è¯»å–éªŒè¯æŠ¥å‘Š
          let validationReport = null;
          let healthReport = null;

          try {
            validationReport = JSON.parse(fs.readFileSync('api_validation_report.json', 'utf8'));
          } catch (e) {
            console.log('No validation report found');
          }

          // æ„å»ºè¯„è®ºå†…å®¹
          let comment = '## ğŸ” APIéªŒè¯ç»“æœ\n\n';

          if (validationReport) {
            if (validationReport.validation_passed) {
              comment += 'âœ… **OpenAPIéªŒè¯é€šè¿‡**\n\n';
            } else {
              comment += 'âŒ **OpenAPIéªŒè¯å¤±è´¥**\n\n';
              comment += '**é”™è¯¯:**\n';
              validationReport.errors.forEach(error => {
                comment += `- ${error}\n`;
              });
            }

            if (validationReport.warnings.length > 0) {
              comment += '\nâš ï¸ **è­¦å‘Š:**\n';
              validationReport.warnings.forEach(warning => {
                comment += `- ${warning}\n`;
              });
            }
          }

          comment += '\n---\n';
          comment += '*æ­¤è¯„è®ºç”±APIéªŒè¯å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ*';

          // åˆ›å»ºæˆ–æ›´æ–°è¯„è®º
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Check validation results
      run: |
        if [ -f "api_validation_report.json" ]; then
          if grep -q '"validation_passed": false' api_validation_report.json; then
            echo "âŒ APIéªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯å¹¶ä¿®å¤"
            exit 1
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°éªŒè¯æŠ¥å‘Š"
          exit 1
        fi

    - name: Run additional API tests
      run: |
        uv run pytest tests/e2e/test_api_coverage.py -v

  performance-check:
    runs-on: ubuntu-latest
    needs: api-validation

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v1

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Start API server
      run: |
        uv run uvicorn src.api.main:app --host 0.0.0.0 --port 8000 &
        sleep 10

    - name: Run performance tests
      run: |
        uv run pytest tests/e2e/test_api_coverage.py::TestAPICoverage::test_response_time_performance -v

    - name: Run load tests
      run: |
        uv run pytest tests/e2e/test_api_coverage.py::TestAPICoverage::test_concurrent_users -v