# 提案：重构奖励系统至v4规范

## 概述
对齐v3文档与当前实现的差异，升级为v4规范。核心变更：纯流水记录、无限供应奖品、新增积分兑换、修复API响应格式。

## Why（动机）
1. **数据冗余**：`rewards.stock_quantity`字段与流水记录重复，违反v3纯流水设计
2. **功能缺失**：积分兑换奖品已实现但未文档化
3. **API不一致**：任务完成响应格式偏离v3定义
4. **配置冗余**：`game_config.py`部分配置未使用
5. **番茄钟不完整**：缺少自动关闭会话机制

## 核心决策
1. **库存策略**：删除`stock_quantity`，所有奖品无限供应
2. **奖品获取路径**（3条）：
   - 完成普通任务 → 2积分
   - 完成Top3任务 → 50%概率100积分 / 50%抽奖品
   - 积分兑换奖品（新增到v4）
3. **奖品合成**：辅助功能，少量高级合成（如10小金币→1大金币）
4. **抽奖池**：动态从数据库获取所有`is_active=true`奖品
5. **配置清理**：移除`game_config.py`未使用部分，保留`TransactionSource`枚举

## 影响范围
- **数据库**：删除`rewards.stock_quantity`字段
- **API**：修正`POST /tasks/{id}/complete`响应格式
- **番茄钟**：新增自动关闭会话逻辑
- **文档**：更新为v4规范

## 风险评估
- **低风险**：删除未使用的库存字段，无现有业务依赖
- **中风险**：修改API响应格式，需前端配合调整
- **缓解措施**：通过测试验证所有流水记录功能正常

## 成功标准
- [ ] 数据库无`stock_quantity`字段残留
- [ ] 任务完成API返回`reward_earned`字段（符合v3）
- [ ] 番茄钟新会话自动关闭旧会话
- [ ] v4文档完整覆盖3条奖品获取路径
- [ ] 所有单元测试通过
