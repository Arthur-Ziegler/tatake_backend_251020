# 任务系统核心优化

## What
重构任务系统核心架构，修复数据一致性问题，构建严格测试体系。

## Why
任务系统是核心业务，存在数据一致性风险、架构设计缺陷、测试覆盖不足等关键问题。

## What Changes

### 架构修复
1. **Top3域迁移**：独立数据库→主数据库，确保数据一致性
2. **UUID统一**：全项目UUID对象化，API边界转换
3. **树结构简化**：移除未使用level/path字段，纯parent_id实现
4. **事务增强**：跨域操作事务保护，回滚机制

### 数据模型优化
1. **Top3表重构**：task_ids统一JSON格式，created_at改datetime
2. **Task模型简化**：合并重复models.py，移除冗余字段
3. **约束增强**：外键关联，唯一索引，数据验证

### 测试体系构建
1. **测试分层**：单元测试(内存DB)→集成测试(临时DB)→并发测试(真实DB)
2. **数据工厂**：统一测试数据生成，边界条件覆盖
3. **严格测试**：并发安全、数据一致性、错误恢复、性能边界
4. **覆盖率≥98%**：关键逻辑100%覆盖

### 业务逻辑修复
1. **积分发放一致性**：统一TaskService与TaskCompletionService逻辑
2. **并发安全**：任务完成防重复，Top3设置原子性
3. **错误处理增强**：详细错误上下文，统一异常体系

## 风险与限制
- 数据迁移需要重新初始化Top3表
- UUID类型变更影响API兼容性
- 测试体系构建工作量较大

## 成功标准
- 0数据一致性问题
- 测试覆盖率≥98%
- 并发测试100%通过
- openspec validate --strict 0错误