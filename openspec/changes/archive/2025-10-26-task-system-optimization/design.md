# 任务系统优化设计

## 架构设计

### 域重构策略
```
Task域(主数据库) ←→ Top3域(迁移至主数据库)
      ↓                    ↓
  统一UUID处理          简化模型设计
      ↓                    ↓
  严格测试体系        数据一致性保障
```

### 数据库设计
- **统一数据库**：Top3表迁移至tatake.db
- **表结构优化**：task_ids JSON格式，datetime类型
- **索引策略**：user_id+date复合索引，task_ids JSON索引

### 测试架构
```
tests/
├── unit/           # 单元测试(内存SQLite)
├── integration/    # 集成测试(临时SQLite)
├── concurrency/    # 并发测试(真实SQLite)
└── fixtures/       # 测试数据工厂
```

## 技术方案

### UUID统一化
- 内部：UUID对象
- 数据库：字符串转换(使用uuid_converter.py)
- API：边界字符串转换

### 事务管理
- 跨域操作：业务事务+数据库事务
- 回滚机制：积分发放失败自动回滚
- 并发控制：乐观锁+唯一约束

### 测试策略
- 数据工厂：MockDataFactory
- 场景覆盖：正常+异常+边界+并发
- 自动清理：测试隔离，环境重置

## 实施顺序
1. Top3数据库迁移
2. UUID类型统一
3. 模型结构简化
4. 测试体系构建
5. 业务逻辑修复
6. 性能优化验证