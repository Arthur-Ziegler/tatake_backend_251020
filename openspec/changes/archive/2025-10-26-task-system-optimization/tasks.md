# 任务系统优化任务清单

## 阶段一：架构修复(关键)

### 1. Top3域数据库迁移
- [ ] 移除Top3独立数据库配置
- [ ] 在主数据库创建Top3表
- [ ] 重构Top3Repository使用主数据库连接
- [ ] 更新Top3Service事务管理
- [ ] 测试迁移后功能完整性

### 2. UUID类型统一化
- [ ] 修复Task域UUID处理
- [ ] 修复Top3域UUID处理
- [ ] 统一API边界UUID转换
- [ ] 更新Repository层数据库交互
- [ ] 验证UUID类型一致性

### 3. 任务树结构简化
- [ ] 移除Task模型level/path字段
- [ ] 简化树查询逻辑
- [ ] 优化parent_id索引
- [ ] 更新相关Service方法
- [ ] 测试树操作性能

## 阶段二：测试体系构建

### 4. 测试项目结构重构
- [ ] 创建tests/unit目录
- [ ] 创建tests/integration目录
- [ ] 创建tests/concurrency目录
- [ ] 创建tests/fixtures目录
- [ ] 建立测试配置体系

### 5. 测试数据工厂
- [ ] 创建TaskTestDataFactory
- [ ] 创建Top3TestDataFactory
- [ ] 创建UserTestDataFactory
- [ ] 实现边界条件数据生成
- [ ] 建立测试数据清理机制

### 6. 单元测试严格化
- [ ] TaskService单元测试(100%覆盖)
- [ ] TaskRepository单元测试
- [ ] Top3Service单元测试
- [ ] 异常处理测试
- [ ] 边界条件测试

### 7. 集成测试完善
- [ ] 任务完成流程集成测试
- [ ] Top3设置集成测试
- [ ] 跨域事务集成测试
- [ ] 错误恢复测试
- [ ] API端到端测试

### 8. 并发安全测试
- [ ] 任务完成并发测试
- [ ] Top3设置并发测试
- [ ] 积分余额竞态测试
- [ ] 数据一致性并发测试
- [ ] 性能压力测试

## 阶段三：质量提升

### 9. 业务逻辑修复
- [ ] 修复积分发放逻辑一致性
- [ ] 增强并发安全保护
- [ ] 完善错误处理机制
- [ ] 优化事务边界管理
- [ ] 增强数据验证规则

### 10. 性能优化
- [ ] 优化树结构查询性能
- [ ] 添加数据库索引优化
- [ ] 优化JSON字段查询
- [ ] 减少N+1查询问题
- [ ] 缓存热点数据访问

## 验收标准

### 功能验证
- [ ] 所有任务功能正常运行
- [ ] Top3功能数据一致性
- [ ] 并发操作无数据异常
- [ ] 错误恢复正常回滚

### 质量验证
- [ ] 测试覆盖率≥98%
- [ ] 所有测试100%通过
- [ ] openspec validate --strict 0错误
- [ ] 性能测试达标

### 架构验证
- [ ] 数据库架构统一
- [ ] UUID类型一致性
- [ ] 域边界清晰
- [ ] 代码质量提升