# Phase 1 Day 2 - Service Layer Core Logic Tasks

## 任务清单

### 1. 数据模型清理 (1天)

#### 1.1 番茄钟功能清理 [必做]
- [ ] 删除Task Schema中的estimated_pomodoros和actual_pomodoros字段定义
- [ ] 删除Task Service中的番茄钟相关业务逻辑方法
- [ ] 删除Task测试文件中的番茄钟字段引用和测试用例
- [ ] 验证所有番茄钟相关代码已完全清理

**验收标准**:
- grep搜索estimated_pomodoros和actual_pomodoros无结果
- Task模型和Schema中不包含任何番茄钟字段
- 所有测试用例正常运行

#### 1.2 UserReward代码清理 [必做]
- [ ] 删除Reward Repository中的UserReward类导入和CRUD方法
- [ ] 删除Reward Schema中的UserRewardResponse定义
- [ ] 删除Reward Service中的UserReward相关业务逻辑
- [ ] 验证所有UserReward相关代码已完全清理

**验收标准**:
- grep搜索UserReward无结果（除了注释说明）
- 奖励系统完全基于reward_transactions流水表
- 所有Service方法正常运行

### 2. Service层核心功能实现 (3天)

#### 2.1 PointsService实现 [必做]
- [ ] 实现积分余额计算方法 (纯SQL聚合查询)
- [ ] 实现积分流水记录创建方法
- [ ] 实现积分统计查询方法 (按source_type分组)
- [ ] 添加PointsService单元测试

**验收标准**:
- 积分余额计算准确性100%
- 支持按时间范围和source_type的统计查询
- 单元测试覆盖率>95%

#### 2.2 RewardService实现 [必做]
- [ ] 实现奖励库存计算方法 (纯SQL聚合查询)
- [ ] 实现奖励事务记录创建方法
- [ ] 实现奖励消耗方法
- [ ] 添加RewardService单元测试

**验收标准**:
- 奖励库存计算准确性100%
- 支持earned/consumed事务类型记录
- 单元测试覆盖率>95%

#### 2.3 TaskService实现 [必做]
- [ ] 实现任务完成验证和防刷机制
- [ ] 实现普通任务奖励发放 (固定2积分)
- [ ] 实现递归任务完成度计算算法
- [ ] 实现任务状态更新逻辑
- [ ] 添加TaskService单元测试

**验收标准**:
- 同一任务同日重复领取被正确阻止
- 递归完成度计算准确性100%
- 防刷日期戳正确更新

#### 2.4 Top3Service实现 [必做]
- [ ] 实现每日Top3任务设置功能 (消耗300积分)
- [ ] 实现Top3任务检查方法
- [ ] 实现50%概率抽奖算法 (3个预设奖品)
- [ ] 添加Top3Service单元测试

**验收标准**:
- Top3设置正确扣除300积分
- 50%概率算法准确性验证
- 抽奖结果正确记录到相应表

#### 2.5 RedemptionService实现 [必做]
- [ ] 实现配方加载和验证功能
- [ ] 实现材料充足性检查逻辑
- [ ] 实现原子兑换操作 (事务组ID管理)
- [ ] 实现兑换历史查询功能
- [ ] 添加RedemptionService单元测试

**验收标准**:
- 材料检查准确性100%
- 兑换操作原子性保证
- 事务组ID正确关联所有相关记录

### 3. Service层依赖注入和事务管理 (1天)

#### 3.1 Service依赖关系建立 [必做]
- [ ] 实现Service类之间的依赖注入
- [ ] 配置PointsService独立初始化
- [ ] 配置RewardService依赖PointsService
- [ ] 配置TaskService依赖PointsService和RewardService
- [ ] 配置Top3Service依赖PointsService
- [ ] 配置RedemptionService依赖RewardService和PointsService

**验收标准**:
- 所有Service类正确初始化
- 依赖关系无循环引用
- 依赖注入正常工作

#### 3.2 事务管理器实现 [必做]
- [ ] 实现simple_transaction上下文管理器
- [ ] 在必要的Service方法中集成事务管理
- [ ] 添加事务异常处理和回滚机制
- [ ] 验证事务边界正确性

**验收标准**:
- 事务失败时正确回滚
- 事务成功时正确提交
- 异常正确传播

### 4. 集成测试和验证 (1天)

#### 4.1 业务流程集成测试 [必做]
- [ ] 测试完整的任务完成→奖励发放→积分计算流程
- [ ] 测试Top3任务设置→完成→抽奖→奖励发放流程
- [ ] 测试奖励兑换的完整原子操作流程
- [ ] 验证防刷机制的有效性

**验收标准**:
- 所有业务流程端到端测试通过
- 防刷机制正确阻止重复操作
- 数据一致性验证通过

#### 4.2 数据一致性和准确性测试 [必做]
- [ ] 验证积分余额计算准确性
- [ ] 验证奖励库存计算准确性
- [ ] 验证递归完成度计算准确性
- [ ] 验证事务原子性保证

**验收标准**:
- 所有计算功能准确性100%
- 并发操作下数据一致性保证
- 事务边界验证通过

### 5. 代码质量和文档完善 (0.5天)

#### 5.1 代码质量检查 [必做]
- [ ] 运行代码格式化和静态分析
- [ ] 检查类型注解完整性
- [ ] 验证代码符合项目规范
- [ ] 修复代码质量问题

**验收标准**:
- 代码风格一致性
- 类型注解覆盖率>95%
- 无严重代码质量问题

#### 5.2 文档和注释完善 [必做]
- [ ] 为所有Service方法添加docstring
- [ ] 更新相关的技术文档
- [ ] 添加关键业务逻辑的行内注释
- [ ] 验证文档的准确性

**验收标准**:
- 所有public方法有完整docstring
- 技术文档与实现一致
- 复杂逻辑有适当注释

## 依赖关系

```
1. 数据模型清理 (1天)
   ├─ 1.1 番茄钟功能清理 (0.5天)
   └─ 1.2 UserReward代码清理 (0.5天)

2. Service层核心功能实现 (3天) [依赖: 1]
   ├─ 2.1 PointsService实现 (0.5天)
   ├─ 2.2 RewardService实现 (0.5天) [依赖: 2.1]
   ├─ 2.3 TaskService实现 (1天) [依赖: 2.1, 2.2]
   ├─ 2.4 Top3Service实现 (0.5天) [依赖: 2.1]
   └─ 2.5 RedemptionService实现 (0.5天) [依赖: 2.1, 2.2]

3. Service层依赖注入和事务管理 (1天) [依赖: 2]
   ├─ 3.1 Service依赖关系建立 (0.5天)
   └─ 3.2 事务管理器实现 (0.5天)

4. 集成测试和验证 (1天) [依赖: 3]
   ├─ 4.1 业务流程集成测试 (0.5天)
   └─ 4.2 数据一致性和准确性测试 (0.5天)

5. 代码质量和文档完善 (0.5天) [依赖: 4]
   ├─ 5.1 代码质量检查 (0.25天)
   └─ 5.2 文档和注释完善 (0.25天)
```

## 并行工作

- **可以并行进行**:
  - 1.1 番茄钟功能清理 与 1.2 UserReward代码清理
  - 2.1 PointsService实现 与 2.2 RewardService实现
  - 2.4 Top3Service实现 与 2.5 RedemptionService实现
  - 4.1 业务流程集成测试 与 4.2 数据一致性和准确性测试

- **必须串行进行**:
  - 数据模型清理 → Service层实现
  - Service层实现 → 依赖注入和事务管理
  - 依赖注入和事务管理 → 集成测试
  - 集成测试 → 代码质量和文档完善

## 风险和缓解措施

### 高风险项目
1. **递归完成度计算算法复杂性**
   - 风险：可能存在边界情况处理不当
   - 缓解：增加详细测试用例，包括各种任务树结构

2. **事务原子性保证**
   - 风险：复杂操作可能无法保证完整原子性
   - 缓解：详细设计事务边界，增加集成测试

### 中等风险项目
1. **数据模型清理的完整性**
   - 风险：可能遗漏某些番茄钟或UserReward相关代码
   - 缓解：使用grep全局搜索，确保清理彻底

2. **Service依赖关系的循环引用**
   - 风险：依赖设计不当可能产生循环
   - 缓解：在设计阶段详细审查依赖图

## 验收标准

### 功能验收
- [ ] 所有Service层方法正确实现
- [ ] 积分余额计算准确性100%
- [ ] 奖励库存计算准确性100%
- [ ] 任务完成奖励机制正常工作
- [ ] Top3抽奖逻辑概率正确
- [ ] 防刷机制有效防止重复领奖
- [ ] 奖励兑换原子操作确保数据一致性

### 质量验收
- [ ] 代码符合项目规范，类型注解完整
- [ ] 所有Service方法有完整文档字符串
- [ ] 事务边界管理确保数据一致性
- [ ] 单元测试覆盖率>95%
- [ ] 集成测试覆盖完整业务流程

### 性能验收
- [ ] 基础查询响应时间<100ms
- [ ] 事务操作响应时间<500ms
- [ ] 集成测试执行时间<10s

### 清理验收
- [ ] 番茄钟功能完全删除
- [ ] UserReward相关代码完全清理
- [ ] 代码库无残留冗余代码

## 总工作量评估

- **总工作日**: 6.5天
- **关键路径**: 6.5天
- **并行优化后**: 5天
- **缓冲时间**: 1天
- **预计总时间**: 6天

## 团队分工建议

- **主开发** (1人): 负责Service层核心功能实现
- **测试开发** (0.5人): 负责单元测试和集成测试编写
- **代码审查** (0.3人): 负责代码质量检查和文档完善

**注意**: 这只是建议分工，可以根据实际团队情况调整。