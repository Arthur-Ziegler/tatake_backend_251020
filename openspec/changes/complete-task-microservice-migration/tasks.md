# Complete Task Microservice Migration - Task List

## Phase 1: 基础设施准备 (预计2小时)

### 1.1 增强微服务客户端
- [ ] 1.1.1 创建新的增强版 `TaskMicroserviceClient`
  - 实现路径映射表 `_build_path_mappings()`
  - 实现动态路径重写 `rewrite_path()`
  - 实现UUID验证器 `UUIDValidator`
  - **验证**: 单元测试覆盖所有路径映射和UUID验证场景

- [ ] 1.1.2 重构微服务调用逻辑
  - 实现 `call_microservice()` 方法，支持路径重写
  - 移除旧的 `transform_response()` 方法（直接透传）
  - 增强错误处理和重试机制
  - **验证**: 集成测试验证调用链路正确性

- [ ] 1.1.3 添加连接池和性能优化
  - 实现连接池管理 `ConnectionPoolManager`
  - 添加请求重试机制
  - 实现健康检查集成
  - **验证**: 性能测试验证连接复用和重试逻辑

### 1.2 配置和环境设置
- [ ] 1.2.1 更新微服务配置
  - 确认微服务URL配置正确 (`http://45.152.65.130:20253/api/v1`)
  - 添加超时和重试配置
  - **验证**: 配置加载和连接测试成功

## Phase 2: 路由层重构 (预计4小时)

### 2.1 重构Task Router
- [ ] 2.1.1 更新任务CRUD端点
  - 重构 `POST /tasks` → 使用新的微服务客户端
  - 重构 `GET /tasks` → 转换为 `POST /tasks/query` 然后调用微服务
  - 重构 `PUT /tasks/{task_id}` → 添加路径重写逻辑
  - 重构 `DELETE /tasks/{task_id}` → 添加路径重写逻辑
  - **验证**: 单个端点功能测试，确保路径映射正确

- [ ] 2.1.2 更新任务完成端点
  - 重构 `POST /tasks/{task_id}/complete` → 使用微服务奖励系统
  - 移除本地奖励计算逻辑
  - 适配微服务响应格式
  - **验证**: 任务完成功能测试，验证奖励信息正确

### 2.2 重构Top3管理
- [ ] 2.2.1 更新Top3设置端点
  - 重构 `POST /tasks/special/top3` → 直接调用微服务
  - 移除本地积分扣除逻辑（微服务处理）
  - **验证**: Top3设置功能测试

- [ ] 2.2.2 更新Top3查询端点
  - 重构 `GET /tasks/special/top3/{date}` → 路径重写
  - 适配微服务响应格式
  - **验证**: Top3查询功能测试

### 2.3 重构专注和番茄钟功能
- [ ] 2.3.1 更新专注状态端点
  - 重构 `POST /tasks/focus-status` → 调用 `/api/v1/focus/sessions`
  - 移除本地专注状态数据库操作
  - **验证**: 专注状态记录功能测试

- [ ] 2.3.2 更新番茄钟计数端点
  - 重构 `GET /tasks/pomodoro-count` → 调用 `/api/v1/pomodoros/count`
  - 移除本地番茄钟计数逻辑
  - **验证**: 番茄钟计数查询功能测试

## Phase 3: 数据清理和架构简化 (预计2小时)

### 3.1 移除本地实现文件
- [ ] 3.1.1 删除Task本地实现
  - 删除 `src/domains/task/database_local*.py`
  - 删除 `src/domains/task/service_local.py`
  - 删除 `src/domains/task/models_local.py`
  - 删除 `src/domains/task/completion_service.py`
  - **验证**: 应用启动成功，无导入错误

- [ ] 3.1.2 清理本地数据库表
  - 备份现有Task相关数据
  - 删除 `task_operations`, `task_completions`, `focus_status_records`, `pomodoro_counts` 表
  - **验证**: 数据库清理成功，应用正常运行

### 3.2 代码质量优化
- [ ] 3.2.1 移除废弃的导入和依赖
  - 清理router.py中的废弃导入
  - 移除不再使用的依赖项
  - **验证**: 代码无未使用导入警告

- [ ] 3.2.2 优化错误处理
  - 统一错误处理格式
  - 增强日志记录
  - **验证**: 错误场景测试，日志格式正确

## Phase 4: 测试和验证 (预计3小时)

### 4.1 单元测试
- [ ] 4.1.1 微服务客户端测试
  - 测试路径映射逻辑
  - 测试UUID验证逻辑
  - 测试错误处理和重试机制
  - **验证**: 测试覆盖率 > 95%

- [ ] 4.1.2 路由层测试
  - 测试所有9个API端点的代理逻辑
  - 测试请求/响应适配
  - 测试错误场景处理
  - **验证**: 所有测试通过

### 4.2 集成测试
- [ ] 4.2.1 端到端功能测试
  - 启动完整的API服务
  - 测试所有Task相关功能流程
  - 验证数据一致性
  - **验证**: 完整功能流程测试通过

- [ ] 4.2.2 性能基准测试
  - 测试API响应时间
  - 测试并发处理能力
  - 对比迁移前后的性能指标
  - **验证**: 响应时间 < 300ms，性能可接受

### 4.3 兼容性测试
- [ ] 4.3.1 API兼容性测试
  - 使用现有的测试用例验证兼容性
  - 确保响应格式不变
  - 确保错误码格式不变
  - **验证**: 现有客户端无需修改即可使用

- [ ] 4.3.2 边界条件测试
  - 测试无效UUID格式处理
  - 测试网络异常场景
  - 测试微服务不可用场景
  - **验证**: 边界条件处理正确

## Phase 5: 部署和监控 (预计1小时)

### 5.1 部署准备
- [ ] 5.1.1 更新部署配置
  - 确认微服务依赖配置
  - 更新环境变量配置
  - **验证**: 部署配置正确

- [ ] 5.1.2 创建回滚方案
  - 备份当前版本代码
  - 准备快速回滚脚本
  - **验证**: 回滚方案可用

### 5.2 监控和日志
- [ ] 5.2.1 添加监控指标
  - 微服务调用成功率监控
  - 响应时间监控
  - 错误率监控
  - **验证**: 监控指标正确显示

- [ ] 5.2.2 完善日志记录
  - 添加请求追踪日志
  - 添加错误详情日志
  - 添加性能指标日志
  - **验证**: 日志格式正确，便于调试

## Phase 6: 文档和培训 (预计1小时)

### 6.1 更新文档
- [ ] 6.1.1 更新技术文档
  - 更新API文档，说明微服务架构
  - 更新部署文档，添加微服务依赖说明
  - **验证**: 文档内容准确完整

- [ ] 6.1.2 创建迁移指南
  - 记录迁移过程和关键决策
  - 提供故障排查指南
  - **验证**: 迁移指南清晰可用

### 6.2 团队培训
- [ ] 6.2.1 技术分享
  - 分享微服务架构设计
  - 讲解关键变更点
  - **验证**: 团队理解新的架构

## 验收标准

### 功能验收
- [ ] 所有9个Task API端点功能正常
- [ ] 现有测试用例100%通过
- [ ] 前端无需修改即可正常使用
- [ ] 用户数据无丢失

### 性能验收
- [ ] API响应时间 < 300ms (95%的请求)
- [ ] 微服务调用成功率 > 99%
- [ ] 并发处理能力不降低
- [ ] 系统稳定性提升

### 质量验收
- [ ] 代码测试覆盖率 > 95%
- [ ] 无严重安全漏洞
- [ ] 日志记录完整规范
- [ ] 监控指标完整

## 风险缓解措施

### 技术风险
- **微服务不可用**: 实现降级策略，返回友好错误信息
- **性能下降**: 优化连接池和缓存策略
- **数据不一致**: 提供数据验证和修复工具

### 业务风险
- **功能回归**: 完整的回归测试覆盖
- **用户体验影响**: 保持API兼容性
- **数据丢失**: 完整的数据备份和恢复方案

## 依赖关系

- Phase 2 依赖 Phase 1 (基础设施)
- Phase 3 依赖 Phase 2 (路由重构完成)
- Phase 4 依赖 Phase 3 (架构简化完成)
- Phase 5 依赖 Phase 4 (测试验证通过)
- Phase 6 依赖 Phase 5 (部署成功)

## 预估时间总计
- **Phase 1**: 2小时
- **Phase 2**: 4小时
- **Phase 3**: 2小时
- **Phase 4**: 3小时
- **Phase 5**: 1小时
- **Phase 6**: 1小时
- **总计**: 13小时

## 成功指标
- [x] 所有Task功能通过微服务提供
- [x] 系统架构统一简化
- [x] 性能和稳定性提升
- [x] 开发和维护效率提升
- [x] 用户体验保持一致