# é›¶Bugæµ‹è¯•ä½“ç³» - ä¸¥æ ¼Pre-commit Hooks
# ç¡®ä¿æ‰€æœ‰ä»£ç åœ¨æäº¤å‰éƒ½ç»è¿‡é›¶Bugè´¨é‡æ ‡å‡†æ£€æŸ¥

repos:
  # ç¬¬ä¸€å±‚ï¼šåŸºç¡€ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆå¿…é¡»å…¨éƒ¨é€šè¿‡ï¼‰
  - repo: https://github.com/pycqa/flake8
    rev: 6.1.0
    hooks:
      - id: flake8
        name: é›¶Bugä»£ç è§„èŒƒæ£€æŸ¥
        entry: flake8
        language: python
        types: [python]
        args:
          - --max-line-length=88
          - --extend-ignore=E203,W503,E501
          - --max-complexity=10
          - --max-args=7
          - --max-locals=15
          - --max-returns=6
          - --max-branches=12
          - --max-statements=50
          - --max-attributes=7
          - --show-source
          - --statistics
          - --jobs=auto
        additional_dependencies:
          - flake8-docstrings
          - flake8-import-order
          - flake8-bugbear
          - pep8-naming
          - flake8-comprehensions
          - flake8-simplify
        fail_fast: true

  # ç¬¬äºŒå±‚ï¼šä»£ç æ ¼å¼åŒ–ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰
  - repo: https://github.com/pycqa/isort
    rev: 5.12.0
    hooks:
      - id: isort
        name: é›¶Bugå¯¼å…¥æ’åº
        args:
          - --profile black
          - --line-length=88
          - --known-first-party=src
          - --multi-line=3
          - --trailing-comma
          - --force-grid-wrap=0
          - --use-parentheses
          - --ensure-newline-before-comments
          - --force-single-line-imports
        language_version: python3

  - repo: https://github.com/psf/black
    rev: 23.3.0
    hooks:
      - id: black
        name: é›¶Bugä»£ç æ ¼å¼åŒ–
        language_version: python3
        args:
          - --line-length=88
          - --target-version=py312
          - --skip-string-normalization
          - --include='\.pyi?$'
        require_serial: true

  # ç¬¬ä¸‰å±‚ï¼šç±»å‹æ£€æŸ¥ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.5.1
    hooks:
      - id: mypy
        name: é›¶Bugç±»å‹æ£€æŸ¥
        entry: mypy
        language: python
        types: [python]
        args:
          - --strict
          - --warn-return-any
          - --warn-unused-ignores
          - --warn-redundant-casts
          - --no-implicit-optional
          - --disallow-untyped-defs
          - --disallow-incomplete-defs
          - --check-untyped-defs
          - --disallow-any-generics
          - --disallow-subclassing-any
          - --disallow-untyped-calls
          - --disallow-untyped-decorators
          - --disallow-explicit-any
          - --strict-equality
          - --strict-concatenate
        additional_dependencies:
          - types-all
          - types-requests
          - types-setuptools
          - types-python-dateutil
          - types-PyYAML
        pass_filenames: false
        require_serial: true

  # ç¬¬å››å±‚ï¼šå®‰å…¨æ£€æŸ¥ï¼ˆé›¶å®¹å¿ï¼‰
  - repo: https://github.com/pycqa/bandit
    rev: 1.7.5
    hooks:
      - id: bandit
        name: é›¶Bugå®‰å…¨æ‰«æ
        entry: bandit
        language: python
        types: [python]
        args:
          - -r
          - src/
          - -f
          - json
          - -o
          - .bandit-report.json
          - --severity-level=medium
          - --confidence-level=low
          - --exclude=tests/
        require_serial: true

  # ç¬¬äº”å±‚ï¼šä¾èµ–å®‰å…¨æ£€æŸ¥
  - repo: https://github.com/Lucas-C/pre-commit-hooks-safety
    rev: v1.3.2
    hooks:
      - id: python-safety-dependencies-check
        name: é›¶Bugä¾èµ–å®‰å…¨æ£€æŸ¥
        entry: safety check
        language: python
        args:
          - --json
          - --output
          - .safety-report.json
          - --short-report
        additional_dependencies:
          - safety
        pass_filenames: false

  # ç¬¬å…­å±‚ï¼šæ–‡æ¡£è´¨é‡æ£€æŸ¥
  - repo: https://github.com/pycqa/pydocstyle
    rev: 6.3.0
    hooks:
      - id: pydocstyle
        name: é›¶Bugæ–‡æ¡£è§„èŒƒæ£€æŸ¥
        args:
          - --convention=google
          - --add-ignore=D100,D104,D105,D107
          - --explain
          - --source
        exclude: tests/

  # ç¬¬ä¸ƒå±‚ï¼šå¤æ‚åº¦å’Œè´¨é‡æ£€æŸ¥
  - repo: https://github.com/pycqa/pylint
    rev: v2.17.4
    hooks:
      - id: pylint
        name: é›¶Bugä»£ç è´¨é‡è¯„åˆ†
        entry: pylint
        language: python
        types: [python]
        args:
          - --rcfile=.pylintrc
          - --score=yes
          - --fail-under=9.5
          - --output-format=colorized,json:.pylint-report.json,text
          - --reports=y
          - --max-line-length=88
          - --jobs=1
        additional_dependencies:
          - pylint-django
          - pylint-flask
          - pylint-pytest
        exclude: tests/
        require_serial: true

  # ç¬¬å…«å±‚ï¼šé›¶Bugç‰¹å®šæ£€æŸ¥
  - repo: local
    hooks:
      # å•å…ƒæµ‹è¯•æ£€æŸ¥
      - id: zero-bug-unit-test-check
        name: é›¶Bugå•å…ƒæµ‹è¯•æ£€æŸ¥
        entry: uv run pytest tests/unit -x --tb=short --cov=src --cov-fail-under=80 --disable-warnings
        language: system
        pass_filenames: false
        always_run: true
        require_serial: true

      # å¯¼å…¥é”™è¯¯æ£€æŸ¥
      - id: zero-bug-import-check
        name: é›¶Bugå¯¼å…¥é”™è¯¯æ£€æŸ¥
        entry: uv run python -c "
import sys
import ast
import os

def check_imports(file_path):
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        ast.parse(content)
        return True, None
    except SyntaxError as e:
        return False, f'è¯­æ³•é”™è¯¯: {e}'
    except ImportError as e:
        return False, f'å¯¼å…¥é”™è¯¯: {e}'
    except Exception as e:
        return False, f'æœªçŸ¥é”™è¯¯: {e}'

# æ£€æŸ¥æ‰€æœ‰Pythonæ–‡ä»¶
exit_code = 0
for root, dirs, files in os.walk('src'):
    for file in files:
        if file.endswith('.py'):
            file_path = os.path.join(root, file)
            success, error = check_imports(file_path)
            if not success:
                print(f'æ–‡ä»¶ {file_path}: {error}')
                exit_code = 1

sys.exit(exit_code)
"
        language: system
        pass_filenames: false
        always_run: true

      # æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥
      - id: zero-bug-coverage-check
        name: é›¶Bugè¦†ç›–ç‡æ£€æŸ¥
        entry: uv run python -c "
import subprocess
import sys
import json

try:
    # è¿è¡Œè¦†ç›–ç‡æ£€æŸ¥
    result = subprocess.run([
        'uv', 'run', 'pytest', '--cov=src', '--cov-report=json',
        '--cov-fail-under=85', '--tb=no', '-q'
    ], capture_output=True, text=True)

    if result.returncode == 0:
        # è¯»å–è¦†ç›–ç‡æŠ¥å‘Š
        with open('coverage.json', 'r') as f:
            coverage_data = json.load(f)

        total_coverage = coverage_data['totals']['percent_covered']
        print(f'å½“å‰è¦†ç›–ç‡: {total_coverage:.1f}%')

        if total_coverage < 85.0:
            print(f'è¦†ç›–ç‡ {total_coverage:.1f}% ä½äºé›¶Bugæ ‡å‡† 85%')
            sys.exit(1)
        else:
            print(f'è¦†ç›–ç‡ {total_coverage:.1f}% ç¬¦åˆé›¶Bugæ ‡å‡†')
    else:
        print('è¦†ç›–ç‡æ£€æŸ¥å¤±è´¥')
        sys.exit(result.returncode)

except Exception as e:
    print(f'è¦†ç›–ç‡æ£€æŸ¥å¼‚å¸¸: {e}')
    sys.exit(1)
"
        language: system
        pass_filenames: false
        always_run: true
        require_serial: true

      # æ€§èƒ½åŸºå‡†æ£€æŸ¥
      - id: zero-bug-performance-check
        name: é›¶Bugæ€§èƒ½åŸºå‡†æ£€æŸ¥
        entry: uv run python -c "
import subprocess
import sys
import time

try:
    # è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
    start_time = time.time()
    result = subprocess.run([
        'uv', 'run', 'pytest', 'tests/unit', '-x', '--tb=no', '-q'
    ], capture_output=True, text=True)

    end_time = time.time()
    duration = end_time - start_time

    print(f'å•å…ƒæµ‹è¯•æ‰§è¡Œæ—¶é—´: {duration:.2f}ç§’')

    if duration > 120:  # 2åˆ†é’Ÿé™åˆ¶
        print(f'æµ‹è¯•æ‰§è¡Œæ—¶é—´ {duration:.2f}s è¶…è¿‡é›¶Bugæ ‡å‡† 120s')
        sys.exit(1)

    if result.returncode != 0:
        print('æ€§èƒ½åŸºå‡†æµ‹è¯•å¤±è´¥')
        sys.exit(result.returncode)

    print('æ€§èƒ½åŸºå‡†æ£€æŸ¥é€šè¿‡')

except Exception as e:
    print(f'æ€§èƒ½æ£€æŸ¥å¼‚å¸¸: {e}')
    sys.exit(1)
"
        language: system
        pass_filenames: false
        always_run: true
        require_serial: true

  # ç¬¬ä¹å±‚ï¼šæ–‡ä»¶åŸºç¡€æ£€æŸ¥
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: check-added-large-files
        name: é›¶Bugå¤§æ–‡ä»¶æ£€æŸ¥
        args: ['--maxkb=500']  # 500KBé™åˆ¶
      - id: check-case-conflict
        name: é›¶Bugæ–‡ä»¶åå†²çªæ£€æŸ¥
      - id: check-merge-conflict
        name: é›¶Bugåˆå¹¶å†²çªæ£€æŸ¥
      - id: check-yaml
        name: é›¶Bug YAMLæ ¼å¼æ£€æŸ¥
      - id: check-json
        name: é›¶Bug JSONæ ¼å¼æ£€æŸ¥
      - id: check-toml
        name: é›¶Bug TOMLæ ¼å¼æ£€æŸ¥
      - id: end-of-file-fixer
        name: é›¶Bugæ–‡ä»¶ç»“å°¾æ£€æŸ¥
      - id: trailing-whitespace
        name: é›¶Bugç©ºæ ¼æ£€æŸ¥
      - id: debug-statements
        name: é›¶Bugè°ƒè¯•è¯­å¥æ£€æŸ¥
      - id: name-tests-test
        name: é›¶Bugæµ‹è¯•å‘½åæ£€æŸ¥
        args: ['--pytest-test-first']

  # ç¬¬åå±‚ï¼šé›¶Bugç‰¹å®šè´¨é‡æ£€æŸ¥
  - repo: local
    hooks:
      # ç¡¬ç¼–ç å¯†é’¥æ£€æŸ¥
      - id: zero-bug-secrets-check
        name: é›¶Bugå¯†é’¥æ³„éœ²æ£€æŸ¥
        entry: uv run python -c "
import re
import os
import sys

# å¯†é’¥æ¨¡å¼
secret_patterns = [
    r'password\\s*=\\s*[\"\\']?[^\"\\'\n]{4,}[\"\\']?',
    r'api_key\\s*=\\s*[\"\\']?[^\"\\'\n]{4,}[\"\\']?',
    r'secret\\s*=\\s*[\"\\']?[^\"\\'\n]{4,}[\"\\']?',
    r'token\\s*=\\s*[\"\\']?[^\"\\'\n]{4,}[\"\\']?',
    r'private_key\\s*=\\s*[\"\\']?[^\"\\'\n]{10,}[\"\\']?',
]

def check_file_for_secrets(file_path):
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()

        for line_num, line in enumerate(content.split('\\n'), 1):
            # è·³è¿‡æ³¨é‡Šè¡Œå’Œæµ‹è¯•æ–‡ä»¶
            if line.strip().startswith('#') or '/tests/' in file_path:
                continue

            for pattern in secret_patterns:
                if re.search(pattern, line, re.IGNORECASE):
                    print(f'åœ¨æ–‡ä»¶ {file_path}:{line_num} å‘ç°å¯èƒ½çš„å¯†é’¥æ³„éœ²')
                    print(f'å†…å®¹: {line.strip()}')
                    return False
        return True
    except Exception:
        return True  # æ— æ³•è¯»å–çš„æ–‡ä»¶è·³è¿‡æ£€æŸ¥

exit_code = 0
for root, dirs, files in os.walk('src'):
    for file in files:
        if file.endswith('.py'):
            file_path = os.path.join(root, file)
            if not check_file_for_secrets(file_path):
                exit_code = 1

sys.exit(exit_code)
"
        language: system
        pass_filenames: false
        always_run: true

      # TODOæ³¨é‡Šæ£€æŸ¥
      - id: zero-bug-todo-check
        name: é›¶Bug TODOæ³¨é‡Šæ£€æŸ¥
        entry: uv run python -c "
import re
import os
import sys

todo_count = 0
for root, dirs, files in os.walk('src'):
    for file in files:
        if file.endswith('.py'):
            file_path = os.path.join(root, file)
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()

                # æŸ¥æ‰¾TODOæ³¨é‡Š
                todos = re.findall(r'#\\s*TODO.*$', content, re.MULTILINE)
                if todos:
                    print(f'{file_path} åŒ…å« {len(todos)} ä¸ª TODO:')
                    for todo in todos:
                        print(f'  - {todo.strip()}')
                    todo_count += len(todos)
            except Exception:
                pass

if todo_count > 0:
    print(f'\\næ€»å…±å‘ç° {todo_count} ä¸ª TODO æ³¨é‡Š')
    print('é›¶Bugæ ‡å‡†è¦æ±‚åœ¨æäº¤å‰è§£å†³æ‰€æœ‰ TODO')
    sys.exit(1)
else:
    print('æœªå‘ç° TODO æ³¨é‡Šï¼Œç¬¦åˆé›¶Bugæ ‡å‡†')
"
        language: system
        pass_filenames: false
        always_run: true

# å…¨å±€é…ç½®
default_language_version:
  python: python3.12

# CIé…ç½®
ci:
  autofix_commit_msg: |
    ğŸ¤– é›¶Bugè‡ªåŠ¨ä¿®å¤

    é›¶Bugæµ‹è¯•ä½“ç³»è‡ªåŠ¨ä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š
    - ä»£ç æ ¼å¼åŒ–
    - å¯¼å…¥æ’åº
    - åŸºç¡€è¯­æ³•é”™è¯¯
    - æ–‡ä»¶æ ¼å¼é—®é¢˜

    ğŸ¤– Generated with [é›¶Bugæµ‹è¯•ä½“ç³»](https://github.com/zero-bug-testing)
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: ğŸ¤– é›¶Bugè‡ªåŠ¨æ›´æ–°pre-commit hooks
  autoupdate_schedule: weekly
  skip: []
  submodules: false