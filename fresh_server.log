INFO:     Will watch for changes in these directories: ['/Users/zalelee/Code/tatake_backend']
INFO:     Uvicorn running on http://0.0.0.0:8001 (Press CTRL+C to quit)
INFO:     Started reloader process [37605] using WatchFiles
INFO:     Started server process [37611]
INFO:     Waiting for application startup.
🚀 TaKeKe API v1.0.0 正在启动...
📝 环境: 开发
🌐 API服务地址: http://0.0.0.0:8001
✅ 简化认证数据库表创建成功（auth + auth_audit_logs）
✅ 认证数据库初始化完成
2025-10-25 00:51:10,451 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:10,451 INFO sqlalchemy.engine.Engine SELECT 1
2025-10-25 00:51:10,451 INFO sqlalchemy.engine.Engine [generated in 0.00007s] ()
2025-10-25 00:51:10,451 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:10,451 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:10,451 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth")
2025-10-25 00:51:10,451 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth_audit_logs")
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("tasks")
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("points_transactions")
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("rewards")
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_recipes")
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_transactions")
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("task_top3")
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("focus_sessions")
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine COMMIT
✅ 任务数据库初始化完成
2025-10-25 00:51:10,452 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:10,455 INFO sqlalchemy.engine.Engine SELECT rewards.id, rewards.name, rewards.description, rewards.points_value, rewards.image_url, rewards.cost_type, rewards.cost_value, rewards.stock_quantity, rewards.category, rewards.is_active, rewards.created_at, rewards.updated_at 
FROM rewards 
WHERE rewards.name = ?
2025-10-25 00:51:10,455 INFO sqlalchemy.engine.Engine [generated in 0.00008s] ('小金币',)
2025-10-25 00:51:10,455 INFO sqlalchemy.engine.Engine SELECT rewards.id, rewards.name, rewards.description, rewards.points_value, rewards.image_url, rewards.cost_type, rewards.cost_value, rewards.stock_quantity, rewards.category, rewards.is_active, rewards.created_at, rewards.updated_at 
FROM rewards 
WHERE rewards.name = ?
2025-10-25 00:51:10,455 INFO sqlalchemy.engine.Engine [cached since 0.00042s ago] ('钻石',)
2025-10-25 00:51:10,455 INFO sqlalchemy.engine.Engine SELECT reward_recipes.id, reward_recipes.name, reward_recipes.result_reward_id, reward_recipes.materials, reward_recipes.is_active, reward_recipes.created_at, reward_recipes.updated_at 
FROM reward_recipes 
WHERE reward_recipes.name = ?
2025-10-25 00:51:10,455 INFO sqlalchemy.engine.Engine [generated in 0.00003s] ('小金币合成钻石',)
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine COMMIT
✅ 奖励数据库初始化完成
✅ 聊天数据库初始化完成
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth")
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth_audit_logs")
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("tasks")
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("points_transactions")
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("rewards")
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_recipes")
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_transactions")
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("task_top3")
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("focus_sessions")
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:51:10,456 INFO sqlalchemy.engine.Engine COMMIT
INFO:     Application startup complete.
✅ Focus数据库初始化完成
✅ API服务启动完成
INFO:     127.0.0.1:63130 - "POST /auth/register HTTP/1.1" 200 OK
2025-10-25 00:51:16,837 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:16,837 INFO sqlalchemy.engine.Engine INSERT INTO tasks (id, created_at, updated_at, user_id, title, description, parent_id, status, priority, is_deleted, completion_percentage, last_claimed_date, tags, service_ids, due_date, planned_start_time, planned_end_time) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-10-25 00:51:16,837 INFO sqlalchemy.engine.Engine [generated in 0.00010s] ('eb133921-43d3-412e-95af-afa5c0674850', '2025-10-24 16:51:16.837223', '2025-10-24 16:51:16.837224', 'f8f01b03-bcbe-4996-9e51-70f9440113ab', '简化防刷测试任务', '测试防刷机制', None, 'pending', 'high', 0, 0.0, None, '[]', '[]', None, None, None)
2025-10-25 00:51:16,838 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ?
2025-10-25 00:51:16,838 INFO sqlalchemy.engine.Engine [generated in 0.00004s] ('eb133921-43d3-412e-95af-afa5c0674850',)
2025-10-25 00:51:16,838 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:16,839 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:16,839 INFO sqlalchemy.engine.Engine SELECT tasks.id AS tasks_id, tasks.created_at AS tasks_created_at, tasks.updated_at AS tasks_updated_at, tasks.user_id AS tasks_user_id, tasks.title AS tasks_title, tasks.description AS tasks_description, tasks.parent_id AS tasks_parent_id, tasks.status AS tasks_status, tasks.priority AS tasks_priority, tasks.is_deleted AS tasks_is_deleted, tasks.completion_percentage AS tasks_completion_percentage, tasks.last_claimed_date AS tasks_last_claimed_date, tasks.tags AS tasks_tags, tasks.service_ids AS tasks_service_ids, tasks.due_date AS tasks_due_date, tasks.planned_start_time AS tasks_planned_start_time, tasks.planned_end_time AS tasks_planned_end_time 
FROM tasks 
WHERE tasks.id = ?
2025-10-25 00:51:16,839 INFO sqlalchemy.engine.Engine [generated in 0.00003s] ('eb133921-43d3-412e-95af-afa5c0674850',)
INFO:     127.0.0.1:63132 - "POST /tasks/ HTTP/1.1" 200 OK
2025-10-25 00:51:16,839 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:16,841 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:16,842 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:16,842 INFO sqlalchemy.engine.Engine [generated in 0.00005s] ('eb133921-43d3-412e-95af-afa5c0674850', 'f8f01b03-bcbe-4996-9e51-70f9440113ab')
2025-10-25 00:51:16,842 INFO sqlalchemy.engine.Engine SELECT task_top3.id, task_top3.created_at, task_top3.updated_at, task_top3.user_id, task_top3.top_date, task_top3.task_ids, task_top3.points_consumed 
FROM task_top3 
WHERE task_top3.user_id = ? AND task_top3.top_date = ?
2025-10-25 00:51:16,842 INFO sqlalchemy.engine.Engine [generated in 0.00005s] ('f8f01b03-bcbe-4996-9e51-70f9440113ab', '2025-10-25')
2025-10-25 00:51:16,842 INFO sqlalchemy.engine.Engine 
                        SELECT id, status, title, last_claimed_date
                        FROM tasks
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:16,842 INFO sqlalchemy.engine.Engine [generated in 0.00003s] ('eb133921-43d3-412e-95af-afa5c0674850', 'f8f01b03-bcbe-4996-9e51-70f9440113ab')
🔍 DEBUG: Task eb133921-43d3-412e-95af-afa5c0674850 - status: pending, last_claimed_date: None, today: 2025-10-25, type_check: <class 'NoneType'> == <class 'datetime.date'>
2025-10-25 00:51:16,843 INFO sqlalchemy.engine.Engine INSERT INTO points_transactions (id, updated_at, user_id, amount, source_type, source_id, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)
2025-10-25 00:51:16,843 INFO sqlalchemy.engine.Engine [generated in 0.00004s] ('21ac685e-1526-401e-a664-a852c5787062', '2025-10-24 16:51:16.842940', 'f8f01b03-bcbe-4996-9e51-70f9440113ab', 2, 'task_complete', 'eb133921-43d3-412e-95af-afa5c0674850', '2025-10-24 16:51:16.842891')
2025-10-25 00:51:16,843 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:16,843 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:16,844 INFO sqlalchemy.engine.Engine SELECT points_transactions.id AS points_transactions_id, points_transactions.updated_at AS points_transactions_updated_at, points_transactions.user_id AS points_transactions_user_id, points_transactions.amount AS points_transactions_amount, points_transactions.source_type AS points_transactions_source_type, points_transactions.source_id AS points_transactions_source_id, points_transactions.created_at AS points_transactions_created_at 
FROM points_transactions 
WHERE points_transactions.id = ?
2025-10-25 00:51:16,844 INFO sqlalchemy.engine.Engine [generated in 0.00003s] ('21ac685e-1526-401e-a664-a852c5787062',)
2025-10-25 00:51:16,844 INFO sqlalchemy.engine.Engine 
                        UPDATE tasks
                        SET status = 'completed',
                            last_claimed_date = ?,
                            updated_at = ?
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:16,844 INFO sqlalchemy.engine.Engine [generated in 0.00003s] (datetime.date(2025, 10, 25), datetime.datetime(2025, 10, 24, 16, 51, 16, 844359, tzinfo=datetime.timezone.utc), 'eb133921-43d3-412e-95af-afa5c0674850', 'f8f01b03-bcbe-4996-9e51-70f9440113ab')
2025-10-25 00:51:16,844 INFO sqlalchemy.engine.Engine 
                        SELECT parent_id FROM tasks
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:16,844 INFO sqlalchemy.engine.Engine [generated in 0.00002s] ('eb133921-43d3-412e-95af-afa5c0674850', 'f8f01b03-bcbe-4996-9e51-70f9440113ab')
2025-10-25 00:51:16,844 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:16,845 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:16,845 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:16,845 INFO sqlalchemy.engine.Engine [cached since 0.003118s ago] ('eb133921-43d3-412e-95af-afa5c0674850', 'f8f01b03-bcbe-4996-9e51-70f9440113ab')
INFO:     127.0.0.1:63134 - "POST /tasks/eb133921-43d3-412e-95af-afa5c0674850/complete HTTP/1.1" 200 OK
2025-10-25 00:51:16,845 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:16,846 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:16,847 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:16,847 INFO sqlalchemy.engine.Engine [cached since 0.005043s ago] ('eb133921-43d3-412e-95af-afa5c0674850', 'f8f01b03-bcbe-4996-9e51-70f9440113ab')
2025-10-25 00:51:16,847 INFO sqlalchemy.engine.Engine 
                    UPDATE tasks
                    SET status = 'pending', updated_at = ?
                    WHERE id = ? AND user_id = ?
                
2025-10-25 00:51:16,847 INFO sqlalchemy.engine.Engine [generated in 0.00003s] (datetime.datetime(2025, 10, 24, 16, 51, 16, 847128, tzinfo=datetime.timezone.utc), 'eb133921-43d3-412e-95af-afa5c0674850', 'f8f01b03-bcbe-4996-9e51-70f9440113ab')
2025-10-25 00:51:16,847 INFO sqlalchemy.engine.Engine 
                        SELECT parent_id FROM tasks
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:16,847 INFO sqlalchemy.engine.Engine [cached since 0.002766s ago] ('eb133921-43d3-412e-95af-afa5c0674850', 'f8f01b03-bcbe-4996-9e51-70f9440113ab')
2025-10-25 00:51:16,847 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:16,847 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:16,847 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:16,847 INFO sqlalchemy.engine.Engine [cached since 0.005774s ago] ('eb133921-43d3-412e-95af-afa5c0674850', 'f8f01b03-bcbe-4996-9e51-70f9440113ab')
INFO:     127.0.0.1:63136 - "POST /tasks/eb133921-43d3-412e-95af-afa5c0674850/uncomplete HTTP/1.1" 200 OK
2025-10-25 00:51:16,848 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:16,849 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:16,849 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:16,849 INFO sqlalchemy.engine.Engine [cached since 0.007287s ago] ('eb133921-43d3-412e-95af-afa5c0674850', 'f8f01b03-bcbe-4996-9e51-70f9440113ab')
INFO:     127.0.0.1:63138 - "POST /tasks/eb133921-43d3-412e-95af-afa5c0674850/complete HTTP/1.1" 200 OK
2025-10-25 00:51:16,849 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:63195 - "POST /auth/register HTTP/1.1" 200 OK
2025-10-25 00:51:19,393 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:19,393 INFO sqlalchemy.engine.Engine INSERT INTO tasks (id, created_at, updated_at, user_id, title, description, parent_id, status, priority, is_deleted, completion_percentage, last_claimed_date, tags, service_ids, due_date, planned_start_time, planned_end_time) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-10-25 00:51:19,394 INFO sqlalchemy.engine.Engine [cached since 2.556s ago] ('4e56d83a-4fb4-4e46-a897-7105ecf24c96', '2025-10-24 16:51:19.393835', '2025-10-24 16:51:19.393835', 'a2c02516-64b0-49b4-8200-0464a55487ef', '防刷测试任务', '测试防刷机制和取消完成响应状态', None, 'pending', 'high', 0, 0.0, None, '["\\u6d4b\\u8bd5", "\\u9632\\u5237"]', '["test-service"]', None, None, None)
2025-10-25 00:51:19,394 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ?
2025-10-25 00:51:19,394 INFO sqlalchemy.engine.Engine [cached since 2.556s ago] ('4e56d83a-4fb4-4e46-a897-7105ecf24c96',)
2025-10-25 00:51:19,394 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:19,394 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:19,394 INFO sqlalchemy.engine.Engine SELECT tasks.id AS tasks_id, tasks.created_at AS tasks_created_at, tasks.updated_at AS tasks_updated_at, tasks.user_id AS tasks_user_id, tasks.title AS tasks_title, tasks.description AS tasks_description, tasks.parent_id AS tasks_parent_id, tasks.status AS tasks_status, tasks.priority AS tasks_priority, tasks.is_deleted AS tasks_is_deleted, tasks.completion_percentage AS tasks_completion_percentage, tasks.last_claimed_date AS tasks_last_claimed_date, tasks.tags AS tasks_tags, tasks.service_ids AS tasks_service_ids, tasks.due_date AS tasks_due_date, tasks.planned_start_time AS tasks_planned_start_time, tasks.planned_end_time AS tasks_planned_end_time 
FROM tasks 
WHERE tasks.id = ?
2025-10-25 00:51:19,394 INFO sqlalchemy.engine.Engine [cached since 2.555s ago] ('4e56d83a-4fb4-4e46-a897-7105ecf24c96',)
INFO:     127.0.0.1:63197 - "POST /tasks/ HTTP/1.1" 200 OK
2025-10-25 00:51:19,394 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:19,396 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:19,396 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:19,396 INFO sqlalchemy.engine.Engine [cached since 2.554s ago] ('4e56d83a-4fb4-4e46-a897-7105ecf24c96', 'a2c02516-64b0-49b4-8200-0464a55487ef')
2025-10-25 00:51:19,396 INFO sqlalchemy.engine.Engine SELECT task_top3.id, task_top3.created_at, task_top3.updated_at, task_top3.user_id, task_top3.top_date, task_top3.task_ids, task_top3.points_consumed 
FROM task_top3 
WHERE task_top3.user_id = ? AND task_top3.top_date = ?
2025-10-25 00:51:19,396 INFO sqlalchemy.engine.Engine [cached since 2.554s ago] ('a2c02516-64b0-49b4-8200-0464a55487ef', '2025-10-25')
2025-10-25 00:51:19,396 INFO sqlalchemy.engine.Engine 
                        SELECT id, status, title, last_claimed_date
                        FROM tasks
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:19,396 INFO sqlalchemy.engine.Engine [cached since 2.554s ago] ('4e56d83a-4fb4-4e46-a897-7105ecf24c96', 'a2c02516-64b0-49b4-8200-0464a55487ef')
🔍 DEBUG: Task 4e56d83a-4fb4-4e46-a897-7105ecf24c96 - status: pending, last_claimed_date: None, today: 2025-10-25, type_check: <class 'NoneType'> == <class 'datetime.date'>
2025-10-25 00:51:19,396 INFO sqlalchemy.engine.Engine INSERT INTO points_transactions (id, updated_at, user_id, amount, source_type, source_id, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)
2025-10-25 00:51:19,396 INFO sqlalchemy.engine.Engine [cached since 2.553s ago] ('cd8873cc-430b-4691-9e2d-233e2620abf0', '2025-10-24 16:51:19.396583', 'a2c02516-64b0-49b4-8200-0464a55487ef', 2, 'task_complete', '4e56d83a-4fb4-4e46-a897-7105ecf24c96', '2025-10-24 16:51:19.396547')
2025-10-25 00:51:19,396 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:19,397 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:19,397 INFO sqlalchemy.engine.Engine SELECT points_transactions.id AS points_transactions_id, points_transactions.updated_at AS points_transactions_updated_at, points_transactions.user_id AS points_transactions_user_id, points_transactions.amount AS points_transactions_amount, points_transactions.source_type AS points_transactions_source_type, points_transactions.source_id AS points_transactions_source_id, points_transactions.created_at AS points_transactions_created_at 
FROM points_transactions 
WHERE points_transactions.id = ?
2025-10-25 00:51:19,397 INFO sqlalchemy.engine.Engine [cached since 2.553s ago] ('cd8873cc-430b-4691-9e2d-233e2620abf0',)
2025-10-25 00:51:19,397 INFO sqlalchemy.engine.Engine 
                        UPDATE tasks
                        SET status = 'completed',
                            last_claimed_date = ?,
                            updated_at = ?
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:19,397 INFO sqlalchemy.engine.Engine [cached since 2.553s ago] (datetime.date(2025, 10, 25), datetime.datetime(2025, 10, 24, 16, 51, 19, 397290, tzinfo=datetime.timezone.utc), '4e56d83a-4fb4-4e46-a897-7105ecf24c96', 'a2c02516-64b0-49b4-8200-0464a55487ef')
2025-10-25 00:51:19,397 INFO sqlalchemy.engine.Engine 
                        SELECT parent_id FROM tasks
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:19,397 INFO sqlalchemy.engine.Engine [cached since 2.553s ago] ('4e56d83a-4fb4-4e46-a897-7105ecf24c96', 'a2c02516-64b0-49b4-8200-0464a55487ef')
2025-10-25 00:51:19,397 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:19,397 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:19,397 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:19,397 INFO sqlalchemy.engine.Engine [cached since 2.556s ago] ('4e56d83a-4fb4-4e46-a897-7105ecf24c96', 'a2c02516-64b0-49b4-8200-0464a55487ef')
INFO:     127.0.0.1:63199 - "POST /tasks/4e56d83a-4fb4-4e46-a897-7105ecf24c96/complete HTTP/1.1" 200 OK
2025-10-25 00:51:19,398 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:19,399 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:19,399 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:19,399 INFO sqlalchemy.engine.Engine [cached since 2.557s ago] ('4e56d83a-4fb4-4e46-a897-7105ecf24c96', 'a2c02516-64b0-49b4-8200-0464a55487ef')
INFO:     127.0.0.1:63201 - "POST /tasks/4e56d83a-4fb4-4e46-a897-7105ecf24c96/complete HTTP/1.1" 200 OK
2025-10-25 00:51:19,399 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:19,400 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:19,400 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:19,400 INFO sqlalchemy.engine.Engine [cached since 2.559s ago] ('4e56d83a-4fb4-4e46-a897-7105ecf24c96', 'a2c02516-64b0-49b4-8200-0464a55487ef')
2025-10-25 00:51:19,400 INFO sqlalchemy.engine.Engine 
                    UPDATE tasks
                    SET status = 'pending', updated_at = ?
                    WHERE id = ? AND user_id = ?
                
2025-10-25 00:51:19,400 INFO sqlalchemy.engine.Engine [cached since 2.554s ago] (datetime.datetime(2025, 10, 24, 16, 51, 19, 400711, tzinfo=datetime.timezone.utc), '4e56d83a-4fb4-4e46-a897-7105ecf24c96', 'a2c02516-64b0-49b4-8200-0464a55487ef')
2025-10-25 00:51:19,400 INFO sqlalchemy.engine.Engine 
                        SELECT parent_id FROM tasks
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:19,400 INFO sqlalchemy.engine.Engine [cached since 2.556s ago] ('4e56d83a-4fb4-4e46-a897-7105ecf24c96', 'a2c02516-64b0-49b4-8200-0464a55487ef')
2025-10-25 00:51:19,400 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:19,401 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:19,401 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:19,401 INFO sqlalchemy.engine.Engine [cached since 2.559s ago] ('4e56d83a-4fb4-4e46-a897-7105ecf24c96', 'a2c02516-64b0-49b4-8200-0464a55487ef')
INFO:     127.0.0.1:63203 - "POST /tasks/4e56d83a-4fb4-4e46-a897-7105ecf24c96/uncomplete HTTP/1.1" 200 OK
2025-10-25 00:51:19,401 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:19,402 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:19,402 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:19,402 INFO sqlalchemy.engine.Engine [cached since 2.561s ago] ('4e56d83a-4fb4-4e46-a897-7105ecf24c96', 'a2c02516-64b0-49b4-8200-0464a55487ef')
INFO:     127.0.0.1:63205 - "POST /tasks/4e56d83a-4fb4-4e46-a897-7105ecf24c96/complete HTTP/1.1" 200 OK
2025-10-25 00:51:19,402 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:19,403 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:19,403 INFO sqlalchemy.engine.Engine SELECT COALESCE(SUM(amount), 0) FROM points_transactions WHERE user_id = ?
2025-10-25 00:51:19,403 INFO sqlalchemy.engine.Engine [generated in 0.00003s] ('a2c02516-64b0-49b4-8200-0464a55487ef',)
2025-10-25 00:51:19,404 INFO sqlalchemy.engine.Engine SELECT points_transactions.id, points_transactions.updated_at, points_transactions.user_id, points_transactions.amount, points_transactions.source_type, points_transactions.source_id, points_transactions.created_at 
FROM points_transactions 
WHERE points_transactions.user_id = ? ORDER BY points_transactions.created_at DESC
 LIMIT ? OFFSET ?
2025-10-25 00:51:19,404 INFO sqlalchemy.engine.Engine [generated in 0.00005s] ('a2c02516-64b0-49b4-8200-0464a55487ef', 1000, 0)
INFO:     127.0.0.1:63207 - "GET /points/balance HTTP/1.1" 200 OK
2025-10-25 00:51:19,404 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:63305 - "POST /auth/register HTTP/1.1" 200 OK
2025-10-25 00:51:24,565 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,565 INFO sqlalchemy.engine.Engine SELECT COALESCE(SUM(amount), 0) FROM points_transactions WHERE user_id = ?
2025-10-25 00:51:24,565 INFO sqlalchemy.engine.Engine [cached since 5.162s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1',)
2025-10-25 00:51:24,565 INFO sqlalchemy.engine.Engine SELECT points_transactions.id, points_transactions.updated_at, points_transactions.user_id, points_transactions.amount, points_transactions.source_type, points_transactions.source_id, points_transactions.created_at 
FROM points_transactions 
WHERE points_transactions.user_id = ? ORDER BY points_transactions.created_at DESC
 LIMIT ? OFFSET ?
2025-10-25 00:51:24,565 INFO sqlalchemy.engine.Engine [cached since 5.161s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1', 1000, 0)
INFO:     127.0.0.1:63307 - "GET /points/balance HTTP/1.1" 200 OK
2025-10-25 00:51:24,565 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:24,566 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,567 INFO sqlalchemy.engine.Engine INSERT INTO tasks (id, created_at, updated_at, user_id, title, description, parent_id, status, priority, is_deleted, completion_percentage, last_claimed_date, tags, service_ids, due_date, planned_start_time, planned_end_time) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-10-25 00:51:24,567 INFO sqlalchemy.engine.Engine [cached since 7.729s ago] ('8621b2ab-4958-4337-bc43-79f91e26884f', '2025-10-24 16:51:24.566847', '2025-10-24 16:51:24.566847', '272e7cb8-87ed-42e0-b471-23e8bc90bde1', '防刷周期测试任务', '用于鲁棒性测试的任务', None, 'pending', 'high', 0, 0.0, None, '["\\u6d4b\\u8bd5", "\\u9c81\\u68d2"]', '["test-service"]', None, None, None)
2025-10-25 00:51:24,567 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ?
2025-10-25 00:51:24,567 INFO sqlalchemy.engine.Engine [cached since 7.729s ago] ('8621b2ab-4958-4337-bc43-79f91e26884f',)
2025-10-25 00:51:24,567 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:24,567 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,567 INFO sqlalchemy.engine.Engine SELECT tasks.id AS tasks_id, tasks.created_at AS tasks_created_at, tasks.updated_at AS tasks_updated_at, tasks.user_id AS tasks_user_id, tasks.title AS tasks_title, tasks.description AS tasks_description, tasks.parent_id AS tasks_parent_id, tasks.status AS tasks_status, tasks.priority AS tasks_priority, tasks.is_deleted AS tasks_is_deleted, tasks.completion_percentage AS tasks_completion_percentage, tasks.last_claimed_date AS tasks_last_claimed_date, tasks.tags AS tasks_tags, tasks.service_ids AS tasks_service_ids, tasks.due_date AS tasks_due_date, tasks.planned_start_time AS tasks_planned_start_time, tasks.planned_end_time AS tasks_planned_end_time 
FROM tasks 
WHERE tasks.id = ?
2025-10-25 00:51:24,567 INFO sqlalchemy.engine.Engine [cached since 7.728s ago] ('8621b2ab-4958-4337-bc43-79f91e26884f',)
INFO:     127.0.0.1:63309 - "POST /tasks/ HTTP/1.1" 200 OK
2025-10-25 00:51:24,568 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:24,568 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,568 INFO sqlalchemy.engine.Engine SELECT COALESCE(SUM(amount), 0) FROM points_transactions WHERE user_id = ?
2025-10-25 00:51:24,568 INFO sqlalchemy.engine.Engine [cached since 5.165s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1',)
2025-10-25 00:51:24,569 INFO sqlalchemy.engine.Engine SELECT points_transactions.id, points_transactions.updated_at, points_transactions.user_id, points_transactions.amount, points_transactions.source_type, points_transactions.source_id, points_transactions.created_at 
FROM points_transactions 
WHERE points_transactions.user_id = ? ORDER BY points_transactions.created_at DESC
 LIMIT ? OFFSET ?
2025-10-25 00:51:24,569 INFO sqlalchemy.engine.Engine [cached since 5.165s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1', 1000, 0)
INFO:     127.0.0.1:63311 - "GET /points/balance HTTP/1.1" 200 OK
2025-10-25 00:51:24,569 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:24,570 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,570 INFO sqlalchemy.engine.Engine SELECT COALESCE(SUM(amount), 0) FROM points_transactions WHERE user_id = ?
2025-10-25 00:51:24,570 INFO sqlalchemy.engine.Engine [cached since 5.167s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1',)
2025-10-25 00:51:24,570 INFO sqlalchemy.engine.Engine SELECT points_transactions.id, points_transactions.updated_at, points_transactions.user_id, points_transactions.amount, points_transactions.source_type, points_transactions.source_id, points_transactions.created_at 
FROM points_transactions 
WHERE points_transactions.user_id = ? ORDER BY points_transactions.created_at DESC
 LIMIT ? OFFSET ?
2025-10-25 00:51:24,570 INFO sqlalchemy.engine.Engine [cached since 5.167s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1', 1000, 0)
INFO:     127.0.0.1:63313 - "GET /points/balance HTTP/1.1" 200 OK
2025-10-25 00:51:24,571 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:24,572 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,572 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:24,572 INFO sqlalchemy.engine.Engine [cached since 7.731s ago] ('8621b2ab-4958-4337-bc43-79f91e26884f', '272e7cb8-87ed-42e0-b471-23e8bc90bde1')
2025-10-25 00:51:24,572 INFO sqlalchemy.engine.Engine SELECT task_top3.id, task_top3.created_at, task_top3.updated_at, task_top3.user_id, task_top3.top_date, task_top3.task_ids, task_top3.points_consumed 
FROM task_top3 
WHERE task_top3.user_id = ? AND task_top3.top_date = ?
2025-10-25 00:51:24,572 INFO sqlalchemy.engine.Engine [cached since 7.73s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1', '2025-10-25')
2025-10-25 00:51:24,572 INFO sqlalchemy.engine.Engine 
                        SELECT id, status, title, last_claimed_date
                        FROM tasks
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:24,572 INFO sqlalchemy.engine.Engine [cached since 7.73s ago] ('8621b2ab-4958-4337-bc43-79f91e26884f', '272e7cb8-87ed-42e0-b471-23e8bc90bde1')
🔍 DEBUG: Task 8621b2ab-4958-4337-bc43-79f91e26884f - status: pending, last_claimed_date: None, today: 2025-10-25, type_check: <class 'NoneType'> == <class 'datetime.date'>
2025-10-25 00:51:24,572 INFO sqlalchemy.engine.Engine INSERT INTO points_transactions (id, updated_at, user_id, amount, source_type, source_id, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)
2025-10-25 00:51:24,572 INFO sqlalchemy.engine.Engine [cached since 7.73s ago] ('3cc5a545-dd2a-49fe-ae7d-2d2f67cd22cd', '2025-10-24 16:51:24.572886', '272e7cb8-87ed-42e0-b471-23e8bc90bde1', 2, 'task_complete', '8621b2ab-4958-4337-bc43-79f91e26884f', '2025-10-24 16:51:24.572852')
2025-10-25 00:51:24,573 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:24,573 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,573 INFO sqlalchemy.engine.Engine SELECT points_transactions.id AS points_transactions_id, points_transactions.updated_at AS points_transactions_updated_at, points_transactions.user_id AS points_transactions_user_id, points_transactions.amount AS points_transactions_amount, points_transactions.source_type AS points_transactions_source_type, points_transactions.source_id AS points_transactions_source_id, points_transactions.created_at AS points_transactions_created_at 
FROM points_transactions 
WHERE points_transactions.id = ?
2025-10-25 00:51:24,573 INFO sqlalchemy.engine.Engine [cached since 7.729s ago] ('3cc5a545-dd2a-49fe-ae7d-2d2f67cd22cd',)
2025-10-25 00:51:24,573 INFO sqlalchemy.engine.Engine 
                        UPDATE tasks
                        SET status = 'completed',
                            last_claimed_date = ?,
                            updated_at = ?
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:24,573 INFO sqlalchemy.engine.Engine [cached since 7.729s ago] (datetime.date(2025, 10, 25), datetime.datetime(2025, 10, 24, 16, 51, 24, 573475, tzinfo=datetime.timezone.utc), '8621b2ab-4958-4337-bc43-79f91e26884f', '272e7cb8-87ed-42e0-b471-23e8bc90bde1')
2025-10-25 00:51:24,573 INFO sqlalchemy.engine.Engine 
                        SELECT parent_id FROM tasks
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:24,573 INFO sqlalchemy.engine.Engine [cached since 7.729s ago] ('8621b2ab-4958-4337-bc43-79f91e26884f', '272e7cb8-87ed-42e0-b471-23e8bc90bde1')
2025-10-25 00:51:24,573 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:24,573 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,573 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:24,573 INFO sqlalchemy.engine.Engine [cached since 7.732s ago] ('8621b2ab-4958-4337-bc43-79f91e26884f', '272e7cb8-87ed-42e0-b471-23e8bc90bde1')
INFO:     127.0.0.1:63315 - "POST /tasks/8621b2ab-4958-4337-bc43-79f91e26884f/complete HTTP/1.1" 200 OK
2025-10-25 00:51:24,574 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:24,575 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,575 INFO sqlalchemy.engine.Engine SELECT COALESCE(SUM(amount), 0) FROM points_transactions WHERE user_id = ?
2025-10-25 00:51:24,575 INFO sqlalchemy.engine.Engine [cached since 5.171s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1',)
2025-10-25 00:51:24,575 INFO sqlalchemy.engine.Engine SELECT points_transactions.id, points_transactions.updated_at, points_transactions.user_id, points_transactions.amount, points_transactions.source_type, points_transactions.source_id, points_transactions.created_at 
FROM points_transactions 
WHERE points_transactions.user_id = ? ORDER BY points_transactions.created_at DESC
 LIMIT ? OFFSET ?
2025-10-25 00:51:24,575 INFO sqlalchemy.engine.Engine [cached since 5.171s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1', 1000, 0)
INFO:     127.0.0.1:63317 - "GET /points/balance HTTP/1.1" 200 OK
2025-10-25 00:51:24,575 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:24,576 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,577 INFO sqlalchemy.engine.Engine INSERT INTO tasks (id, created_at, updated_at, user_id, title, description, parent_id, status, priority, is_deleted, completion_percentage, last_claimed_date, tags, service_ids, due_date, planned_start_time, planned_end_time) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-10-25 00:51:24,577 INFO sqlalchemy.engine.Engine [cached since 7.739s ago] ('897e790c-c055-4d3e-84fc-d76304a8bd2f', '2025-10-24 16:51:24.576882', '2025-10-24 16:51:24.576882', '272e7cb8-87ed-42e0-b471-23e8bc90bde1', '响应一致性测试', '用于鲁棒性测试的任务', None, 'pending', 'high', 0, 0.0, None, '["\\u6d4b\\u8bd5", "\\u9c81\\u68d2"]', '["test-service"]', None, None, None)
2025-10-25 00:51:24,577 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ?
2025-10-25 00:51:24,577 INFO sqlalchemy.engine.Engine [cached since 7.739s ago] ('897e790c-c055-4d3e-84fc-d76304a8bd2f',)
2025-10-25 00:51:24,577 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:24,577 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,577 INFO sqlalchemy.engine.Engine SELECT tasks.id AS tasks_id, tasks.created_at AS tasks_created_at, tasks.updated_at AS tasks_updated_at, tasks.user_id AS tasks_user_id, tasks.title AS tasks_title, tasks.description AS tasks_description, tasks.parent_id AS tasks_parent_id, tasks.status AS tasks_status, tasks.priority AS tasks_priority, tasks.is_deleted AS tasks_is_deleted, tasks.completion_percentage AS tasks_completion_percentage, tasks.last_claimed_date AS tasks_last_claimed_date, tasks.tags AS tasks_tags, tasks.service_ids AS tasks_service_ids, tasks.due_date AS tasks_due_date, tasks.planned_start_time AS tasks_planned_start_time, tasks.planned_end_time AS tasks_planned_end_time 
FROM tasks 
WHERE tasks.id = ?
2025-10-25 00:51:24,577 INFO sqlalchemy.engine.Engine [cached since 7.738s ago] ('897e790c-c055-4d3e-84fc-d76304a8bd2f',)
INFO:     127.0.0.1:63319 - "POST /tasks/ HTTP/1.1" 200 OK
2025-10-25 00:51:24,577 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:24,578 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,578 INFO sqlalchemy.engine.Engine SELECT COALESCE(SUM(amount), 0) FROM points_transactions WHERE user_id = ?
2025-10-25 00:51:24,578 INFO sqlalchemy.engine.Engine [cached since 5.175s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1',)
2025-10-25 00:51:24,578 INFO sqlalchemy.engine.Engine SELECT points_transactions.id, points_transactions.updated_at, points_transactions.user_id, points_transactions.amount, points_transactions.source_type, points_transactions.source_id, points_transactions.created_at 
FROM points_transactions 
WHERE points_transactions.user_id = ? ORDER BY points_transactions.created_at DESC
 LIMIT ? OFFSET ?
2025-10-25 00:51:24,578 INFO sqlalchemy.engine.Engine [cached since 5.174s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1', 1000, 0)
INFO:     127.0.0.1:63321 - "GET /points/balance HTTP/1.1" 200 OK
2025-10-25 00:51:24,579 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:24,580 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,580 INFO sqlalchemy.engine.Engine SELECT COALESCE(SUM(amount), 0) FROM points_transactions WHERE user_id = ?
2025-10-25 00:51:24,580 INFO sqlalchemy.engine.Engine [cached since 5.176s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1',)
2025-10-25 00:51:24,580 INFO sqlalchemy.engine.Engine SELECT points_transactions.id, points_transactions.updated_at, points_transactions.user_id, points_transactions.amount, points_transactions.source_type, points_transactions.source_id, points_transactions.created_at 
FROM points_transactions 
WHERE points_transactions.user_id = ? ORDER BY points_transactions.created_at DESC
 LIMIT ? OFFSET ?
2025-10-25 00:51:24,580 INFO sqlalchemy.engine.Engine [cached since 5.176s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1', 1000, 0)
INFO:     127.0.0.1:63323 - "GET /points/balance HTTP/1.1" 200 OK
2025-10-25 00:51:24,580 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:24,581 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,581 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:24,581 INFO sqlalchemy.engine.Engine [cached since 7.74s ago] ('897e790c-c055-4d3e-84fc-d76304a8bd2f', '272e7cb8-87ed-42e0-b471-23e8bc90bde1')
2025-10-25 00:51:24,582 INFO sqlalchemy.engine.Engine SELECT task_top3.id, task_top3.created_at, task_top3.updated_at, task_top3.user_id, task_top3.top_date, task_top3.task_ids, task_top3.points_consumed 
FROM task_top3 
WHERE task_top3.user_id = ? AND task_top3.top_date = ?
2025-10-25 00:51:24,582 INFO sqlalchemy.engine.Engine [cached since 7.739s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1', '2025-10-25')
2025-10-25 00:51:24,582 INFO sqlalchemy.engine.Engine 
                        SELECT id, status, title, last_claimed_date
                        FROM tasks
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:24,582 INFO sqlalchemy.engine.Engine [cached since 7.739s ago] ('897e790c-c055-4d3e-84fc-d76304a8bd2f', '272e7cb8-87ed-42e0-b471-23e8bc90bde1')
🔍 DEBUG: Task 897e790c-c055-4d3e-84fc-d76304a8bd2f - status: pending, last_claimed_date: None, today: 2025-10-25, type_check: <class 'NoneType'> == <class 'datetime.date'>
2025-10-25 00:51:24,582 INFO sqlalchemy.engine.Engine INSERT INTO points_transactions (id, updated_at, user_id, amount, source_type, source_id, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)
2025-10-25 00:51:24,582 INFO sqlalchemy.engine.Engine [cached since 7.739s ago] ('2d12e887-f94c-47fe-8ce4-095730631b0a', '2025-10-24 16:51:24.582284', '272e7cb8-87ed-42e0-b471-23e8bc90bde1', 2, 'task_complete', '897e790c-c055-4d3e-84fc-d76304a8bd2f', '2025-10-24 16:51:24.582247')
2025-10-25 00:51:24,582 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:24,582 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,582 INFO sqlalchemy.engine.Engine SELECT points_transactions.id AS points_transactions_id, points_transactions.updated_at AS points_transactions_updated_at, points_transactions.user_id AS points_transactions_user_id, points_transactions.amount AS points_transactions_amount, points_transactions.source_type AS points_transactions_source_type, points_transactions.source_id AS points_transactions_source_id, points_transactions.created_at AS points_transactions_created_at 
FROM points_transactions 
WHERE points_transactions.id = ?
2025-10-25 00:51:24,582 INFO sqlalchemy.engine.Engine [cached since 7.739s ago] ('2d12e887-f94c-47fe-8ce4-095730631b0a',)
2025-10-25 00:51:24,582 INFO sqlalchemy.engine.Engine 
                        UPDATE tasks
                        SET status = 'completed',
                            last_claimed_date = ?,
                            updated_at = ?
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:24,582 INFO sqlalchemy.engine.Engine [cached since 7.738s ago] (datetime.date(2025, 10, 25), datetime.datetime(2025, 10, 24, 16, 51, 24, 582937, tzinfo=datetime.timezone.utc), '897e790c-c055-4d3e-84fc-d76304a8bd2f', '272e7cb8-87ed-42e0-b471-23e8bc90bde1')
2025-10-25 00:51:24,583 INFO sqlalchemy.engine.Engine 
                        SELECT parent_id FROM tasks
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:51:24,583 INFO sqlalchemy.engine.Engine [cached since 7.738s ago] ('897e790c-c055-4d3e-84fc-d76304a8bd2f', '272e7cb8-87ed-42e0-b471-23e8bc90bde1')
2025-10-25 00:51:24,583 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:51:24,583 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,583 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:51:24,583 INFO sqlalchemy.engine.Engine [cached since 7.741s ago] ('897e790c-c055-4d3e-84fc-d76304a8bd2f', '272e7cb8-87ed-42e0-b471-23e8bc90bde1')
INFO:     127.0.0.1:63325 - "POST /tasks/897e790c-c055-4d3e-84fc-d76304a8bd2f/complete HTTP/1.1" 200 OK
2025-10-25 00:51:24,583 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:51:24,584 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:51:24,584 INFO sqlalchemy.engine.Engine SELECT COALESCE(SUM(amount), 0) FROM points_transactions WHERE user_id = ?
2025-10-25 00:51:24,584 INFO sqlalchemy.engine.Engine [cached since 5.181s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1',)
2025-10-25 00:51:24,584 INFO sqlalchemy.engine.Engine SELECT points_transactions.id, points_transactions.updated_at, points_transactions.user_id, points_transactions.amount, points_transactions.source_type, points_transactions.source_id, points_transactions.created_at 
FROM points_transactions 
WHERE points_transactions.user_id = ? ORDER BY points_transactions.created_at DESC
 LIMIT ? OFFSET ?
2025-10-25 00:51:24,584 INFO sqlalchemy.engine.Engine [cached since 5.181s ago] ('272e7cb8-87ed-42e0-b471-23e8bc90bde1', 1000, 0)
INFO:     127.0.0.1:63327 - "GET /points/balance HTTP/1.1" 200 OK
2025-10-25 00:51:24,585 INFO sqlalchemy.engine.Engine ROLLBACK
WARNING:  WatchFiles detected changes in 'debug_balance_api.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [37611]
INFO:     Started server process [38050]
INFO:     Waiting for application startup.
🚀 TaKeKe API v1.0.0 正在启动...
📝 环境: 开发
🌐 API服务地址: http://0.0.0.0:8001
✅ 简化认证数据库表创建成功（auth + auth_audit_logs）
✅ 认证数据库初始化完成
2025-10-25 00:52:50,693 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:52:50,693 INFO sqlalchemy.engine.Engine SELECT 1
2025-10-25 00:52:50,693 INFO sqlalchemy.engine.Engine [generated in 0.00007s] ()
2025-10-25 00:52:50,693 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:52:50,693 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:52:50,693 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth")
2025-10-25 00:52:50,693 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,693 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth_audit_logs")
2025-10-25 00:52:50,693 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,693 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("tasks")
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("points_transactions")
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("rewards")
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_recipes")
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_transactions")
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("task_top3")
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("focus_sessions")
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine COMMIT
✅ 任务数据库初始化完成
2025-10-25 00:52:50,694 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:52:50,696 INFO sqlalchemy.engine.Engine SELECT rewards.id, rewards.name, rewards.description, rewards.points_value, rewards.image_url, rewards.cost_type, rewards.cost_value, rewards.stock_quantity, rewards.category, rewards.is_active, rewards.created_at, rewards.updated_at 
FROM rewards 
WHERE rewards.name = ?
2025-10-25 00:52:50,696 INFO sqlalchemy.engine.Engine [generated in 0.00005s] ('小金币',)
2025-10-25 00:52:50,697 INFO sqlalchemy.engine.Engine SELECT rewards.id, rewards.name, rewards.description, rewards.points_value, rewards.image_url, rewards.cost_type, rewards.cost_value, rewards.stock_quantity, rewards.category, rewards.is_active, rewards.created_at, rewards.updated_at 
FROM rewards 
WHERE rewards.name = ?
2025-10-25 00:52:50,697 INFO sqlalchemy.engine.Engine [cached since 0.0003235s ago] ('钻石',)
2025-10-25 00:52:50,697 INFO sqlalchemy.engine.Engine SELECT reward_recipes.id, reward_recipes.name, reward_recipes.result_reward_id, reward_recipes.materials, reward_recipes.is_active, reward_recipes.created_at, reward_recipes.updated_at 
FROM reward_recipes 
WHERE reward_recipes.name = ?
2025-10-25 00:52:50,697 INFO sqlalchemy.engine.Engine [generated in 0.00004s] ('小金币合成钻石',)
2025-10-25 00:52:50,697 INFO sqlalchemy.engine.Engine COMMIT
✅ 奖励数据库初始化完成
✅ 聊天数据库初始化完成
2025-10-25 00:52:50,697 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:52:50,697 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth")
2025-10-25 00:52:50,697 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,697 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth_audit_logs")
2025-10-25 00:52:50,697 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,697 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("tasks")
2025-10-25 00:52:50,697 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("points_transactions")
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("rewards")
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_recipes")
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_transactions")
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("task_top3")
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("focus_sessions")
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:52:50,698 INFO sqlalchemy.engine.Engine COMMIT
INFO:     Application startup complete.
✅ Focus数据库初始化完成
✅ API服务启动完成
INFO:     127.0.0.1:63868 - "POST /auth/register HTTP/1.1" 200 OK
2025-10-25 00:52:52,171 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:52:52,171 INFO sqlalchemy.engine.Engine SELECT COALESCE(SUM(amount), 0) FROM points_transactions WHERE user_id = ?
2025-10-25 00:52:52,171 INFO sqlalchemy.engine.Engine [generated in 0.00005s] ('b9e7980b-5eeb-42de-9e61-3ca72e38e904',)
2025-10-25 00:52:52,171 INFO sqlalchemy.engine.Engine SELECT points_transactions.id, points_transactions.updated_at, points_transactions.user_id, points_transactions.amount, points_transactions.source_type, points_transactions.source_id, points_transactions.created_at 
FROM points_transactions 
WHERE points_transactions.user_id = ? ORDER BY points_transactions.created_at DESC
 LIMIT ? OFFSET ?
2025-10-25 00:52:52,171 INFO sqlalchemy.engine.Engine [generated in 0.00005s] ('b9e7980b-5eeb-42de-9e61-3ca72e38e904', 1000, 0)
INFO:     127.0.0.1:63870 - "GET /points/balance HTTP/1.1" 200 OK
2025-10-25 00:52:52,172 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:52:52,173 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:52:52,174 INFO sqlalchemy.engine.Engine INSERT INTO tasks (id, created_at, updated_at, user_id, title, description, parent_id, status, priority, is_deleted, completion_percentage, last_claimed_date, tags, service_ids, due_date, planned_start_time, planned_end_time) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-10-25 00:52:52,174 INFO sqlalchemy.engine.Engine [generated in 0.00009s] ('5ae416c1-b215-4105-8ec0-2214003bf630', '2025-10-24 16:52:52.173776', '2025-10-24 16:52:52.173776', 'b9e7980b-5eeb-42de-9e61-3ca72e38e904', '积分调试任务', '用于调试积分API', None, 'pending', 'high', 0, 0.0, None, '[]', '[]', None, None, None)
2025-10-25 00:52:52,175 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ?
2025-10-25 00:52:52,175 INFO sqlalchemy.engine.Engine [generated in 0.00003s] ('5ae416c1-b215-4105-8ec0-2214003bf630',)
2025-10-25 00:52:52,175 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:52:52,175 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:52:52,176 INFO sqlalchemy.engine.Engine SELECT tasks.id AS tasks_id, tasks.created_at AS tasks_created_at, tasks.updated_at AS tasks_updated_at, tasks.user_id AS tasks_user_id, tasks.title AS tasks_title, tasks.description AS tasks_description, tasks.parent_id AS tasks_parent_id, tasks.status AS tasks_status, tasks.priority AS tasks_priority, tasks.is_deleted AS tasks_is_deleted, tasks.completion_percentage AS tasks_completion_percentage, tasks.last_claimed_date AS tasks_last_claimed_date, tasks.tags AS tasks_tags, tasks.service_ids AS tasks_service_ids, tasks.due_date AS tasks_due_date, tasks.planned_start_time AS tasks_planned_start_time, tasks.planned_end_time AS tasks_planned_end_time 
FROM tasks 
WHERE tasks.id = ?
2025-10-25 00:52:52,176 INFO sqlalchemy.engine.Engine [generated in 0.00004s] ('5ae416c1-b215-4105-8ec0-2214003bf630',)
INFO:     127.0.0.1:63872 - "POST /tasks/ HTTP/1.1" 200 OK
2025-10-25 00:52:52,176 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:52:52,177 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:52:52,177 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:52:52,177 INFO sqlalchemy.engine.Engine [generated in 0.00003s] ('5ae416c1-b215-4105-8ec0-2214003bf630', 'b9e7980b-5eeb-42de-9e61-3ca72e38e904')
2025-10-25 00:52:52,178 INFO sqlalchemy.engine.Engine SELECT task_top3.id, task_top3.created_at, task_top3.updated_at, task_top3.user_id, task_top3.top_date, task_top3.task_ids, task_top3.points_consumed 
FROM task_top3 
WHERE task_top3.user_id = ? AND task_top3.top_date = ?
2025-10-25 00:52:52,178 INFO sqlalchemy.engine.Engine [generated in 0.00003s] ('b9e7980b-5eeb-42de-9e61-3ca72e38e904', '2025-10-25')
2025-10-25 00:52:52,178 INFO sqlalchemy.engine.Engine 
                        SELECT id, status, title, last_claimed_date
                        FROM tasks
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:52:52,178 INFO sqlalchemy.engine.Engine [generated in 0.00003s] ('5ae416c1-b215-4105-8ec0-2214003bf630', 'b9e7980b-5eeb-42de-9e61-3ca72e38e904')
🔍 DEBUG: Task 5ae416c1-b215-4105-8ec0-2214003bf630 - status: pending, last_claimed_date: None, today: 2025-10-25, type_check: <class 'NoneType'> == <class 'datetime.date'>
2025-10-25 00:52:52,178 INFO sqlalchemy.engine.Engine INSERT INTO points_transactions (id, updated_at, user_id, amount, source_type, source_id, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)
2025-10-25 00:52:52,178 INFO sqlalchemy.engine.Engine [generated in 0.00004s] ('6de142a0-6d8a-4676-9d45-17a3b6861428', '2025-10-24 16:52:52.178701', 'b9e7980b-5eeb-42de-9e61-3ca72e38e904', 2, 'task_complete', '5ae416c1-b215-4105-8ec0-2214003bf630', '2025-10-24 16:52:52.178659')
2025-10-25 00:52:52,179 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:52:52,179 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:52:52,179 INFO sqlalchemy.engine.Engine SELECT points_transactions.id AS points_transactions_id, points_transactions.updated_at AS points_transactions_updated_at, points_transactions.user_id AS points_transactions_user_id, points_transactions.amount AS points_transactions_amount, points_transactions.source_type AS points_transactions_source_type, points_transactions.source_id AS points_transactions_source_id, points_transactions.created_at AS points_transactions_created_at 
FROM points_transactions 
WHERE points_transactions.id = ?
2025-10-25 00:52:52,179 INFO sqlalchemy.engine.Engine [generated in 0.00003s] ('6de142a0-6d8a-4676-9d45-17a3b6861428',)
2025-10-25 00:52:52,179 INFO sqlalchemy.engine.Engine 
                        UPDATE tasks
                        SET status = 'completed',
                            last_claimed_date = ?,
                            updated_at = ?
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:52:52,179 INFO sqlalchemy.engine.Engine [generated in 0.00003s] (datetime.date(2025, 10, 25), datetime.datetime(2025, 10, 24, 16, 52, 52, 179725, tzinfo=datetime.timezone.utc), '5ae416c1-b215-4105-8ec0-2214003bf630', 'b9e7980b-5eeb-42de-9e61-3ca72e38e904')
2025-10-25 00:52:52,179 INFO sqlalchemy.engine.Engine 
                        SELECT parent_id FROM tasks
                        WHERE id = ? AND user_id = ?
                    
2025-10-25 00:52:52,179 INFO sqlalchemy.engine.Engine [generated in 0.00002s] ('5ae416c1-b215-4105-8ec0-2214003bf630', 'b9e7980b-5eeb-42de-9e61-3ca72e38e904')
2025-10-25 00:52:52,179 INFO sqlalchemy.engine.Engine COMMIT
2025-10-25 00:52:52,180 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:52:52,180 INFO sqlalchemy.engine.Engine SELECT tasks.id, tasks.created_at, tasks.updated_at, tasks.user_id, tasks.title, tasks.description, tasks.parent_id, tasks.status, tasks.priority, tasks.is_deleted, tasks.completion_percentage, tasks.last_claimed_date, tasks.tags, tasks.service_ids, tasks.due_date, tasks.planned_start_time, tasks.planned_end_time 
FROM tasks 
WHERE tasks.id = ? AND tasks.user_id = ? AND tasks.is_deleted = 0
2025-10-25 00:52:52,180 INFO sqlalchemy.engine.Engine [cached since 0.002433s ago] ('5ae416c1-b215-4105-8ec0-2214003bf630', 'b9e7980b-5eeb-42de-9e61-3ca72e38e904')
INFO:     127.0.0.1:63874 - "POST /tasks/5ae416c1-b215-4105-8ec0-2214003bf630/complete HTTP/1.1" 200 OK
2025-10-25 00:52:52,180 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:52:52,181 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:52:52,181 INFO sqlalchemy.engine.Engine SELECT COALESCE(SUM(amount), 0) FROM points_transactions WHERE user_id = ?
2025-10-25 00:52:52,181 INFO sqlalchemy.engine.Engine [cached since 0.01065s ago] ('b9e7980b-5eeb-42de-9e61-3ca72e38e904',)
2025-10-25 00:52:52,181 INFO sqlalchemy.engine.Engine SELECT points_transactions.id, points_transactions.updated_at, points_transactions.user_id, points_transactions.amount, points_transactions.source_type, points_transactions.source_id, points_transactions.created_at 
FROM points_transactions 
WHERE points_transactions.user_id = ? ORDER BY points_transactions.created_at DESC
 LIMIT ? OFFSET ?
2025-10-25 00:52:52,181 INFO sqlalchemy.engine.Engine [cached since 0.01011s ago] ('b9e7980b-5eeb-42de-9e61-3ca72e38e904', 1000, 0)
INFO:     127.0.0.1:63876 - "GET /points/balance HTTP/1.1" 200 OK
2025-10-25 00:52:52,182 INFO sqlalchemy.engine.Engine ROLLBACK
WARNING:  WatchFiles detected changes in 'src/domains/reward/router.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [38050]
INFO:     Started server process [38200]
INFO:     Waiting for application startup.
🚀 TaKeKe API v1.0.0 正在启动...
📝 环境: 开发
🌐 API服务地址: http://0.0.0.0:8001
✅ 简化认证数据库表创建成功（auth + auth_audit_logs）
✅ 认证数据库初始化完成
2025-10-25 00:53:08,794 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:53:08,794 INFO sqlalchemy.engine.Engine SELECT 1
2025-10-25 00:53:08,794 INFO sqlalchemy.engine.Engine [generated in 0.00007s] ()
2025-10-25 00:53:08,794 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:53:08,794 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:53:08,794 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth")
2025-10-25 00:53:08,794 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,794 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth_audit_logs")
2025-10-25 00:53:08,794 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("tasks")
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("points_transactions")
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("rewards")
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_recipes")
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_transactions")
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("task_top3")
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("focus_sessions")
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine COMMIT
✅ 任务数据库初始化完成
2025-10-25 00:53:08,795 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:53:08,798 INFO sqlalchemy.engine.Engine SELECT rewards.id, rewards.name, rewards.description, rewards.points_value, rewards.image_url, rewards.cost_type, rewards.cost_value, rewards.stock_quantity, rewards.category, rewards.is_active, rewards.created_at, rewards.updated_at 
FROM rewards 
WHERE rewards.name = ?
2025-10-25 00:53:08,798 INFO sqlalchemy.engine.Engine [generated in 0.00005s] ('小金币',)
2025-10-25 00:53:08,798 INFO sqlalchemy.engine.Engine SELECT rewards.id, rewards.name, rewards.description, rewards.points_value, rewards.image_url, rewards.cost_type, rewards.cost_value, rewards.stock_quantity, rewards.category, rewards.is_active, rewards.created_at, rewards.updated_at 
FROM rewards 
WHERE rewards.name = ?
2025-10-25 00:53:08,798 INFO sqlalchemy.engine.Engine [cached since 0.0003473s ago] ('钻石',)
2025-10-25 00:53:08,798 INFO sqlalchemy.engine.Engine SELECT reward_recipes.id, reward_recipes.name, reward_recipes.result_reward_id, reward_recipes.materials, reward_recipes.is_active, reward_recipes.created_at, reward_recipes.updated_at 
FROM reward_recipes 
WHERE reward_recipes.name = ?
2025-10-25 00:53:08,798 INFO sqlalchemy.engine.Engine [generated in 0.00004s] ('小金币合成钻石',)
2025-10-25 00:53:08,798 INFO sqlalchemy.engine.Engine COMMIT
✅ 奖励数据库初始化完成
✅ 聊天数据库初始化完成
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth")
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth_audit_logs")
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("tasks")
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("points_transactions")
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("rewards")
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_recipes")
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_transactions")
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("task_top3")
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("focus_sessions")
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:08,799 INFO sqlalchemy.engine.Engine COMMIT
INFO:     Application startup complete.
WARNING:  WatchFiles detected changes in 'src/domains/reward/router.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [38200]
INFO:     Started server process [38276]
INFO:     Waiting for application startup.
🚀 TaKeKe API v1.0.0 正在启动...
📝 环境: 开发
🌐 API服务地址: http://0.0.0.0:8001
✅ 简化认证数据库表创建成功（auth + auth_audit_logs）
✅ 认证数据库初始化完成
2025-10-25 00:53:19,092 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:53:19,092 INFO sqlalchemy.engine.Engine SELECT 1
2025-10-25 00:53:19,092 INFO sqlalchemy.engine.Engine [generated in 0.00007s] ()
2025-10-25 00:53:19,092 INFO sqlalchemy.engine.Engine ROLLBACK
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth")
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth_audit_logs")
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("tasks")
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("points_transactions")
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("rewards")
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_recipes")
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_transactions")
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("task_top3")
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("focus_sessions")
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine COMMIT
✅ 任务数据库初始化完成
2025-10-25 00:53:19,093 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:53:19,096 INFO sqlalchemy.engine.Engine SELECT rewards.id, rewards.name, rewards.description, rewards.points_value, rewards.image_url, rewards.cost_type, rewards.cost_value, rewards.stock_quantity, rewards.category, rewards.is_active, rewards.created_at, rewards.updated_at 
FROM rewards 
WHERE rewards.name = ?
2025-10-25 00:53:19,096 INFO sqlalchemy.engine.Engine [generated in 0.00004s] ('小金币',)
2025-10-25 00:53:19,096 INFO sqlalchemy.engine.Engine SELECT rewards.id, rewards.name, rewards.description, rewards.points_value, rewards.image_url, rewards.cost_type, rewards.cost_value, rewards.stock_quantity, rewards.category, rewards.is_active, rewards.created_at, rewards.updated_at 
FROM rewards 
WHERE rewards.name = ?
2025-10-25 00:53:19,096 INFO sqlalchemy.engine.Engine [cached since 0.0003406s ago] ('钻石',)
2025-10-25 00:53:19,096 INFO sqlalchemy.engine.Engine SELECT reward_recipes.id, reward_recipes.name, reward_recipes.result_reward_id, reward_recipes.materials, reward_recipes.is_active, reward_recipes.created_at, reward_recipes.updated_at 
FROM reward_recipes 
WHERE reward_recipes.name = ?
2025-10-25 00:53:19,096 INFO sqlalchemy.engine.Engine [generated in 0.00004s] ('小金币合成钻石',)
2025-10-25 00:53:19,096 INFO sqlalchemy.engine.Engine COMMIT
✅ 奖励数据库初始化完成
✅ 聊天数据库初始化完成
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth")
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("auth_audit_logs")
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("tasks")
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("points_transactions")
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("rewards")
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_recipes")
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("reward_transactions")
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("task_top3")
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("focus_sessions")
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-10-25 00:53:19,097 INFO sqlalchemy.engine.Engine COMMIT
INFO:     Application startup complete.
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [38276]
INFO:     Stopping reloader process [37605]
